<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stata Service — 智能化数据分析平台</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=JetBrains+Mono:wght@400;500&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="assets/desktop_pro_theme.css">
    <link rel="stylesheet" href="assets/desktop_pro_layout.css">
    <link rel="stylesheet" href="assets/desktop_pro_components.css">
    <link rel="stylesheet" href="assets/desktop_pro_step3.css">
</head>

<body>
    <div class="app-container">
        <header>
            <div class="brand">
                <div class="brand-icon">S</div>
                Stata Service
            </div>
            <div class="tabs-container">
                <div class="tabs">
                    <button class="tab active" data-tab="submit">分析任务</button>
                    <button class="tab" data-tab="query">执行查询</button>
                </div>
            </div>
            <div class="header-actions">
                <button class="theme-toggle" id="theme-toggle" title="切换主题">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" />
                    </svg>
                </button>
            </div>
        </header>

        <main>
            <!-- View: Submit -->
            <div id="view-submit" class="view-fade">
                <div class="stepper">
                    <div class="step-tick active"></div>
                    <div class="step-tick"></div>
                    <div class="step-tick"></div>
                </div>

                <h1>开启智能化分析</h1>
                <p class="lead">Stata 18 MP 分析引擎将自动为您构建全量实证模型并生成可执行脚本。完成以下必要信息即可开始。</p>

                <div class="control-group">
                    <span class="section-label required">任务验证码</span>
                    <input type="text" id="taskCode" placeholder="输入 Task Code" class="mono">
                </div>

                <div class="control-group">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <span class="section-label required" style="margin: 0;">研究设想与需求</span>
                        <div style="display: flex; gap: 8px;">
                            <span class="tpl-tag" onclick="applyTpl('ols')">面板回归</span>
                            <span class="tpl-tag" onclick="applyTpl('diff')">DID 模型</span>
                        </div>
                    </div>
                    <textarea id="description" placeholder="例如：分析 ESG 表现对企业价值的影响，需要控制个体与时间效应..."></textarea>
                </div>

                <div class="control-group">
                    <span class="section-label required">原始数据</span>
                    <div class="drop-zone" id="dropzone">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="var(--text-muted)"
                            stroke-width="2" style="margin-bottom: 12px;">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                            <polyline points="17 8 12 3 7 8" />
                            <line x1="12" y1="3" x2="12" y2="15" />
                        </svg>
                        <div style="font-weight: 500; margin-bottom: 4px;">拖拽 CSV/XLSX 文件进行实时解析</div>
                        <div style="color: var(--text-muted); font-size: 11px;">支持多种编码格式，文件上限 100MB</div>
                    </div>
                    <input type="file" id="fileInput" hidden multiple>
                    <div id="fileList" style="margin-top: 16px; display: grid; gap: 8px;"></div>
                </div>

                <div style="display: flex; justify-content: flex-end; gap: 12px; margin-top: 48px;">
                    <button class="btn btn-primary" id="btn-next">继续 <span class="shortcut">⌘ ↵</span></button>
                </div>
            </div>

            <!-- Other views (simplified structure for quick delivery) -->
            <div id="view-sheets" class="view-fade hidden">
                <div class="stepper">
                    <div class="step-tick done"></div>
                    <div class="step-tick active"></div>
                    <div class="step-tick"></div>
                </div>
                <h1>选择数据源</h1>
                <p class="lead">检测到 Excel 工作簿中包含多个工作表，请确认用于实证分析的主表。</p>
                <div class="panel" id="sheet-options"></div>
                <div style="display: flex; justify-content: space-between;"><button class="btn btn-secondary"
                        onclick="showView('submit')">上一步</button><button class="btn btn-primary"
                        onclick="showView('blueprint')">确认并解析变量</button></div>
            </div>

            <div id="view-blueprint" class="view-fade hidden">
                <div class="stepper">
                    <div class="step-tick done"></div>
                    <div class="step-tick done"></div>
                    <div class="step-tick active"></div>
                </div>
                <h1>分析蓝图预检</h1>
                <p class="lead">请在确认前完成变量纠偏与待确认事项，确保蓝图与数据口径一致。</p>

                <div class="panel hidden" id="blueprint-locked-banner">
                    <div class="panel-body">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 12px;">
                            <div>
                                <div style="font-weight: 600; margin-bottom: 6px;">需求已确认，任务已加入执行队列</div>
                                <div class="inline-hint" id="blueprint-locked-subtitle"></div>
                            </div>
                            <span class="badge success">LOCKED</span>
                        </div>
                    </div>
                </div>
                <div class="panel" id="blueprint-header">
                    <div class="panel-body">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 12px;">
                            <div>
                                <span class="section-label" style="margin: 0;">Draft Preview</span>
                                <div class="mono" id="blueprint-job-line"
                                    style="margin-top: 8px; color: var(--text-muted);"></div>
                            </div>
                            <span class="badge" id="blueprint-decision-badge">—</span>
                        </div>
                        <div class="inline-hint" id="blueprint-status-line" style="margin-top: 10px;"></div>
                    </div>
                </div>
                <div class="panel" id="blueprint-preview-state">
                    <div class="panel-body">
                        <div id="blueprint-preview-state-text" style="color: var(--text-dim);"></div>
                        <div id="blueprint-preview-state-actions"
                            style="margin-top: 12px; display: flex; gap: 12px;"></div>
                    </div>
                </div>
                <div class="hidden" id="blueprint-preview-content">
                    <div class="panel">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>类型</th>
                                    <th>变量名</th>
                                    <th>逻辑说明</th>
                                </tr>
                            </thead>
                            <tbody class="mono" id="blueprint-vars-body"></tbody>
                        </table>
                    </div>
                    <details class="panel details-panel hidden" id="panel-warnings">
                        <summary>
                            <div class="panel-summary-row">
                                <span class="section-label" style="margin: 0;">数据质量预警</span>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <span id="warnings-count" class="mono"
                                        style="color: var(--text-muted); font-size: 12px;"></span>
                                    <span class="details-caret">›</span>
                                </div>
                            </div>
                        </summary>
                        <div class="panel-body" id="warnings-body"></div>
                    </details>
                    <details class="panel details-panel" id="panel-var-mapping">
                        <summary>
                            <div class="panel-summary-row">
                                <span class="section-label" style="margin: 0;">修正变量映射</span>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <span id="corrections-count" class="mono"
                                        style="color: var(--text-muted); font-size: 12px;"></span>
                                    <span class="details-caret">›</span>
                                </div>
                            </div>
                        </summary>
                        <div class="panel-body">
                            <div
                                style="display: flex; justify-content: space-between; align-items: center; gap: 12px; margin-bottom: 12px;">
                                <div class="inline-hint">纠偏仅影响显示与确认请求，不会直接改写草案字段。</div>
                                <button class="btn btn-secondary hidden" id="btn-clear-corrections"
                                    style="height: 30px;">清除修正</button>
                            </div>
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>类型</th>
                                        <th>识别结果</th>
                                        <th>纠偏为</th>
                                    </tr>
                                </thead>
                                <tbody class="mono" id="var-mapping-rows"></tbody>
                            </table>
                        </div>
                    </details>
                    <div class="panel" id="panel-clarifications">
                        <div class="panel-body">
                            <div style="display: flex; justify-content: space-between; align-items: center; gap: 12px;">
                                <span class="section-label" style="margin: 0;">待确认事项</span>
                                <span id="clarification-summary" class="mono"
                                    style="color: var(--text-muted); font-size: 12px;"></span>
                            </div>
                            <div id="stage1-questions" style="margin-top: 16px;"></div>
                            <div id="open-unknowns" style="margin-top: 18px;"></div>
                            <div class="inline-error hidden" id="clarification-error"></div>
                            <div style="display: flex; justify-content: flex-end; gap: 12px; margin-top: 16px;">
                                <button class="btn btn-secondary" id="btn-apply-clarifications">应用澄清并刷新预览</button>
                            </div>
                        </div>
                    </div>
                    <div style="display: flex; justify-content: space-between; gap: 12px;">
                        <button class="btn btn-secondary" id="btn-back-to-sheets">重新配置</button>
                        <button class="btn btn-primary" id="btn-confirm">确认并启动</button>
                    </div>
                    <div class="inline-hint" id="confirm-hint" style="margin-top: 10px;"></div>
                </div>
            </div>
            <div id="view-success" class="view-fade hidden">
                <div style="text-align: center; padding: 40px 0;">
                    <div
                        style="width: 48px; height: 48px; background: rgba(16, 185, 129, 0.1); border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; margin-bottom: 24px;">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="var(--success)"
                            stroke-width="2.5">
                            <polyline points="20 6 9 17 4 12" />
                        </svg>
                    </div>
                    <h1>任务已进入分析队列</h1>
                    <p class="lead">Stata 集群已接收您的指令。预计将在 5-15 分钟内完成解析。</p>
                    <div class="panel" style="max-width: 320px; margin: 0 auto 32px; padding: 16px; text-align: left;">
                        <span class="section-label">Job Assignment ID</span>
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span class="mono" style="color:var(--accent); font-weight: 500;"
                                id="job-id-display">jb_72k9s1</span>
                            <button class="btn btn-secondary" style="height: 24px; padding: 0 8px; font-size: 10px;"
                                onclick="copyId()">Copy</button>
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="location.reload()">新建分析任务</button>
                </div>
            </div>

            <div id="view-query" class="view-fade hidden">
                <h1>任务状态回溯</h1>
                <p class="lead">输入您的 Job ID 或 Task Code，实时监控分析进程或下载产出文件。</p>
                <div style="display: flex; gap: 12px; margin-bottom: 40px;">
                    <input type="text" id="queryId" placeholder="Job ID / Task Code" class="mono" style="flex: 1;">
                    <button class="btn btn-primary" onclick="handleQuery()">执行检索</button>
                </div>
                <div id="query-result" class="hidden">
                    <div class="panel" style="padding: 24px;">
                        <span class="section-label">Status Update</span>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
                            <h3>Job Analysis (Executing)</h3><span
                                style="color:var(--accent); font-weight: 600;">75%</span>
                        </div>
                        <div style="height: 2px; background: var(--border); border-radius: 1px; margin-bottom: 32px;">
                            <div style="height: 100%; width: 75%; background: var(--accent);"></div>
                        </div>
                        <span class="section-label">Output Artifacts</span>
                        <div id="artifact-list" style="margin-top: 12px; display: grid; gap: 8px;"></div>
                    </div>
                </div>
            </div>
        </main>

        <footer>
            <div>&copy; 2026 SS Platform. All rights reserved.</div>
            <div style="display: flex; gap: 24px;"><span style="opacity: 0.5;">Stata 18 MP Edition</span><span
                    style="opacity: 0.5;">System Online</span></div>
        </footer>
    </div>

    <div class="modal-backdrop hidden" id="downgrade-modal" role="dialog" aria-modal="true">
        <div class="panel modal">
            <div class="panel-body">
                <span class="section-label" style="margin: 0;">风险确认</span>
                <div style="font-weight: 600; margin-top: 10px;">该任务存在降级风险</div>
                <div class="inline-hint" style="margin-top: 8px;">确认继续将以降级方案执行。是否仍要确认？</div>
                <div style="display: flex; justify-content: flex-end; gap: 12px; margin-top: 16px;">
                    <button class="btn btn-secondary" id="btn-modal-cancel">取消</button>
                    <button class="btn btn-primary" id="btn-modal-confirm">仍然确认</button>
                </div>
            </div>
        </div>
    </div>

    <script src="assets/desktop_pro_core.js"></script>
    <script src="assets/desktop_pro_api.js"></script>
    <script src="assets/desktop_pro_blueprint_model.js"></script>
    <script src="assets/desktop_pro_blueprint_render.js"></script>
    <script src="assets/desktop_pro_blueprint_flow.js"></script>
</body>
</html>
