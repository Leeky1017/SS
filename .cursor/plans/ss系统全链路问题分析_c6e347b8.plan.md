---
name: SS系统全链路问题分析
overview: 全面分析 SS 系统从前端到后端的全链路问题，涵盖用户体验、系统可靠性、架构设计、测试覆盖、规范遵循以及核心"需求处理能力"等多个维度，识别出 150+ 个具体问题并按优先级分类。
todos:
  - id: add-truncation-detection
    content: 添加 LLM 响应截断检测（检查 finish_reason）
    status: pending
  - id: fix-429-handling
    content: 区分 429 错误处理，实现指数退避
    status: pending
  - id: expand-template-support
    content: 扩展模板支持范围（当前仅6个，库中有319个）
    status: pending
  - id: fix-draft-truncation
    content: 修复 Draft 文本截断问题（800字符限制）
    status: pending
  - id: add-data-statistics
    content: 添加数据统计信息给 LLM（类型、缺失值、分布等）
    status: pending
  - id: impl-upload-progress
    content: 实现上传进度条（FE-026）
    status: pending
  - id: add-draft-timeout
    content: 添加 Draft 预览超时上限（FE-030）
    status: pending
  - id: add-cancel-mechanism
    content: 添加运行中任务取消机制
    status: pending
  - id: fix-version-conflict
    content: 修复 ensure_job_claimable 版本冲突处理
    status: pending
  - id: add-lease-renewal
    content: 实现 Lease 续期机制
    status: pending
  - id: add-stuck-detection
    content: 添加卡住的 RUNNING 状态自动检测和恢复
    status: pending
  - id: impl-rate-limiting
    content: 实现 LLM 调用速率限制
    status: pending
  - id: fix-template-params
    content: 修复模板参数填充逻辑（支持 FE、交互项、IV 等）
    status: pending
  - id: add-variable-validation
    content: 添加变量存在性和类型验证
    status: pending
  - id: enable-composition-products-bindings
    content: 支持 LLM plan steps 声明 products/input_bindings（含 prod refs），并白名单透传必要 step params（如 timeout_seconds）
    status: pending
  - id: align-plan-generation-prompt
    content: 对齐 plan_generation prompt（required_outputs、allowed step types）与执行引擎，减少无意义 fallback
    status: pending
  - id: secure-frontend-storage
    content: 重做前端 token 与数据快照存储（FE-032/FE-060：TTL、退出即清、最小化落地）
    status: pending
  - id: auth-fail-closed
    content: v1 Bearer 鉴权改为 fail-closed（至少生产环境），并补 E2E 防回归
    status: pending
  - id: redact-api-logs
    content: API 错误日志统一脱敏（复用 redact_text），避免 error_message 泄露
    status: pending
  - id: jobs-retention-gc
    content: 引入 jobs/artifacts retention & GC 清理策略（配置+运维文档+最小实现）
    status: pending
isProject: false
---

# SS 系统全链路问题深度分析

## 一、核心诊断：系统"什么都有但体验很差"的根本原因

系统已具备完整功能链路，但存在以下**两类结构性问题**：

### A. 技术层面问题

1. **进度/反馈机制缺失**：用户在等待时不知道系统在做什么
2. **错误恢复路径模糊**：出错后用户不知道如何修复
3. **取消/中断能力缺失**：误操作无法撤回
4. **并发/状态一致性风险**：可能导致任务卡住或重复执行
5. **LLM 调用可靠性不足**：截断、超时、重试机制不完善

### B. 核心能力问题（处理用户需求的能力）

6. **模板支持范围过窄**：319 个模板中仅启用 6 个
7. **数据理解信息不足**：LLM 缺少变量类型、分布、缺失值等关键信息
8. **需求到代码的信息丢失**：多阶段转换中丢失研究设计意图
9. **变量识别完全依赖 LLM**：无数据驱动验证，易误判
10. **用户无法纠正高级结构**：固定效应、交互项、工具变量等字段无法修改

---

## 二、核心能力问题：处理用户需求的能力（35 个问题）

这是系统最根本的问题——即使技术层面完美，如果无法正确理解和处理用户的研究需求，系统也是无用的。

### 2.1 模板选择与支持范围问题（P0-BLOCKER）

| ID | 问题 | 位置 | 影响 |

|----|------|------|------|

| CORE-01 | **仅支持 6 个模板** | `do_template_selection_service.py:49` | 库中 319 个模板，但 `_V1_SUPPORTED_TEMPLATE_IDS = {"T01", "T05", "T07", "T09", "T30", "TA14"}` 硬编码，大量分析方法无法使用 |

| CORE-02 | LLM 多步骤无法真正组合（step.params 被硬编码） | `plan_service_llm_builder.py:138-166` | 虽可采纳 LLM 的 `template_id`，但 `input_bindings` 固定为 `primary_dataset`、`products` 固定为空且不透传其他 params（timeout/产物/输入依赖），无法表达“步骤产物→下游步骤”的真实 pipeline |

| CORE-03 | 模板参数填充过于简单 | `do_template_plan_support.py:60-111` | 仅支持基础变量拼接，不支持交互项、固定效应、工具变量等高级结构 |

### 2.2 用户需求理解问题（P0-BLOCKER）

| ID | 问题 | 位置 | 影响 |

|----|------|------|------|

| CORE-04 | **Draft 文本截断到 800 字符** | `plan_generation_llm.py:93` | `_truncate(draft_text, max_chars=800)` 导致复杂需求信息丢失 |

| CORE-05 | Draft 结构化字段未充分利用 | `plan_service_llm_support.py:59-77` | Draft v2 包含 `fixed_effects`、`interaction_terms`、`instrument_var` 等丰富信息，但在 Plan 生成时仅提取 `detected_vars` |

| CORE-06 | Requirement 未做结构化解析 | `plan_generation_llm.py:94` | 仅做 `strip()`，未提取研究设计关键词（DID、IV、PSM、RDD）或多步骤需求 |

| CORE-07 | 用户无法修改高级结构字段 | `draft_service.py:94-137` | `patch_v1` 不支持修改 `fixed_effects`、`interaction_terms`、`cluster_var`、`instrument_var` 等 |

### 2.3 数据理解问题（P1-HIGH）

| ID | 问题 | 位置 | 影响 |

|----|------|------|------|

| CORE-08 | **列候选限制为 50 个** | `draft_preview_llm.py:13` | `_DRAFT_PREVIEW_COLUMNS_LIMIT = 50`，大宽表会丢失列信息 |

| CORE-09 | Data Schema 信息不足 | `plan_service_llm_support.py:78-83` | 仅包含 `columns`（列名）、`n_rows`（行数）、`has_panel_structure`，缺少列类型、缺失值、分布等统计 |

| CORE-10 | 类型推断过于简单 | `dataset_preview.py:250-270` | 仅 6 种类型，未区分分类/连续变量，未识别有序分类 |

| CORE-11 | 缺失值统计完全缺失 | 整个数据处理流程 | 无缺失值比例、无缺失值模式分析 |

| CORE-12 | ID/时间变量识别无数据验证 | `draft_preview_llm.py` | 完全依赖 LLM 推断，未基于唯一值比例、时间格式等特征检测 |

| CORE-13 | Panel 结构检测仅检查字段存在 | `plan_service_llm_support.py:57-82` | 未验证数据是否真正符合 panel 特征 |

### 2.4 信息传递链路问题（P1-HIGH）

```
Requirement → Draft Preview → Plan Generation → Do File Generation
    ↓              ↓              ↓                   ↓
 仅strip()    仅提取变量名    Draft被截断800字符    参数简单拼接
 未解析设计    丢失设计意图    结构字段未利用       丢失复杂结构
```

| ID | 问题 | 位置 | 影响 |

|----|------|------|------|

| CORE-14 | 多阶段信息衰减 | 整个链路 | 从 Requirement 到最终代码，研究设计意图逐步丢失 |

| CORE-15 | 缺少反馈确认机制 | 整个流程 | 用户无法确认 LLM 理解是否正确，错误累积到最终代码 |

| CORE-16 | 缺少变量验证机制 | `plan_service_llm_support.py` | 未验证变量名是否存在、类型是否匹配、是否满足分析前提 |

| CORE-26 | Plan 生成未使用 required_outputs 约束 | `plan_generation_llm.py:93-126` | `constraints.required_outputs` 未进入 prompt，LLM 无法被引导生成“能产出表/图/报告”的计划 |

| CORE-27 | Plan 生成允许的 step.type 与执行引擎不一致 | `plan_generation_llm.py:98-126` + `plan_service_llm_builder.py:132-137` | prompt 允许 `RUN_STATA` 等类型，但执行端只支持 do-generation 类型，容易频繁触发 fallback，导致计划质量不稳定 |

### 2.5 Stata 代码执行问题（P1-HIGH）

| ID | 问题 | 位置 | 影响 |

|----|------|------|------|

| CORE-17 | 错误检测仅依赖最后一个 `r(code)` | `stata_run_exec.py:34-43` | do-file 中途失败但后续有 `r(0)` 时可能漏报 |

| CORE-18 | 非零退出码错误信息过于简单 | `stata_run_exec.py:79` | 仅报告退出码，未从 log 提取具体错误信息 |

| CORE-19 | 未解析 `SS_RC` 结构化错误标记 | 整个代码库 | 模板使用 `SS_RC|code=...|msg=...|severity=...`，但系统未解析 |

| CORE-20 | 错误诊断缺少上下文 | `stata_run_artifacts.py:108-117` | 错误 JSON 缺少相关命令、变量、行号等 |

### 2.6 模板库质量问题（P2-MEDIUM）

| ID | 问题 | 影响 |

|----|------|------|

| CORE-21 | 319 个模板仅静态 lint 通过 | 未在 Stata 18 上运行验证 |

| CORE-22 | 58 个模板依赖 SSC 包 | 缺少统一安装机制，运行时可能失败 |

| CORE-23 | 元数据格式漂移 | `outputs[].type = "figure"` 应为 `graph`（35 处） |

| CORE-24 | 锚点格式不统一 | 319 个模板使用旧格式 `SS_TASK_VERSION:<ver>` |

| CORE-25 | 缺少 PPML、DML、小样本推断等新方法 | 高级因果推断需求无法满足 |

### 2.7 核心能力问题总结

**系统在"理解用户需求并生成正确代码"这一核心能力上存在严重缺陷**：

1. **模板支持范围**：319 个模板仅启用 6 个（1.9%），绝大多数分析方法不可用
2. **信息传递**：从用户需求到最终代码，经过 4 个阶段的信息衰减，研究设计意图大量丢失
3. **数据理解**：给 LLM 的数据上下文严重不足（无类型、无统计、无缺失值）
4. **变量识别**：完全依赖 LLM，无数据驱动验证
5. **用户纠错**：无法修改高级结构字段，LLM 错误无法纠正

---

## 三、前端问题清单（34 个问题）

### P0-BLOCKER（阻断性）

| ID | 问题 | 位置 | 影响 |

|----|------|------|------|

| FE-P0-1 | 上传无进度条 | `Step2UploadPanel.tsx:158` | 大文件上传时用户无法感知进度 |

| FE-P0-2 | Draft 预览 202 pending 无超时上限 | `Step3.tsx:112-114` | 用户可能无限等待 |

| FE-P0-3 | 运行中任务无法取消 | `Status.tsx` | 误启动的任务无法停止 |

### P1-HIGH（高影响）

| ID | 问题 | 位置 | 影响 |

|----|------|------|------|

| FE-P1-1 | 全局加载状态延迟 300ms | `App.tsx:18-32` | 快速请求不显示加载，用户可能重复点击 |

| FE-P1-2 | 错误信息缺少上下文 | `ErrorPanel.tsx:34-98` | 用户难以理解错误原因 |

| FE-P1-3 | 确认操作无法撤销 | `Step3.tsx:163` | 误确认无法回退 |

| FE-P1-4 | 下载大文件无进度条 | `Status.tsx:148-167` | 大文件下载时无反馈 |

| FE-P1-5 | 响应式设计不完善 | `layout.css:115-127` | 移动设备体验差 |

| FE-P1-6 | 缺少键盘导航支持 | 多处组件 | 键盘用户难以使用 |

| FE-P1-7 | 网络错误无自动重试 | `client.ts:233-247` | 临时网络问题需手动重试 |

| FE-P1-8 | 按钮禁用状态视觉反馈不足 | `ux-wave2.css:186-199` | 用户不清楚为什么不能点击 |

| FE-P1-9 | 表格数据截断无提示 | `Step2Panels.tsx:4-8` | 用户可能不知道数据被截断 |

| FE-P1-10 | 执行进度不明确 | `Status.tsx:50-57` | 仅"执行中"文本，无阶段信息 |

| FE-P1-11 | API 调用无超时设置 | `client.ts` | 网络慢时可能长时间无响应 |

| FE-P1-12 | 表单验证反馈不及时 | `Step1.tsx:40-53` | 提交时才验证 |

| FE-P1-13 | localStorage 持久化 token 与数据快照（隐私/安全风险） | `frontend/src/state/storage.ts:50-113` | token + inputs_preview/draft_preview 等快照长期留存，XSS/共享设备/插件风险放大 |

### P2-MEDIUM（中等影响）

- 缺少 ARIA 标签（多处）
- 错误面板未使用 `role="alert"`
- localStorage 快照缺少 TTL/退出即清（数据残留/隐私风险）
- 自动刷新无状态提示
- 文件下载缺少成功反馈
- 页面跳转缺少过渡动画
- 时间显示格式不统一
- 上传中无法取消
- 拖拽区域反馈不明显
- 大文件预览可能阻塞 UI

---

## 四、后端问题清单（25 个问题）

### P0-BLOCKER

| ID | 问题 | 位置 | 影响 |

|----|------|------|------|

| BE-P0-1 | 未检测 LLM 响应截断 | `openai_compatible_llm_client.py:38-40` | 无法识别因 max_tokens 导致的截断 |

| BE-P0-2 | 429 错误处理不当 | `llm_call_retry.py:205-217` | 可能加剧限流 |

### P1-HIGH

| ID | 问题 | 位置 | 影响 |

|----|------|------|------|

| BE-P1-1 | 文件上传同步读取 | `jobs.py:83` | 大文件阻塞事件循环 |

| BE-P1-2 | 下载接口同步读取 | `jobs.py:132` | 大文件可能导致内存溢出 |

| BE-P1-3 | subprocess 资源清理不完整 | `stata_run_exec.py:56-102` | 僵尸进程累积 |

| BE-P1-4 | 状态机转换并发控制不完整 | `job_service.py:151-179` | 高并发下状态转换可能失败 |

| BE-P1-5 | 队列操作竞态条件 | `file_worker_queue.py:222-287` | 任务可能被重复处理或丢失 |

| BE-P1-6 | 错误响应可能泄露内部信息 | `main.py:198-203` | 安全风险 |

| BE-P1-7 | max_tokens 硬编码 1024 | `llm_client_factory.py:33` | 长响应被截断 |

| BE-P1-8 | 未实现速率限制 | 整个 LLM 调用流程 | 可能触发 API 限流 |

| BE-P1-9 | Token 估算不准确 | `llm_tracing_support.py:32-36` | 中文内容预算计算偏差 |

| BE-P1-10 | 文件锁可能死锁 | `job_store.py:216-218` | 多线程/进程下可能死锁 |

| BE-P1-11 | v1 Bearer 鉴权 fail-open 风险 | `api/v1_auth.py:19-42` | 若 `job.auth_token` 缺失会直接放行，可能导致“意外无鉴权” |

| BE-P1-12 | API 错误日志未统一脱敏 | `main.py:178-204` | 响应 message 有部分 scrub，但日志仍会记录 `error_message` 原文，可能泄露路径/敏感信息 |

| BE-P1-13 | jobs/artifacts 缺少 retention/GC 清理机制 | 未发现对应实现 | 长期运行磁盘只增不减；token 过期但数据仍长期留存 |

### P2-MEDIUM

- 缺少请求超时控制
- `@lru_cache` 依赖注入配置不可热更新
- 日志级别使用不当（409 冲突）
- 缺少关键操作性能指标
- 配置加载缺少验证
- 开发环境默认密码不安全
- 锁释放失败仅记录警告
- 错误信息对用户不友好

---

## 五、状态机与工作流问题（14 个问题）

### P0-BLOCKER

| ID | 问题 | 位置 | 影响 |

|----|------|------|------|

| SM-P0-1 | `ensure_job_claimable` 未处理版本冲突 | `worker_claim_handling.py:67-93` | 并发 claim 时状态不一致 |

| SM-P0-2 | Lease TTL 60s 无续期机制 | `config.py:116` | 长任务可能被多 worker 并发执行 |

| SM-P0-3 | 缺少卡住的 RUNNING 状态检测 | 无专门机制 | 任务可能永久卡住 |

### P1-HIGH

| ID | 问题 | 位置 | 影响 |

|----|------|------|------|

| SM-P1-1 | Worker 崩溃后状态恢复不足 | `worker_service.py:193-286` | 可能重复执行或跳过清理 |

| SM-P1-2 | 状态转换和保存非原子 | `worker_claim_handling.py:78-85` | 部分成功导致状态不一致 |

| SM-P1-3 | Worker 关闭时 job 状态不回退 | `worker_service.py:307-312` | Worker 关闭后 job 卡在 RUNNING |

| SM-P1-4 | `trigger_run` 重试逻辑不完整 | `job_service.py:151-179` | 非版本冲突异常不重试 |

| SM-P1-5 | Claim 过期检测的竞态条件 | `file_worker_queue.py:188-220` | 两个 worker 可能同时处理同一 job |

| SM-P1-6 | 状态持久化失败后无回滚 | `worker_run_attempts.py:33` | 内存状态与持久化状态不一致 |

| SM-P1-7 | 重试时状态保持 RUNNING | `worker_service.py:201-286` | 无法区分执行中与等待重试 |

---

## 六、LLM 集成问题（12 个问题）

### P0-BLOCKER

- 未检测响应截断状态
- 429 错误处理不当

### P1-HIGH

- max_tokens 硬编码 1024
- 重试策略未区分错误类型（Timeout vs 429 vs 500）
- 未实现速率限制
- 缺少输入 token 计数验证

### P2-MEDIUM

- Token 估算不准确（中文 `len/4` 不适用）
- 字符级截断而非 Token 级截断
- 缺少流式响应支持
- 缺少配额管理
- 缺少 LLM 调用质量指标

---

## 七、测试与规范差距（9 个问题）

### 测试覆盖缺口

- 压力测试场景 3（资源耗尽与混沌联动）未实现
- 监控验证层缺失（`tests/monitoring/`）
- 部分 API 路由幂等性未明确测试

### 规范遵循差距

- 事件码使用不一致（字符串 vs 常量）
- 未处理异常可能泄露堆栈（`main.py:237`）
- 覆盖率目标未区分 Unit/Integration/User Journey

---

## 八、端到端用户体验问题汇总

```
┌─────────────────────────────────────────────────────────────────────────┐
│ Step1 填写需求 → Step2 上传文件 → 预览 → Step3 生成Draft → 确认执行 → 下载 │
│      ↓              ↓          ↓        ↓            ↓         ↓      │
│  无加载状态      无进度条    无阶段   无超时上限    无法取消   无进度    │
│  错误无指引      无法取消    无预估   无法撤销     无阶段信息  无成功提示 │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 九、已识别但未实现的 UX 修复任务

系统已在 `openspec/specs/ss-ux-remediation/` 定义了 **74 个任务卡**（FE-001~FE-064 + BE-001~BE-009 + E2E-001），按 6 个 Wave 分批规划：

- **Wave 1（P0-BLOCKER）**：BE-005~BE-009, FE-043 —— 功能解锁
- **Wave 2（P1-HIGH）**：CSS/布局/交互/状态 —— 核心 UX
- **Wave 3**：异常处理（重试/超时/冲突等）
- **Wave 4**：上传下载（分块/打包/进度条）
- **Wave 5（P2）**：可访问性 & i18n
- **Wave 6（P2/P3）**：打磨收尾

**关键洞察**：大部分问题已被识别和规划，但尚未实现。系统"什么都有但体验很差"的本质是 **Wave 1-4 的核心 UX 改进未落地**。

---

## 十、改进优先级建议

### P0：立即修复（核心能力阻断性问题）

| 优先级 | 问题 | 位置 | 预计工作量 |

|--------|------|------|-----------|

| 1 | **扩展模板支持范围** | `do_template_selection_service.py:49` | 2-3 天 |

| 2 | **修复 Draft 文本截断** | `plan_generation_llm.py:93` | 1 天 |

| 3 | **充分利用 Draft 结构化字段** | `plan_service_llm_support.py` | 2 天 |

| 4 | 对齐 plan_generation prompt 与执行引擎（required_outputs、allowed step types） | `plan_generation_llm.py` | 0.5-1 天 |

| 5 | 响应截断检测 | `openai_compatible_llm_client.py` | 0.5 天 |

| 6 | 429 错误区分处理 | `llm_call_retry.py` | 0.5 天 |

### P1：短期改进（1-2 周）

| 优先级 | 问题 | 影响 |

|--------|------|------|

| 7 | 增加数据统计信息给 LLM | 提升变量识别准确性 |

| 8 | 支持用户修改高级结构字段 | 用户可纠正 LLM 错误 |

| 9 | 扩展列候选限制（50 → 200+） | 支持大宽表 |

| 10 | 上传进度条（FE-026） | 用户体验 |

| 11 | Draft 预览超时上限（FE-030） | 防止无限等待 |

| 12 | 任务取消机制 | 误操作可撤回 |

### P2：中期改进（1 个月）

| 优先级 | 问题 | 影响 |

|--------|------|------|

| 13 | 模板参数填充逻辑重构 | 支持 FE、交互项、IV 等高级分析 |

| 14 | 数据驱动的变量识别和验证 | 减少 LLM 误判 |

| 15 | Wave 1-2 全部任务卡落地 | UX 基础改进 |

| 16 | `ensure_job_claimable` 版本冲突处理 | 并发可靠性 |

| 17 | Lease 续期机制 | 长任务支持 |

| 18 | 卡住的 RUNNING 状态自动检测和恢复 | 系统可靠性 |

### P3：长期优化（持续）

| 优先级 | 问题 | 影响 |

|--------|------|------|

| 19 | 模板运行时验证（Phase 4） | 确保模板可用 |

| 20 | 新方法模板补充（PPML、DML 等） | 覆盖高级需求 |

| 21 | 反馈确认机制 | 用户可迭代优化 |

| 22 | Wave 3-6 任务卡落地 | UX 打磨 |

| 23 | 可访问性合规 | 合规要求 |

---

## 十一、结论

SS 系统"什么都有但体验很差"有**两个根因**：

### 根因一：核心能力缺陷（最关键）

系统在"理解用户需求并生成正确代码"这一核心能力上存在严重缺陷：

- **模板支持范围**：319 个模板仅启用 6 个（1.9%）
- **信息传递链路**：从需求到代码经过 4 阶段信息衰减，研究设计意图大量丢失
- **数据理解**：给 LLM 的上下文严重不足（无类型、无统计、无缺失值）
- **用户纠错能力**：无法修改高级结构字段（FE、交互项、IV 等）

### 根因二：UX 改进执行滞后

74 个 UX 修复任务已规划但尚未实现，Wave 1-4 的核心改进未落地。

---

## 改进建议优先级

### 立即修复（最高优先级）

1. **扩展模板支持**：从 6 个扩展到至少覆盖常用分析方法
2. **修复 Draft 截断**：提升 800 字符限制，或使用结构化字段
3. **对齐 plan_generation prompt 与执行引擎**
4. **响应截断检测**

### 短期改进（1-2 周）

5. **增加数据统计信息**：给 LLM 提供列类型、缺失值、分布等
6. **支持用户修改高级结构字段**
7. 上传进度条、Draft 超时、任务取消机制

### 中期改进（1 个月）

8. 模板参数填充逻辑重构（支持 FE、交互项、IV 等）
9. 数据驱动的变量识别和验证
10. Wave 1-2 全部任务卡落地

### 长期优化（持续）

11. 完整的模板运行时验证
12. 新方法模板补充（PPML、DML 等）
13. 反馈确认机制和迭代优化能力
