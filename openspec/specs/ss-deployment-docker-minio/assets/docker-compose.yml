services:
  minio:
    image: minio/minio:latest
    command: server /data --console-address ":9001"
    ports:
      - "${MINIO_API_PORT:-9000}:9000"
      - "${MINIO_CONSOLE_PORT:-9001}:9001"
    environment:
      MINIO_ROOT_USER: "${MINIO_ROOT_USER:?missing}"
      MINIO_ROOT_PASSWORD: "${MINIO_ROOT_PASSWORD:?missing}"
    volumes:
      - minio-data:/data

  minio-init:
    image: minio/mc:latest
    depends_on:
      - minio
    env_file:
      - .env
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        set -eu
        until mc alias set local http://minio:9000 "$MINIO_ROOT_USER" "$MINIO_ROOT_PASSWORD"; do
          echo "waiting for minio..."
          sleep 1
        done
        mc mb --ignore-existing "local/${SS_UPLOAD_S3_BUCKET}"
    restart: "no"

  ss:
    image: python:3.12-slim
    working_dir: /app
    env_file:
      - .env
    environment:
      SS_JOBS_DIR: "/var/lib/ss/jobs"
      SS_QUEUE_DIR: "/var/lib/ss/queue"
      PYTHONUNBUFFERED: "1"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      minio-init:
        condition: service_completed_successfully
    ports:
      - "${SS_API_PORT:-8000}:8000"
    volumes:
      - ../../../..:/app:ro
      - ss-jobs:/var/lib/ss/jobs
      - ss-queue:/var/lib/ss/queue
      - ss-pip-cache:/root/.cache/pip
    entrypoint: ["/bin/sh", "-c"]
    command: python -m pip install . && python -m src.main

volumes:
  minio-data: {}
  ss-jobs: {}
  ss-queue: {}
  ss-pip-cache: {}
