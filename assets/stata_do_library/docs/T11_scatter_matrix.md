# T11_scatter_matrix — 散点图矩阵与变量关系可视化

## 任务元信息

| 属性 | 值 |
|------|-----|
| **Task ID** | T11_scatter_matrix |
| **任务名称** | 散点图矩阵与变量关系可视化 |
| **任务族** | B - 描述性统计 |
| **难度级别** | basic |
| **数据结构** | cross_section / panel / time_series（均适用） |
| **金融场景适用** | ✓ 是 |

## 任务摘要

生成多变量两两散点图矩阵，包含线性拟合线和相关系数标注，支持分组对比。用于可视化变量间的线性和非线性关系，发现潜在的异常值和聚类结构，是回归分析前的重要探索性步骤。

## 适用场景

### 场景 1：回归前变量关系探索
- **目的**：在正式回归前可视化因变量与自变量的关系
- **关注点**：是否存在明显的线性关系，有无非线性特征
- **后续**：决定是否需要变量变换或添加交互项

### 场景 2：多重共线性可视化诊断
- **目的**：直观发现高度相关的解释变量
- **关注点**：哪些自变量对呈现强线性关系
- **后续**：配合VIF检验进行处理

### 场景 3：异常值和聚类发现
- **目的**：通过散点图发现数据中的异常点或自然聚类
- **关注点**：离群点、明显的分组结构
- **后续**：数据清洗或分组分析

### 场景 4：论文图表展示
- **目的**：在论文中展示关键变量间的关系
- **要求**：清晰的拟合线和相关系数标注

## 理论背景

### 散点图矩阵的作用
1. **线性关系检测**：点呈直线趋势表示线性相关
2. **非线性关系检测**：曲线趋势提示需要变量变换
3. **异常值识别**：远离主体的点为潜在异常值
4. **聚类结构发现**：点的分组可能暗示存在交互效应

### 散点图形态与相关系数

| 形态 | 相关系数 r | 含义 |
|------|-----------|------|
| 向右上倾斜紧密 | r ≈ +1 | 强正相关 |
| 向左下倾斜紧密 | r ≈ -1 | 强负相关 |
| 散乱无规律 | r ≈ 0 | 无线性相关 |
| U型或倒U型 | r ≈ 0 但有关系 | 非线性关系 |

### 线性拟合线 (lfit)
- **作用**：展示两变量的线性拟合趋势
- **斜率**：反映单位变化的平均效应
- **偏离**：点偏离拟合线的程度反映拟合优度

## 输入与占位符说明

### 占位符列表

| 占位符 | 含义 | 类型 | 必填 | 合法取值示例 |
|--------|------|------|------|-------------|
| `__NUMERIC_VARS__` | 数值变量列表 | 多变量名（空格分隔） | ✓ 是 | `roa roe size leverage` |
| `__GROUP_VAR__` | 分组变量 | 单变量名 | 否 | `ownership` |

### 渲染规则

```python
# Python 渲染示例
config = {
    "numeric_vars": ["roa", "roe", "size", "leverage"],
    "group_var": "ownership"  # 可选
}

placeholders = {
    "__NUMERIC_VARS__": " ".join(config["numeric_vars"]),
    "__GROUP_VAR__": config.get("group_var", "")
}
```

## 数据要求与前置条件

### 数据文件
- **首选**：`data.dta`（Stata 格式）
- **备选**：`data.csv`（自动转换为 data.dta）
- **编码**：UTF-8（推荐）

### 变量要求
| 要求 | 说明 | 不满足时的后果 |
|------|------|---------------|
| 变量存在 | 指定变量必须在数据中 | 该变量被跳过 |
| 数值类型 | 变量必须是数值型 | 该变量被跳过 |
| 变量数量 | 建议 3-6 个 | 过多会导致图表拥挤 |

## Stata 执行流程

```
┌─────────────────────────────────────────────────────────────┐
│ SECTION 0: 环境初始化与数据导入                             │
├─────────────────────────────────────────────────────────────┤
│ SECTION 1: 变量检查                                         │
├─────────────────────────────────────────────────────────────┤
│ SECTION 2: 生成散点图矩阵                                   │
│   - 半矩阵散点图                                            │
│   - 完整矩阵（含直方图）                                    │
├─────────────────────────────────────────────────────────────┤
│ SECTION 3: 两两散点图（带拟合线）                           │
│   - 线性拟合                                                │
│   - 相关系数标注                                            │
├─────────────────────────────────────────────────────────────┤
│ SECTION 4: 分组散点图矩阵（可选）                           │
├─────────────────────────────────────────────────────────────┤
│ SECTION 5: 相关系数汇总                                     │
├─────────────────────────────────────────────────────────────┤
│ SECTION 6: 导出结果文件                                     │
├─────────────────────────────────────────────────────────────┤
│ SECTION 7: 任务完成摘要                                     │
└─────────────────────────────────────────────────────────────┘
```

## 输出文件清单与 Schema

### 0. result.log

任务执行日志，包含散点图矩阵生成过程、相关系数统计和警告信息。

### 1. 图表文件

| 文件 | 说明 |
|------|------|
| `fig_T11_scatter_matrix.png` | 半矩阵散点图 |
| `fig_T11_scatter_matrix_full.png` | 完整矩阵（对角线为直方图） |
| `fig_T11_scatter_[var1]_[var2].png` | 两两散点图（带拟合线） |
| `fig_T11_scatter_matrix_grouped.png` | 分组散点图矩阵（如指定分组） |

### 2. table_T11_correlations.csv

相关系数汇总表。

| 列名 | 类型 | 说明 |
|------|------|------|
| `var1` | string | 变量1 |
| `var2` | string | 变量2 |
| `pearson_r` | float | Pearson相关系数 |
| `p_value` | float | 显著性p值 |

## 上层 JSON 配置示例

### 示例 1：财务变量关系探索

```json
{
  "task_id": "T11_scatter_matrix",
  "description": "探索财务指标间的关系",
  "numeric_vars": ["roa", "roe", "size", "leverage", "growth"]
}
```

**场景说明**：在回归分析前，可视化财务变量间的两两关系。

### 示例 2：分组关系对比

```json
{
  "task_id": "T11_scatter_matrix",
  "description": "对比国企与民企的财务指标关系",
  "numeric_vars": ["roa", "size", "leverage"],
  "group_var": "ownership"
}
```

**场景说明**：比较不同产权性质企业中变量关系的差异。

## 图表解读指南

### 散点图矩阵解读
- **下三角**：各对变量的散点图
- **对角线**：变量名或各变量的边际分布直方图
- **上三角**：通常留空（半矩阵）或显示相关系数

### 单对散点图解读
- **点的分布**：反映两变量的联合分布
- **红色拟合线**：OLS线性拟合
- **副标题r值**：Pearson相关系数

### 常见形态判断

| 形态 | 说明 | 后续处理 |
|------|------|----------|
| 紧密线性 | 强相关 | 考虑多重共线性 |
| 松散线性 | 弱到中等相关 | 正常入回归 |
| U型/倒U型 | 非线性关系 | 添加平方项 |
| 扇形发散 | 异方差 | 使用稳健标准误 |
| 明显离群点 | 异常值 | 考虑Winsorize |

## 报告写作骨架

### 论文"变量关系"章节结构

```markdown
## X.X 变量关系的初步探索

图X展示了主要变量的散点图矩阵。从图中可以观察到：

（1）因变量[Y]与主要解释变量[X]呈现明显的[正向/负向]线性关系
（r=[值]），初步支持了研究假设H1。

（2）控制变量[Size]与因变量呈[正/负]相关，与预期[一致/不一致]。

（3）解释变量[X1]与[X2]存在较强的正相关（r=[值]），需关注
潜在的多重共线性问题。后续将通过VIF检验进一步诊断。

（4）从散点分布来看，未发现明显的非线性关系特征，因此采用
线性回归模型是合适的。

### 图X 主要变量散点图矩阵
[插入散点图矩阵]
```

## 常见坑与建议

### 1. 变量过多
- **问题**：变量 > 6 个时图表过于拥挤
- **建议**：分批绘制，或只选择核心变量

### 2. 样本量过大
- **问题**：点重叠严重，无法辨识分布
- **建议**：使用透明度（mcolor(navy%50)）或随机抽样

### 3. 极端值影响
- **问题**：少数极端值压缩了图形主体
- **建议**：先Winsorize再绘图

### 4. 非线性关系
- **问题**：线性拟合线无法反映真实关系
- **建议**：添加LOWESS平滑线对比

### 5. 分组过多
- **问题**：分组散点图难以辨识
- **建议**：限制组数 ≤ 4

## 与其他任务的关系

| 相关任务 | 关系说明 |
|----------|----------|
| T09_corr_matrix | 散点图是相关系数的可视化补充 |
| T10_distribution_plots | 对角线直方图展示边际分布 |
| T17-T24 回归分析 | 散点图是回归分析的前置探索 |
| T21_vif | 发现高相关变量后进行VIF诊断 |

## 技术说明

- **Stata 版本**：18.0+
- **外部依赖**：无，仅使用 Stata 官方命令
- **关键命令**：`graph matrix`, `twoway scatter`, `lfit`, `pwcorr`
