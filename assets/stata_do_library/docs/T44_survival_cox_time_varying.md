# T44_survival_cox_time_varying — 时变协变量Cox模型（Time-Varying Cox）

## 任务元信息

| 属性 | 值 |
|------|-----|
| **Task ID** | T44_survival_cox_time_varying |
| **任务名称** | 时变协变量Cox模型 |
| **任务族** | H - 生存分析 |
| **难度级别** | advanced |
| **数据结构** | survival (计数过程) |
| **金融场景适用** | ✓ 是 |

## 任务摘要

估计包含时变协变量的Cox模型，支持计数过程数据格式。**处理协变量随时间变化的高级生存分析方法**。

## 适用场景

### 场景 1：动态信用评级
- **目的**：分析评级变化对违约的影响
- **方法**：时变Cox模型
- **应用**：信用风险管理

### 场景 2：治疗切换效应
- **目的**：分析治疗方案变化的影响
- **方法**：时变处理变量
- **应用**：干预效果评估

### 场景 3：时变财务指标
- **目的**：分析财务状况变化对企业存续的影响
- **方法**：季度更新的协变量
- **应用**：企业风险预警

## 理论背景

### 时变Cox模型

$$h(t|X(t)) = h_0(t) \cdot \exp(\beta' X(t))$$

协变量$X(t)$可随时间变化，风险在每个时点根据当前协变量值计算。

### 计数过程数据格式

每个个体被拆分为多个风险区间：

| id | start | stop | event | x(t) |
|----|-------|------|-------|------|
| 1 | 0 | 30 | 0 | 1.2 |
| 1 | 30 | 60 | 0 | 1.5 |
| 1 | 60 | 90 | 1 | 2.0 |

- **start**：区间起点（左开）
- **stop**：区间终点（右闭）
- **event**：该区间是否发生事件

### 内生性问题

时变协变量可能存在内生性：
- **外生时变**：协变量变化与结局无关
- **内生时变**：协变量变化可能预示结局

## 数据文件要求

### 数据文件
- **首选**：`data.dta`（Stata 格式）
- **备选**：`data.csv`（自动转换为 data.dta）
- **编码**：UTF-8（推荐）

### 变量要求
- 数据必须为计数过程格式（每个风险区间一行）
- ID变量：个体标识
- Start/Stop变量：区间起止时间
- 事件变量：0/1二元变量

## 输入与占位符说明

### 占位符列表

| 占位符 | 含义 | 类型 | 必填 | 合法取值示例 |
|--------|------|------|------|-------------|
| `__ID_VAR__` | 个体标识 | 单变量名 | ✓ 是 | `firm_id` |
| `__START_VAR__` | 区间起点 | 单变量名 | ✓ 是 | `tstart` |
| `__STOP_VAR__` | 区间终点 | 单变量名 | ✓ 是 | `tstop` |
| `__EVENT_VAR__` | 事件指示 | 单变量名 | ✓ 是 | `default` |
| `__INDEPVARS__` | 协变量列表 | 多变量名 | ✓ 是 | `rating leverage` |

### 数据格式示例

```
id  tstart  tstop  default  rating  leverage
1   0       4      0        A       0.30
1   4       8      0        B       0.45
1   8       12     1        C       0.62
2   0       4      0        A       0.25
2   4       16     0        A       0.28
```

## 输出文件清单与 Schema

### 0. result.log

任务执行日志，包含数据结构检查、时变Cox模型估计、危险比输出和比例风险检验。

### 1. table_T44_cox_tv_coef.csv

时变Cox回归系数表。

| 列名 | 类型 | 说明 |
|------|------|------|
| `variable` | string | 变量名 |
| `coef` | float | 系数β |
| `se` | float | 标准误 |
| `hr` | float | 危险比 |
| `z` | float | z统计量 |
| `p` | float | p值 |
| `hr_lo` | float | HR 95%CI下限 |
| `hr_hi` | float | HR 95%CI上限 |

## 上层 JSON 配置示例

```json
{
  "task_id": "T44_survival_cox_time_varying",
  "description": "动态信用评级对违约的影响",
  "id_var": "firm_id",
  "start_var": "quarter_start",
  "stop_var": "quarter_end",
  "event_var": "default",
  "indep_vars": ["rating_score", "leverage", "roa"]
}
```

## 报告写作骨架

```markdown
## X.X 时变协变量Cox模型

考虑到[协变量]随时间变化，本文采用时变协变量Cox模型：

$$ h(t|X(t)) = h_0(t) \cdot \exp(\beta' X(t)) $$

数据被转换为计数过程格式，共[N]个个体、[M]条记录，
平均每个个体[M/N]条记录。

表X报告了回归结果。[时变协变量]的危险比为[HR]（p<0.01），
表明当[协变量]增加1单位时，[事件]瞬时风险增加[HR-1]×100%。
该效应反映的是协变量当期值对风险的影响。

### 表X 时变协变量Cox回归结果
─────────────────────────────────────────────────────────────
变量（时变）      HR        95% CI            p值
─────────────────────────────────────────────────────────────
Rating Score     1.85***   [1.42, 2.41]     <0.001
Leverage         2.32***   [1.68, 3.21]     <0.001
ROA              0.65**    [0.48, 0.88]      0.005
─────────────────────────────────────────────────────────────
个体数          1,500
记录数          6,000
事件数            120
─────────────────────────────────────────────────────────────
注：***、**、*分别表示在1%、5%、10%水平下显著。
```

## 常见坑与建议

### 1. 数据格式错误
- **问题**：数据不是计数过程格式
- **建议**：使用stsplit命令转换

### 2. 区间重叠
- **问题**：同一ID的区间有重叠
- **建议**：stset会报错，需清理数据

### 3. 内生性
- **问题**：协变量变化与结局相关
- **建议**：考虑滞后协变量或工具变量

### 4. 间隙
- **问题**：区间不连续
- **建议**：确保区间无缝衔接

## 与其他任务的关系

| 相关任务 | 关系说明 |
|----------|----------|
| T43_survival_cox_basic | 基本Cox回归 |
| T41_survival_km_curve | 描述性分析 |

## 技术说明

- **Stata 版本**：18.0+
- **外部依赖**：无，仅使用 Stata 官方命令
- **关键命令**：`stset ... enter() id()`, `stdescribe`, `stcox`, `estat phtest`
- **退出码**：错误时统一返回 200
