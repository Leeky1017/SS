# T47_kmeans_clustering — K-means聚类（K-means Clustering）

## 任务元信息

| 属性 | 值 |
|------|-----|
| **Task ID** | T47_kmeans_clustering |
| **任务名称** | K-means聚类 |
| **任务族** | I - 多变量与无监督学习 |
| **难度级别** | intermediate |
| **数据结构** | cross_sectional |
| **金融场景适用** | ✓ 是 |

## 任务摘要

进行K-means聚类，将样本分成若干组，输出簇标签和各簇特征。**最常用的划分型聚类方法**。

## 适用场景

### 场景 1：客户分群
- **目的**：将客户分成不同群体
- **方法**：K-means聚类
- **应用**：RFM分析、精准营销

### 场景 2：市场细分
- **目的**：识别市场中的不同细分
- **方法**：基于行为特征聚类
- **应用**：产品定位

### 场景 3：异常检测
- **目的**：识别异常样本
- **方法**：远离簇中心的样本
- **应用**：欺诈检测

## 理论背景

### K-means算法

目标：最小化组内平方和（Within-cluster SS）

$$\min \sum_{k=1}^{K} \sum_{x_i \in C_k} ||x_i - \mu_k||^2$$

### 算法步骤

1. 随机初始化K个簇中心
2. 将每个样本分配到最近的簇中心
3. 重新计算各簇中心
4. 重复2-3直到收敛

### K值选择

| 方法 | 说明 |
|------|------|
| **肘部法则** | SSE下降变缓的拐点 |
| **轮廓系数** | 最大化轮廓系数 |
| **Gap统计量** | 与随机分布比较 |
| **业务理解** | 根据实际需求 |

### 注意事项

- 变量需标准化（消除量纲影响）
- 对初始值敏感（多次运行取最优）
- 假设簇为球形

## 数据文件要求

### 数据文件
- **首选**：`data.dta`（Stata 格式）
- **备选**：`data.csv`（自动转换为 data.dta）
- **编码**：UTF-8（推荐）

### 变量要求
- 所有聚类变量必须为数值型
- 建议无缺失值或预先处理
- 建议预先处理异常值

## 输入与占位符说明

### 占位符列表

| 占位符 | 含义 | 类型 | 必填 | 合法取值示例 |
|--------|------|------|------|-------------|
| `__NUMERIC_VARS__` | 聚类变量列表 | 多变量名 | ✓ 是 | `recency frequency monetary` |
| `__N_CLUSTERS__` | 聚类数量K | 整数 | ✓ 是 | `3` |

## 输出文件清单与 Schema

### 0. result.log

任务执行日志，包含描述统计、变量标准化、K-means聚类结果、各簇分布和特征。

### 1. table_T47_clusters.csv

聚类结果表。

| 列名 | 类型 | 说明 |
|------|------|------|
| `cluster_id` | int | 簇标签（1,2,...,K） |
| `[原始变量]` | float | 原始变量值 |

### 2. table_T47_centers.csv

簇中心表（标准化尺度）。

| 列名 | 类型 | 说明 |
|------|------|------|
| `cluster_id` | int | 簇标签（1,2,...,K） |
| `z_[变量名]` | float | 各标准化变量的簇中心均值 |

### 3. fig_T47_kmeans.png

聚类散点图（PNG格式）。

## 上层 JSON 配置示例

```json
{
  "task_id": "T47_kmeans_clustering",
  "description": "客户RFM分群",
  "numeric_vars": ["recency", "frequency", "monetary"],
  "n_clusters": 4
}
```

## 报告写作骨架

```markdown
## X.X 聚类分析

为识别[研究对象]的不同群体，本文采用K-means聚类方法。
基于[变量列表]，将样本分为[K]个簇。

表X报告了各簇的特征。簇1包含[N1]个样本（[%1]），
该群体的特征为[高/低XX、高/低YY]；
簇2包含[N2]个样本（[%2]），特征为...

从业务角度，簇1可命名为"[VIP客户]"，
簇2可命名为"[普通客户]"...

### 表X 各簇特征
─────────────────────────────────────────────────────────────
簇        样本数      Recency      Frequency     Monetary
─────────────────────────────────────────────────────────────
簇1        450        15.2          8.5          1250
簇2        680        45.8          3.2           380
簇3        370        85.3          1.1            95
─────────────────────────────────────────────────────────────

### 图X 聚类散点图
[插入 fig_T47_kmeans.png]

注：不同颜色代表不同簇。
```

## 常见坑与建议

### 1. 未标准化
- **问题**：量纲大的变量主导结果
- **建议**：必须标准化变量

### 2. K值选择
- **问题**：主观确定K值
- **建议**：结合肘部法则和业务理解

### 3. 初始值敏感
- **问题**：结果不稳定
- **建议**：多次运行取最优

### 4. 异常值影响
- **问题**：异常值影响簇中心
- **建议**：预先处理异常值

## 与其他任务的关系

| 相关任务 | 关系说明 |
|----------|----------|
| T48_hierarchical_clustering | 层次聚类（无需预设K） |
| T45_pca_principal_components | 降维后聚类 |

## 技术说明

- **Stata 版本**：18.0+
- **外部依赖**：无，仅使用 Stata 官方命令
- **关键命令**：`cluster kmeans`, `tabulate`, `tabstat`
- **退出码**：错误时统一返回 200
