# T18_ols_multiple — 多元线性回归（Multiple OLS）

## 任务元信息

| 属性 | 值 |
|------|-----|
| **Task ID** | T18_ols_multiple |
| **任务名称** | 多元线性回归 |
| **任务族** | D - 线性回归 |
| **难度级别** | intermediate |
| **数据结构** | cross_section |
| **金融场景适用** | ✓ 是 |

## 任务摘要

估计多个自变量对因变量的线性关系（多元OLS回归）。包含VIF多重共线性检验、异方差检验（BP、White）、模型设定检验（RESET）、标准化系数和残差诊断。金融/会计研究的基础回归模型。

## 适用场景

### 场景 1：公司绩效决定因素
- **因变量**：ROA或Tobin's Q
- **自变量**：规模、杠杆、成长性、公司治理等
- **应用**：检验各因素对公司绩效的影响

### 场景 2：资本结构决定因素
- **因变量**：资产负债率
- **自变量**：规模、盈利能力、有形资产比例、成长性
- **应用**：检验资本结构理论的经验证据

### 场景 3：盈余管理模型
- **因变量**：应计利润或异常应计
- **自变量**：收入变动、PPE、CFO
- **应用**：Jones模型或修正Jones模型

### 场景 4：审计收费模型
- **因变量**：审计费用（对数）
- **自变量**：规模、复杂性、风险、事务所特征
- **应用**：检验审计定价的决定因素

## 理论背景

### 多元线性回归模型

$$Y_i = \beta_0 + \beta_1 X_{1i} + \beta_2 X_{2i} + ... + \beta_k X_{ki} + \varepsilon_i$$

**矩阵形式**：
$$\mathbf{Y} = \mathbf{X}\boldsymbol{\beta} + \boldsymbol{\varepsilon}$$

**OLS估计量**：
$$\hat{\boldsymbol{\beta}} = (\mathbf{X}'\mathbf{X})^{-1}\mathbf{X}'\mathbf{Y}$$

### 系数解释

多元回归中，$\beta_j$ 的含义是：
> **控制其他变量不变的情况下**，$X_j$ 每增加1单位，$Y$ 的平均变化量

### 多重共线性

**方差膨胀因子（VIF）**：
$$VIF_j = \frac{1}{1 - R_j^2}$$

其中 $R_j^2$ 是 $X_j$ 对其他自变量回归的 $R^2$。

| VIF 值 | 共线性程度 | 处理建议 |
|--------|------------|----------|
| < 5 | 无问题 | 无需处理 |
| 5-10 | 中度 | 关注，可接受 |
| ≥ 10 | 严重 | 需处理 |

### 模型设定检验

**Ramsey RESET检验**：
- H0：模型无遗漏变量/函数形式正确
- p < 0.05 表示可能存在设定问题

## 数据文件要求

### 数据文件
- **首选**：`data.dta`（Stata 格式）
- **备选**：`data.csv`（自动转换为 data.dta）
- **编码**：UTF-8（推荐）

### 变量要求
- 因变量和自变量必须为数值型
- 不允许完全缺失

## 输入与占位符说明

### 占位符列表

| 占位符 | 含义 | 类型 | 必填 | 合法取值示例 |
|--------|------|------|------|-------------|
| `__DEP_VAR__` | 因变量 | 单变量名 | ✓ 是 | `roa` |
| `__INDEP_VARS__` | 自变量列表 | 空格分隔变量 | ✓ 是 | `size lev growth` |

### 渲染规则

```python
# Python 渲染示例
config = {
    "dep_var": "roa",
    "indep_vars": ["size", "lev", "growth", "soe"]
}

placeholders = {
    "__DEP_VAR__": config["dep_var"],
    "__INDEP_VARS__": " ".join(config["indep_vars"])
}
```

## Stata 执行流程

```
┌─────────────────────────────────────────────────────────────┐
│ SECTION 0: 环境初始化与数据导入                             │
├─────────────────────────────────────────────────────────────┤
│ SECTION 1: 变量检查                                         │
├─────────────────────────────────────────────────────────────┤
│ SECTION 2: 变量描述统计                                     │
├─────────────────────────────────────────────────────────────┤
│ SECTION 3: 相关性矩阵                                       │
├─────────────────────────────────────────────────────────────┤
│ SECTION 4: 多元线性回归                                     │
├─────────────────────────────────────────────────────────────┤
│ SECTION 5: 标准化系数（Beta）                               │
├─────────────────────────────────────────────────────────────┤
│ SECTION 6: 多重共线性检验（VIF）                            │
├─────────────────────────────────────────────────────────────┤
│ SECTION 7: 回归诊断                                         │
│   - Breusch-Pagan 异方差检验                               │
│   - White 异方差检验                                        │
│   - Ramsey RESET 设定检验                                   │
├─────────────────────────────────────────────────────────────┤
│ SECTION 8: 回归结果汇总                                     │
├─────────────────────────────────────────────────────────────┤
│ SECTION 9: 可视化                                           │
├─────────────────────────────────────────────────────────────┤
│ SECTION 10: 导出结果文件                                    │
└─────────────────────────────────────────────────────────────┘
```

## 输出文件清单与 Schema

### 0. result.log

任务执行日志，包含回归过程、VIF检验、异方差检验、RESET检验输出和结果摘要。

### 1. table_T18_reg_result.csv

回归系数表。

| 列名 | 类型 | 说明 |
|------|------|------|
| `variable` | string | 变量名 |
| `coef` | float | 回归系数 |
| `se` | float | 标准误 |
| `t` | float | t统计量 |
| `p` | float | p值 |
| `sig` | string | 显著性标记 |

### 2. table_T18_vif.csv

VIF共线性检验结果。

| 列名 | 类型 | 说明 |
|------|------|------|
| `variable` | string | 变量名 |
| `vif` | float | 方差膨胀因子 |
| `tolerance` | float | 容忍度（1/VIF） |

### 3. fig_T18_residuals.png

标准化残差诊断图（PNG格式）。

## 上层 JSON 配置示例

### 示例 1：公司绩效模型

```json
{
  "task_id": "T18_ols_multiple",
  "description": "检验公司特征对ROA的影响",
  "dep_var": "roa",
  "indep_vars": ["size", "lev", "growth", "soe", "age"]
}
```

**场景说明**：控制多种公司特征，估计各因素对ROA的边际效应。

### 示例 2：审计费用模型

```json
{
  "task_id": "T18_ols_multiple",
  "description": "审计收费决定因素分析",
  "dep_var": "lnfee",
  "indep_vars": ["lnasset", "invrec", "loss", "big4", "opinion"]
}
```

**场景说明**：检验公司规模、复杂性、风险等因素对审计收费的影响。

## 报告写作骨架

### 论文"基准回归"章节结构

```markdown
## X.X 基准回归分析

为检验研究假设，本文构建如下多元回归模型：

$$ Y_{it} = \beta_0 + \beta_1 X_{it} + \sum_j \gamma_j Control_{jit} + \varepsilon_{it} $$

其中，Y为[因变量]，X为[核心解释变量]，Control为控制变量。

表X报告了OLS回归结果。列（1）为仅含核心变量的回归，列（2）-（4）
依次加入控制变量。核心变量X的系数为[β]（t=[t]），在[1%/5%/10%]
水平下[显著/不显著为正/负]，表明[经济含义解释]。

从控制变量来看，[变量1]的系数显著为[正/负]，表明...；[变量2]不显著，
可能是因为...。模型整体拟合良好，调整R²为[adj_R²]，F统计量为[F]
（p<0.01）。

VIF检验表明平均VIF为[mean_vif]，各变量VIF均小于[max_vif]，
不存在严重多重共线性问题。

### 表X 基准回归结果
─────────────────────────────────────────────────────────────
                   (1)         (2)         (3)         (4)
─────────────────────────────────────────────────────────────
X               0.035***    0.032***    0.030***    0.028***
               (0.008)     (0.008)     (0.008)     (0.009)
Size                        0.012***    0.011***    0.010***
                           (0.002)     (0.002)     (0.002)
Lev                                    -0.045***   -0.042***
                                       (0.010)     (0.010)
Growth                                              0.015**
                                                   (0.006)
Constant        0.125***    0.085***    0.095***    0.090***
               (0.015)     (0.020)     (0.021)     (0.022)
─────────────────────────────────────────────────────────────
N               10,000      10,000      10,000      10,000
R²              0.025       0.065       0.085       0.090
Adj. R²         0.025       0.065       0.085       0.089
F               256.4       348.2       310.5       248.3
─────────────────────────────────────────────────────────────
注：括号内为标准误；***、**、*分别表示在1%、5%、10%水平下显著。
```

## 常见坑与建议

### 1. 多重共线性
- **问题**：VIF过高导致系数不稳定
- **建议**：删除高VIF变量或使用主成分

### 2. 遗漏变量偏误
- **问题**：RESET检验显著
- **建议**：增加控制变量或使用固定效应

### 3. 异方差
- **问题**：BP/White检验显著
- **建议**：使用稳健标准误（T19）

### 4. 标准化系数误用
- **问题**：用Beta比较跨样本的重要性
- **建议**：Beta仅用于同一回归内的比较

### 5. R²过度解读
- **问题**：追求高R²
- **建议**：关注系数估计，R²仅作参考

## 与其他任务的关系

| 相关任务 | 关系说明 |
|----------|----------|
| T17_ols_simple | 简单回归是多元回归的特例 |
| T19_ols_robust_se | 异方差时使用稳健标准误 |
| T20_ols_cluster_se | 面板数据使用聚类标准误 |
| T21_ols_with_interaction | 含交互项的回归 |
| T22_ols_fe_entity_dummies | 固定效应回归 |

## 技术说明

- **Stata 版本**：18.0+
- **外部依赖**：无，仅使用 Stata 官方命令
- **关键命令**：`regress`, `estat vif`, `estat hettest`, `estat ovtest`
- **退出码**：错误时统一返回 200
