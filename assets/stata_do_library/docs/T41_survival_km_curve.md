# T41_survival_km_curve — Kaplan-Meier生存曲线（Survival Curve）

## 任务元信息

| 属性 | 值 |
|------|-----|
| **Task ID** | T41_survival_km_curve |
| **任务名称** | Kaplan-Meier生存曲线 |
| **任务族** | H - 生存分析 |
| **难度级别** | basic |
| **数据结构** | survival |
| **金融场景适用** | ✓ 是（客户流失、企业存续） |

## 任务摘要

绘制Kaplan-Meier生存曲线，估计生存函数，计算中位生存时间。**生存分析的基础描述方法**。

## 适用场景

### 场景 1：客户流失分析
- **目的**：分析客户留存时间
- **方法**：KM生存曲线
- **应用**：客户生命周期管理

### 场景 2：企业存续研究
- **目的**：分析企业存续时间
- **方法**：分组生存曲线
- **应用**：IPO后企业存续、违约风险

### 场景 3：产品寿命分析
- **目的**：分析产品使用寿命
- **方法**：可靠性分析
- **应用**：质量控制

## 理论背景

### 生存函数

$$S(t) = P(T > t) = 1 - F(t)$$

在时刻t存活的概率。

### Kaplan-Meier估计量

$$\hat{S}(t) = \prod_{t_i \leq t} \left(1 - \frac{d_i}{n_i}\right)$$

- $t_i$：第i个事件时刻
- $d_i$：时刻$t_i$的事件数
- $n_i$：时刻$t_i$的风险集大小

### 删失（Censoring）

| 类型 | 定义 |
|------|------|
| **右删失** | 只知道T > C（观察终止时未发生事件） |
| **左删失** | 只知道T < C（事件已发生但不知何时） |
| **区间删失** | 只知道T在某区间内 |

### 中位生存时间

$$\hat{t}_{0.5} = \inf\{t: \hat{S}(t) \leq 0.5\}$$

生存概率降至50%的时间。

## 数据文件要求

### 数据文件
- **首选**：`data.dta`（Stata 格式）
- **备选**：`data.csv`（自动转换为 data.dta）
- **编码**：UTF-8（推荐）

### 变量要求
- 生存时间变量：数值型，正值
- 事件变量：0/1二元变量（0=删失，1=事件）
- 分组变量：数值型或字符型

## 输入与占位符说明

### 占位符列表

| 占位符 | 含义 | 类型 | 必填 | 合法取值示例 |
|--------|------|------|------|-------------|
| `__TIME_VAR__` | 生存时间 | 单变量名 | ✓ 是 | `duration` |
| `__EVENT_VAR__` | 事件指示（1=事件，0=删失） | 单变量名 | ✓ 是 | `churn` |
| `__GROUP_VAR__` | 分组变量 | 单变量名 | ✓ 是 | `product_type` |

## 输出文件清单与 Schema

### 0. result.log

任务执行日志，包含生存数据概况、KM曲线、中位生存时间、特定时间点生存概率和结果摘要。

### 1. fig_T41_km.png

分组Kaplan-Meier生存曲线（PNG格式）。

### 2. fig_T41_km_overall.png

总体生存曲线（PNG格式）。

### 3. table_T41_survival.csv

生存统计表。

| 列名 | 类型 | 说明 |
|------|------|------|
| `n_subjects` | int | 研究对象数 |
| `n_events` | int | 事件发生数 |
| `n_censored` | int | 删失数 |
| `total_time` | float | 总随访时间 |

## 上层 JSON 配置示例

```json
{
  "task_id": "T41_survival_km_curve",
  "description": "客户流失生存分析",
  "time_var": "tenure_months",
  "event_var": "churned",
  "group_var": "contract_type"
}
```

## 报告写作骨架

```markdown
## X.X 生存分析

### X.X.1 数据概况

本文采用生存分析方法研究[结局事件]。样本包含[N]个观测对象，
其中[n]个发生[事件]，[m]个为删失观测，删失比例为[%]。

### X.X.2 Kaplan-Meier生存曲线

图X展示了按[分组变量]分组的Kaplan-Meier生存曲线。
可以观察到：
(1) [组1]的生存曲线始终高于[组2]，表明[组1]的[存续时间更长]。
(2) [组1]的中位生存时间为[t1]（95% CI: [下限, 上限]），
    [组2]为[t2]（95% CI: [下限, 上限]）。
(3) 在[关键时点]，[组1]的生存概率为[S1]，
    [组2]为[S2]。

### 图X Kaplan-Meier生存曲线
[插入 fig_T41_km.png]

注：Y轴为生存概率S(t)，X轴为时间。
阶梯下降表示事件发生，竖线表示删失观测。
```

## 常见坑与建议

### 1. 忽略删失
- **问题**：将删失视为事件或排除
- **建议**：正确编码删失（0=删失，1=事件）

### 2. 时间单位不一致
- **问题**：不同观测的时间单位不同
- **建议**：统一时间单位

### 3. 样本量不足
- **问题**：曲线后期不稳定
- **建议**：关注有足够风险集的时期

### 4. 独立删失假设
- **问题**：删失与事件相关
- **建议**：检验删失机制，考虑竞争风险

## 与其他任务的关系

| 相关任务 | 关系说明 |
|----------|----------|
| T42_survival_logrank_test | 组间差异检验 |
| T43_survival_cox_basic | Cox回归建模 |

## 技术说明

- **Stata 版本**：18.0+
- **外部依赖**：无，仅使用 Stata 官方命令
- **关键命令**：`stset`, `stdescribe`, `stsum`, `sts graph`, `stci`, `sts list`
- **退出码**：错误时统一返回 200
