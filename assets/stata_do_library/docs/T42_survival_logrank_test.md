# T42_survival_logrank_test — Log-rank检验（Survival Curve Comparison）

## 任务元信息

| 属性 | 值 |
|------|-----|
| **Task ID** | T42_survival_logrank_test |
| **任务名称** | Log-rank检验 |
| **任务族** | H - 生存分析 |
| **难度级别** | basic |
| **数据结构** | survival |
| **金融场景适用** | ✓ 是 |

## 任务摘要

进行组间生存曲线的Log-rank检验及其他非参数检验。**生存分析中比较组间差异的标准方法**。

## 适用场景

### 场景 1：处理效果比较
- **目的**：比较处理组与对照组
- **方法**：Log-rank检验
- **应用**：干预效果评估

### 场景 2：产品类别比较
- **目的**：比较不同产品的客户留存
- **方法**：多组Log-rank检验
- **应用**：产品策略优化

### 场景 3：风险分层
- **目的**：验证风险分组有效性
- **方法**：比较高/低风险组生存
- **应用**：信用风险分层

## 理论背景

### Log-rank检验

比较各组的观察事件数(O)与期望事件数(E)：

$$\chi^2 = \frac{(O_1 - E_1)^2}{V_1}$$

- 在H0下，$\chi^2 \sim \chi^2_{k-1}$（k为组数）
- Log-rank在比例风险假设下最优

### 各检验方法比较

| 方法 | 权重 | 特点 |
|------|------|------|
| **Log-rank** | 1 | 所有时点等权，最常用 |
| **Wilcoxon** | $n_j$ | 早期权重大，对早期差异敏感 |
| **Tarone-Ware** | $\sqrt{n_j}$ | 折中 |
| **Peto-Peto** | $\hat{S}(t)$ | 使用生存概率加权 |

### 比例风险假设

Log-rank假设各组的风险比例恒定：
$$\frac{h_1(t)}{h_0(t)} = HR = constant$$

若生存曲线交叉，比例风险假设不成立。

## 数据文件要求

### 数据文件
- **首选**：`data.dta`（Stata 格式）
- **备选**：`data.csv`（自动转换为 data.dta）
- **编码**：UTF-8（推荐）

### 变量要求
- 生存时间变量：数值型，正值
- 事件变量：0/1二元变量（0=删失，1=事件）
- 分组变量：数值型或字符型，至少两组

## 输入与占位符说明

### 占位符列表

| 占位符 | 含义 | 类型 | 必填 | 合法取值示例 |
|--------|------|------|------|-------------|
| `__TIME_VAR__` | 生存时间 | 单变量名 | ✓ 是 | `duration` |
| `__EVENT_VAR__` | 事件指示 | 单变量名 | ✓ 是 | `churn` |
| `__GROUP_VAR__` | 分组变量 | 单变量名 | ✓ 是 | `treatment` |

## 输出文件清单与 Schema

### 0. result.log

任务执行日志，包含各组生存概况、Log-rank检验、Wilcoxon检验、检验结果汇总和结论。

### 1. table_T42_logrank.csv

检验结果表。

| 列名 | 类型 | 说明 |
|------|------|------|
| `test` | string | 检验方法 |
| `chi2` | float | χ²统计量 |
| `df` | int | 自由度 |
| `p_value` | float | p值 |

## 上层 JSON 配置示例

```json
{
  "task_id": "T42_survival_logrank_test",
  "description": "高低风险组生存比较",
  "time_var": "survival_time",
  "event_var": "default",
  "group_var": "risk_level"
}
```

## 报告写作骨架

```markdown
## X.X 组间生存差异检验

为检验各组生存曲线是否存在显著差异，本文进行Log-rank检验。

表X报告了检验结果。Log-rank检验χ²=[χ²]（df=[df]，p=[p]），
[在1%/5%/10%水平下显著/不显著]，表明[处理组与对照组/
各风险等级]的生存曲线[存在/不存在]显著差异。

作为稳健性检验，Wilcoxon检验（对早期差异更敏感）给出
χ²=[χ²]（p=[p]），结论[一致/不一致]。

### 表X 组间生存差异检验
─────────────────────────────────────────────────────────────
检验方法            χ²统计量      自由度      p值
─────────────────────────────────────────────────────────────
Log-rank            15.23          1        <0.001***
Wilcoxon            12.87          1         0.003***
Tarone-Ware         14.05          1        <0.001***
─────────────────────────────────────────────────────────────
注：***、**、*分别表示在1%、5%、10%水平下显著。
```

## 常见坑与建议

### 1. 曲线交叉
- **问题**：生存曲线交叉时Log-rank效力低
- **建议**：使用加权检验或分段分析

### 2. 多重比较
- **问题**：多组两两比较时犯I类错误
- **建议**：使用Bonferroni校正

### 3. 样本量不平衡
- **问题**：各组样本量差异大
- **建议**：报告各组样本量和事件数

## 与其他任务的关系

| 相关任务 | 关系说明 |
|----------|----------|
| T41_survival_km_curve | KM曲线可视化 |
| T43_survival_cox_basic | Cox回归进一步分析 |

## 技术说明

- **Stata 版本**：18.0+
- **外部依赖**：无，仅使用 Stata 官方命令
- **关键命令**：`stset`, `stsum`, `stci`, `sts test`
- **退出码**：错误时统一返回 200
