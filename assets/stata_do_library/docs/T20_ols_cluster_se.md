# T20_ols_cluster_se — 聚类稳健标准误OLS（Cluster-Robust SE）

## 任务元信息

| 属性 | 值 |
|------|-----|
| **Task ID** | T20_ols_cluster_se |
| **任务名称** | 聚类稳健标准误OLS |
| **任务族** | D - 线性回归 |
| **难度级别** | intermediate |
| **数据结构** | panel / clustered cross_section |
| **金融场景适用** | ✓ 是 |

## 任务摘要

使用聚类稳健标准误进行OLS回归，处理组内相关问题。包含OLS、Robust、Cluster三种标准误对比、组内相关系数（ICC）分析。**金融/会计面板数据研究的标准做法**。

## 适用场景

### 场景 1：公司-年份面板数据
- **聚类变量**：公司ID（stkcd）
- **理由**：同一公司不同年份的观测相关
- **应用**：绝大多数公司金融研究

### 场景 2：员工-公司层级数据
- **聚类变量**：公司ID
- **理由**：同一公司的员工可能相关
- **应用**：劳动经济学、组织行为研究

### 场景 3：地区聚类
- **聚类变量**：省份/城市
- **理由**：同一地区的观测可能受共同因素影响
- **应用**：区域经济、政策效应研究

### 场景 4：时间聚类
- **聚类变量**：年份
- **理由**：同一年的横截面观测可能相关（共同冲击）
- **应用**：宏观因子影响研究

## 理论背景

### 组内相关问题

当同一聚类内的观测存在相关时：
$$Cov(\varepsilon_i, \varepsilon_j) \neq 0 \quad \text{if } i, j \text{ in same cluster}$$

后果：
- OLS系数**仍然无偏**
- 但标准误**严重低估**，导致t值过大、假阳性率过高

### 聚类稳健标准误

**聚类协方差矩阵**：
$$\hat{V}_{cluster} = (X'X)^{-1} \left( \sum_{g=1}^{G} X_g' \hat{e}_g \hat{e}_g' X_g \right) (X'X)^{-1}$$

其中 $G$ 是聚类数量，$\hat{e}_g$ 是第 $g$ 个聚类的残差向量。

### 组内相关系数（ICC）

$$ICC = \frac{\sigma^2_{between}}{\sigma^2_{between} + \sigma^2_{within}}$$

| ICC | 解释 | 聚类重要性 |
|-----|------|-----------|
| < 0.05 | 很低 | 可能不需要聚类 |
| 0.05-0.15 | 中低 | 建议聚类 |
| 0.15-0.30 | 中等 | 必须聚类 |
| > 0.30 | 高 | 强烈需要聚类 |

### 聚类数量的重要性

聚类标准误的可靠性取决于聚类数量：

| 聚类数 (G) | 可靠性 | 建议 |
|------------|--------|------|
| < 20 | 很低 | 不推荐，考虑bootstrap |
| 20-30 | 较低 | 谨慎使用 |
| 30-50 | 中等 | 基本可用 |
| ≥ 50 | 较高 | 可放心使用 |

## 数据文件要求

### 数据文件
- **首选**：`data.dta`（Stata 格式）
- **备选**：`data.csv`（自动转换为 data.dta）
- **编码**：UTF-8（推荐）

### 变量要求
- 因变量、自变量必须为数值型
- 聚类变量可以是数值或字符型
- 不允许完全缺失

## 输入与占位符说明

### 占位符列表

| 占位符 | 含义 | 类型 | 必填 | 合法取值示例 |
|--------|------|------|------|-------------|
| `__DEPVAR__` | 因变量 | 单变量名 | ✓ 是 | `roa` |
| `__INDEPVARS__` | 自变量列表 | 空格分隔变量 | ✓ 是 | `size lev growth` |
| `__CLUSTER_VAR__` | 聚类变量 | 单变量名 | ✓ 是 | `stkcd` |

### 渲染规则

```python
# Python 渲染示例
config = {
    "dep_var": "roa",
    "indep_vars": ["size", "lev", "growth", "soe"],
    "cluster_var": "stkcd"
}

placeholders = {
    "__DEPVAR__": config["dep_var"],
    "__INDEPVARS__": " ".join(config["indep_vars"]),
    "__CLUSTER_VAR__": config["cluster_var"]
}
```

## Stata 执行流程

```
┌─────────────────────────────────────────────────────────────┐
│ SECTION 0: 环境初始化与数据导入                             │
├─────────────────────────────────────────────────────────────┤
│ SECTION 1: 变量与聚类结构检查                               │
├─────────────────────────────────────────────────────────────┤
│ SECTION 2: 普通 OLS 回归（对比基准）                        │
├─────────────────────────────────────────────────────────────┤
│ SECTION 3: 稳健标准误 OLS（对比）                           │
├─────────────────────────────────────────────────────────────┤
│ SECTION 4: 聚类稳健标准误 OLS                               │
├─────────────────────────────────────────────────────────────┤
│ SECTION 5: 三种标准误对比                                   │
├─────────────────────────────────────────────────────────────┤
│ SECTION 6: 组内相关系数（ICC）                              │
├─────────────────────────────────────────────────────────────┤
│ SECTION 7: 导出结果文件                                     │
└─────────────────────────────────────────────────────────────┘
```

## 输出文件清单与 Schema

### 0. result.log

任务执行日志，包含聚类结构统计、三种SE对比、ICC分析、回归结果和警告信息。

### 1. table_T20_reg_cluster.csv

聚类回归系数表。

| 列名 | 类型 | 说明 |
|------|------|------|
| `variable` | string | 变量名 |
| `coef` | float | 回归系数 |
| `cluster_se` | float | 聚类标准误 |
| `t` | float | t统计量 |
| `p` | float | p值 |
| `sig` | string | 显著性标记 |

### 2. table_T20_se_comparison.csv

三种标准误对比表。

| 列名 | 类型 | 说明 |
|------|------|------|
| `variable` | string | 变量名 |
| `se_ols` | float | OLS标准误 |
| `se_robust` | float | 稳健标准误 |
| `se_cluster` | float | 聚类标准误 |
| `ratio_cluster_ols` | float | 比率（cluster/ols） |

## 上层 JSON 配置示例

### 示例 1：公司面板数据

```json
{
  "task_id": "T20_ols_cluster_se",
  "description": "检验公司特征对ROA的影响（按公司聚类）",
  "dep_var": "roa",
  "indep_vars": ["size", "lev", "growth", "soe", "age"],
  "cluster_var": "stkcd"
}
```

**场景说明**：公司-年份面板数据，按公司ID聚类处理组内相关。

### 示例 2：地区聚类

```json
{
  "task_id": "T20_ols_cluster_se",
  "description": "检验地区特征对投资的影响（按省份聚类）",
  "dep_var": "investment",
  "indep_vars": ["gdp_growth", "policy", "industry"],
  "cluster_var": "province"
}
```

## 报告写作骨架

### 论文正文回归（聚类SE）

```markdown
## X.X 基准回归分析

为检验研究假设，本文构建如下回归模型：

$$ Y_{it} = \beta_0 + \beta_1 X_{it} + \sum_j \gamma_j Control_{jit} + \varepsilon_{it} $$

考虑到同一公司不同年份的观测可能存在相关，本文按公司层面进行聚类，
报告聚类稳健标准误（clustered at firm level）。

表X报告了回归结果。[核心变量]的系数为[β]（t=[t]），在[1%/5%/10%]
水平下显著[为正/为负]。该结果在控制了公司层面聚类相关后依然稳健，
支持研究假设H[X]。

### 表X 基准回归结果
─────────────────────────────────────────────────────────────
                       (1)            (2)
                   OLS SE        Cluster SE
─────────────────────────────────────────────────────────────
X               0.035***        0.035**
               (0.008)         (0.015)
Size            0.012***        0.012***
               (0.002)         (0.004)
Constant        0.125***        0.125***
               (0.015)         (0.025)
─────────────────────────────────────────────────────────────
N               50,000          50,000
R²              0.085           0.085
Clusters          -             2,500
─────────────────────────────────────────────────────────────
注：列（1）为OLS标准误，列（2）为按公司聚类的稳健标准误；
***、**、*分别表示在1%、5%、10%水平下显著。
```

## 常见坑与建议

### 1. 聚类数量太少
- **问题**：<30个聚类导致标准误低估
- **建议**：报告聚类数量，考虑wild bootstrap

### 2. 聚类层级选择错误
- **问题**：选错聚类维度
- **建议**：面板数据通常按个体聚类

### 3. 混淆稳健SE与聚类SE
- **问题**：面板数据使用稳健SE而非聚类SE
- **建议**：面板数据必须使用聚类SE

### 4. 忽略SE比率
- **问题**：不报告SE变化程度
- **建议**：比较OLS/Robust/Cluster SE的差异

### 5. 双向聚类遗漏
- **问题**：公司和年份都需要聚类
- **建议**：考虑双向聚类（需额外命令）

## 双向聚类说明

当存在两个聚类维度时（如公司和年份）：

```stata
* 方法1：使用 reghdfe（需安装）
* ssc install reghdfe
reghdfe y x1 x2, absorb(firm year) vce(cluster firm year)

* 方法2：手动计算
* V_twoway = V_firm + V_year - V_intersection
```

## 与其他任务的关系

| 相关任务 | 关系说明 |
|----------|----------|
| T19_ols_robust_se | 截面数据用稳健SE |
| T18_ols_multiple | 无聚类的基准回归 |
| T30_panel_fe | 面板固定效应+聚类SE |

## 技术说明

- **Stata 版本**：18.0+
- **外部依赖**：无，仅使用 Stata 官方命令
- **关键命令**：`regress, vce(cluster)`, `loneway`
- **退出码**：错误时统一返回 200
