# T45_pca_principal_components — 主成分分析（Principal Component Analysis）

## 任务元信息

| 属性 | 值 |
|------|-----|
| **Task ID** | T45_pca_principal_components |
| **任务名称** | 主成分分析 |
| **任务族** | I - 多变量与无监督学习 |
| **难度级别** | intermediate |
| **数据结构** | cross_sectional |
| **金融场景适用** | ✓ 是 |

## 任务摘要

进行主成分分析（PCA），实现降维和特征提取，输出特征值、载荷和得分。**多变量分析的基础降维方法**。

## 适用场景

### 场景 1：综合指标构建
- **目的**：将多个指标综合为单一指数
- **方法**：提取第一主成分
- **应用**：市场化指数、公司治理指数

### 场景 2：多重共线性处理
- **目的**：解决回归中的共线性问题
- **方法**：用主成分代替原变量
- **应用**：高维特征建模

### 场景 3：探索性分析
- **目的**：发现数据的潜在结构
- **方法**：分析载荷矩阵
- **应用**：变量分组、维度识别

## 理论背景

### 主成分分析原理

将p个相关变量转换为p个不相关的主成分：

$$PC_k = \sum_{j=1}^{p} a_{kj} X_j$$

主成分满足：
1. $Var(PC_1) \geq Var(PC_2) \geq ... \geq Var(PC_p)$
2. $Cov(PC_i, PC_j) = 0$ for $i \neq j$

### 特征值与方差解释

$$\lambda_k = Var(PC_k)$$

方差解释比例：
$$\frac{\lambda_k}{\sum_{j=1}^{p}\lambda_j}$$

### 主成分数量选择

| 准则 | 规则 |
|------|------|
| **Kaiser准则** | 特征值 > 1 |
| **碎石图** | 拐点之前的成分 |
| **累积方差** | 解释80-90%方差 |

### 载荷（Loadings）

原变量与主成分的相关系数：
$$loading_{jk} = corr(X_j, PC_k)$$

## 数据文件要求

### 数据文件
- **首选**：`data.dta`（Stata 格式）
- **备选**：`data.csv`（自动转换为 data.dta）
- **编码**：UTF-8（推荐）

### 变量要求
- 所有输入变量必须为数值型
- 建议无缺失值或预先处理
- 样本量建议至5-10倍于变量数

## 输入与占位符说明

### 占位符列表

| 占位符 | 含义 | 类型 | 必填 | 合法取值示例 |
|--------|------|------|------|-------------|
| `__NUMERIC_VARS__` | 数值变量列表 | 多变量名 | ✓ 是 | `x1 x2 x3 x4 x5` |

## 输出文件清单与 Schema

### 0. result.log

任务执行日志，包含描述统计、相关矩阵、PCA结果、特征值、载荷和结果摘要。

### 1. table_T45_scores.csv

主成分得分表。

| 列名 | 类型 | 说明 |
|------|------|------|
| `pc1` | float | 第一主成分得分 |
| `pc2` | float | 第二主成分得分 |
| `pc3` | float | 第三主成分得分 |

### 2. fig_T45_scree.png

碎石图（PNG格式）。

### 3. fig_T45_pca_scatter.png

PC1-PC2散点图（PNG格式）。

## 上层 JSON 配置示例

```json
{
  "task_id": "T45_pca_principal_components",
  "description": "财务指标综合评价",
  "numeric_vars": ["roa", "roe", "npm", "leverage", "current_ratio"]
}
```

## 报告写作骨架

```markdown
## X.X 主成分分析

为构建[综合指标]，本文对[p]个原始变量进行主成分分析。
表X报告了PCA结果。

根据Kaiser准则（特征值>1）和碎石图，本文提取前[k]个主成分，
累计解释原始变量[%]的方差。第一主成分的特征值为[λ₁]，
解释方差[%]。

从载荷矩阵来看，第一主成分主要由[变量1]（载荷=[l₁]）、
[变量2]（载荷=[l₂]）构成，可解释为[XX能力/XX水平]。

### 表X 主成分分析结果
─────────────────────────────────────────────────────────────
主成分        特征值        方差比例        累积方差
─────────────────────────────────────────────────────────────
PC1           2.85          57.0%           57.0%
PC2           1.23          24.6%           81.6%
PC3           0.52          10.4%           92.0%
─────────────────────────────────────────────────────────────

### 图X 碎石图
[插入 fig_T45_scree.png]

注：水平虚线表示Kaiser准则（特征值=1）。
```

## 常见坑与建议

### 1. 变量量纲不同
- **问题**：量纲差异影响结果
- **建议**：使用相关矩阵（pca默认）

### 2. 过度解读
- **问题**：强行解释所有主成分
- **建议**：只解释主要成分

### 3. 样本量不足
- **问题**：n < p时不稳定
- **建议**：样本量至少5-10倍于变量数

### 4. 离群值影响
- **问题**：PCA对离群值敏感
- **建议**：预先处理极端值

## 与其他任务的关系

| 相关任务 | 关系说明 |
|----------|----------|
| T46_factor_analysis | 因子分析（探索潜变量） |
| T07_descriptive_univariate | 前置描述统计 |

## 技术说明

- **Stata 版本**：18.0+
- **外部依赖**：无，仅使用 Stata 官方命令
- **关键命令**：`pca`, `estat eigenvalues`, `estat loadings`, `screeplot`, `predict, score`
- **退出码**：错误时统一返回 200
