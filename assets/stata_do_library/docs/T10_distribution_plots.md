# T10_distribution_plots — 变量分布可视化

## 任务元信息

| 属性 | 值 |
|------|-----|
| **Task ID** | T10_distribution_plots |
| **任务名称** | 变量分布可视化（直方图/箱线图/核密度/QQ图） |
| **任务族** | B - 描述性统计 |
| **难度级别** | basic |
| **数据结构** | cross_section / panel / time_series（均适用） |
| **金融场景适用** | ✓ 是 |

## 任务摘要

生成数值变量的多种分布可视化图表，包括直方图（含正态曲线）、核密度图、箱线图、正态QQ图，支持分组对比。同时执行正态性检验（Shapiro-Wilk、Skewness/Kurtosis），为后续分析方法选择提供依据。

## 适用场景

### 场景 1：变量分布预检
- **目的**：在回归分析前检查因变量和残差的分布
- **关注点**：是否接近正态分布，是否存在极端异常值
- **后续**：考虑变量变换或稳健估计方法

### 场景 2：异常值识别
- **目的**：通过箱线图发现潜在异常值
- **关注点**：箱线图外的离群点
- **后续**：决定是否 Winsorize 或剔除

### 场景 3：分组分布对比
- **目的**：比较不同组别的变量分布差异
- **关注点**：组间均值、方差和分布形态的差异
- **后续**：进行t检验或非参数检验

### 场景 4：论文图表
- **目的**：生成可用于论文的专业图表
- **要求**：清晰的标题、坐标轴标签和注释

## 理论背景

### 正态性检验方法

| 方法 | 适用样本量 | 检验假设 | 优缺点 |
|------|------------|----------|--------|
| Shapiro-Wilk | N ≤ 2000 | H0: 数据来自正态总体 | 最强大的正态性检验 |
| Skewness/Kurtosis | 任意 | H0: 偏度=0 且 峰度=3 | 适用于大样本 |
| QQ图 | 任意 | 视觉判断 | 直观但主观 |

### 分布特征诊断标准

| 指标 | 标准 | 判断 |
|------|------|------|
| 偏度 | \|S\| ≤ 0.5 | 基本对称 |
| 偏度 | 0.5 < \|S\| ≤ 1 | 中等偏斜 |
| 偏度 | \|S\| > 1 | 严重偏斜 |
| 峰度 | 2 ≤ K ≤ 4 | 接近正态 |
| 峰度 | K > 4 | 尖峰厚尾 |

### 金融数据的典型分布特征
- **收益率**：通常呈尖峰厚尾（峰度 > 3）
- **公司规模**：通常右偏，需取对数
- **财务比率**：可能有极端值，需Winsorize

## 输入与占位符说明

### 占位符列表

| 占位符 | 含义 | 类型 | 必填 | 合法取值示例 |
|--------|------|------|------|-------------|
| `__NUMERIC_VAR__` | 分析变量 | 单变量名 | ✓ 是 | `roa` |
| `__GROUP_VAR__` | 分组变量 | 单变量名 | 否 | `ownership` |

### 渲染规则

```python
# Python 渲染示例
config = {
    "numeric_var": "roa",
    "group_var": "ownership"  # 可选
}

placeholders = {
    "__NUMERIC_VAR__": config["numeric_var"],
    "__GROUP_VAR__": config.get("group_var", "")
}
```

## Stata 执行流程

```
┌─────────────────────────────────────────────────────────────┐
│ SECTION 0: 环境初始化与数据导入                             │
├─────────────────────────────────────────────────────────────┤
│ SECTION 1: 变量检查                                         │
├─────────────────────────────────────────────────────────────┤
│ SECTION 2: 分布统计摘要                                     │
│   - 详细描述统计                                            │
│   - 偏度/峰度诊断                                           │
├─────────────────────────────────────────────────────────────┤
│ SECTION 3: 正态性检验                                       │
│   - Shapiro-Wilk (N ≤ 2000)                                │
│   - Skewness/Kurtosis 检验                                 │
├─────────────────────────────────────────────────────────────┤
│ SECTION 4: 生成分布图                                       │
│   - 直方图（含正态曲线）                                    │
│   - 核密度图                                                │
│   - 箱线图                                                  │
│   - QQ图                                                    │
├─────────────────────────────────────────────────────────────┤
│ SECTION 5: 分组分布图（可选）                               │
│   - 分组箱线图                                              │
│   - 分组核密度图                                            │
├─────────────────────────────────────────────────────────────┤
│ SECTION 6: 导出结果文件                                     │
├─────────────────────────────────────────────────────────────┤
│ SECTION 7: 任务完成摘要                                     │
└─────────────────────────────────────────────────────────────┘
```

## 输出文件清单与 Schema

### 0. result.log

任务执行日志，包含分布统计、正态性检验结果和警告信息。

### 1. 图表文件

| 文件 | 说明 |
|------|------|
| `fig_T10_histogram.png` | 直方图（叠加正态曲线） |
| `fig_T10_kdensity.png` | 核密度估计图 |
| `fig_T10_boxplot.png` | 箱线图 |
| `fig_T10_qqplot.png` | 正态Q-Q图 |
| `fig_T10_boxplot_grouped.png` | 分组箱线图（如指定分组变量） |
| `fig_T10_kdensity_grouped.png` | 分组核密度图（如指定分组变量） |

### 2. table_T10_normality_test.csv

正态性检验结果。

| 列名 | 类型 | 说明 |
|------|------|------|
| `variable` | string | 变量名 |
| `n` | integer | 样本量 |
| `mean` | float | 均值 |
| `sd` | float | 标准差 |
| `skewness` | float | 偏度 |
| `kurtosis` | float | 峰度 |
| `sw_W` | float | Shapiro-Wilk W统计量 |
| `sw_p` | float | Shapiro-Wilk p值 |
| `sk_chi2` | float | Skewness/Kurtosis卡方统计量 |
| `sk_p` | float | Skewness/Kurtosis联合检验p值 |

## 上层 JSON 配置示例

### 示例 1：收益率分布检验

```json
{
  "task_id": "T10_distribution_plots",
  "description": "检查ROA的分布特征",
  "numeric_var": "roa"
}
```

**场景说明**：检查因变量ROA的分布，判断是否需要变换。

### 示例 2：分组分布对比

```json
{
  "task_id": "T10_distribution_plots",
  "description": "对比国企与民企的ROA分布",
  "numeric_var": "roa",
  "group_var": "ownership"
}
```

**场景说明**：通过分组图表直观对比不同产权性质企业的绩效分布。

## 图表解读指南

### 直方图解读
- **正态曲线贴合**：数据接近正态分布
- **右偏**：数据集中在左侧，右侧有长尾
- **左偏**：数据集中在右侧，左侧有长尾
- **双峰**：可能存在分组效应

### 箱线图解读
- **箱体**：四分位距 (IQR = Q3 - Q1)
- **中线**：中位数
- **触须**：Q1 - 1.5×IQR 到 Q3 + 1.5×IQR
- **圆点**：异常值（超出触须范围）

### QQ图解读
- **点沿对角线**：接近正态分布
- **上端向上弯曲**：右偏
- **下端向下弯曲**：左偏
- **两端都偏离**：厚尾分布

## 报告写作骨架

### 论文"变量分布"章节结构

```markdown
## X.X 变量分布检验

图X展示了因变量[Y]的分布特征。从直方图可以看出，[Y]呈[右偏/左偏/近似对称]
分布，偏度为[值]，峰度为[值]，表现出[尖峰厚尾/平峰薄尾/近似正态]特征。

Shapiro-Wilk正态性检验结果显示，W=[值]，p=[值]，[拒绝/不能拒绝]正态性假设。
考虑到金融数据的典型特征，本文采用[稳健标准误/变量对数变换/Winsorize处理]
以应对非正态分布问题。

### 图X [Y]的分布特征
[插入直方图/箱线图]
```

## 常见坑与建议

### 1. 样本量太大无法用Shapiro-Wilk
- **问题**：N > 2000 时无法执行
- **建议**：使用Skewness/Kurtosis检验或QQ图

### 2. 大样本必然拒绝正态性
- **问题**：大样本时微小偏离也会显著
- **建议**：结合图形判断实际偏离程度

### 3. 极端值影响直方图
- **问题**：极端值压缩了图形主体
- **建议**：先Winsorize再绘图，或限制x轴范围

### 4. 分组过多
- **问题**：分组数 > 6 时图形混乱
- **建议**：合并小组或只展示主要组别

### 5. 核密度带宽选择
- **问题**：默认带宽可能不合适
- **建议**：一般使用默认值即可，特殊需求可调整

## 与其他任务的关系

| 相关任务 | 关系说明 |
|----------|----------|
| T07_summary_numeric | 分布图是描述统计的可视化补充 |
| T17-T24 回归分析 | 残差分布检验需要类似图表 |
| T13_ttest | 分组箱线图辅助理解t检验结果 |
| T02_desc_by_group | 分组分布对比 |

## 技术说明

- **Stata 版本**：18.0+
- **外部依赖**：无，仅使用 Stata 官方命令
- **关键命令**：`histogram`, `kdensity`, `graph box`, `qnorm`, `swilk`, `sktest`
