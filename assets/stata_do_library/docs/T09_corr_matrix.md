# T09_corr_matrix — 相关系数矩阵（Pearson与Spearman）

## 任务元信息

| 属性 | 值 |
|------|-----|
| **Task ID** | T09_corr_matrix |
| **任务名称** | 相关系数矩阵（Pearson与Spearman） |
| **任务族** | B - 描述性统计 |
| **难度级别** | basic |
| **数据结构** | cross_section / panel / time_series（均适用） |
| **金融场景适用** | ✓ 是 |

## 任务摘要

计算变量间的Pearson和Spearman相关系数矩阵，包含显著性检验，自动识别高度相关变量对（潜在多重共线性风险），输出论文标准格式的相关系数表（表2）。

## 适用场景

### 场景 1：回归前的变量相关性检查
- **目的**：识别解释变量间的多重共线性风险
- **关注点**：自变量间相关系数 > 0.7 时需警惕
- **后续**：VIF检验、变量剔除或主成分分析

### 场景 2：论文表2 - 相关系数矩阵
- **目的**：展示主要变量间的两两相关性
- **格式**：下三角Pearson，上三角Spearman
- **显著性**：标注星号

### 场景 3：因变量与自变量的初步关系
- **目的**：预览回归分析可能的结果
- **关注点**：因变量与主要解释变量的相关系数符号和显著性
- **局限**：相关不等于因果

### 场景 4：数据降维预判断
- **目的**：判断是否适合做因子分析或PCA
- **关注点**：变量间是否存在足够的相关性
- **参考**：KMO检验通常要求 > 0.6

## 理论背景

### Pearson vs Spearman 相关系数

| 特征 | Pearson | Spearman |
|------|---------|----------|
| 适用数据 | 连续变量 | 连续/有序变量 |
| 假设条件 | 线性关系、正态分布 | 单调关系即可 |
| 对异常值 | 敏感 | 稳健 |
| 计算方式 | 协方差标准化 | 秩次相关 |
| 适用场景 | 正态数据 | 非正态、有序数据 |

### 相关系数强度判断

| |r| 范围 | 相关强度 | 多重共线性风险 |
|----------|----------|----------|
| [0.8, 1.0] | 强相关 | 高风险，需处理 |
| [0.6, 0.8) | 较强相关 | 中等风险，需关注 |
| [0.4, 0.6) | 中等相关 | 低风险 |
| [0.2, 0.4) | 弱相关 | 无风险 |
| [0.0, 0.2) | 很弱/无相关 | 无风险 |

### 显著性检验

- **H0**：总体相关系数 ρ = 0
- **H1**：总体相关系数 ρ ≠ 0
- **检验统计量**：t = r × √(n-2) / √(1-r²)
- **论文惯例**：* p<0.1, ** p<0.05, *** p<0.01

## 输入与占位符说明

### 占位符列表

| 占位符 | 含义 | 类型 | 必填 | 合法取值示例 |
|--------|------|------|------|-------------|
| `__NUMERIC_VARS__` | 数值变量列表 | 多变量名（空格分隔） | ✓ 是 | `roa roe size leverage growth` |

### 渲染规则

```python
# Python 渲染示例
config = {
    "numeric_vars": ["roa", "roe", "size", "leverage", "growth", "age"]
}

placeholders = {
    "__NUMERIC_VARS__": " ".join(config["numeric_vars"])
}
```

## 数据要求与前置条件

### 数据文件
- **首选**：`data.dta`（Stata 格式）
- **备选**：`data.csv`（自动转换为 data.dta）
- **编码**：UTF-8（推荐）

### 变量要求
| 要求 | 说明 | 不满足时的后果 |
|------|------|---------------|
| 变量存在 | 指定变量必须在数据中 | 该变量被跳过 |
| 数值类型 | 变量必须是数值型 | 该变量被跳过 |
| 足够观测 | 建议 N > 30 | 显著性检验不可靠 |

## Stata 执行流程

```
┌─────────────────────────────────────────────────────────────┐
│ SECTION 0: 环境初始化与数据导入                             │
├─────────────────────────────────────────────────────────────┤
│ SECTION 1: 变量检查                                         │
├─────────────────────────────────────────────────────────────┤
│ SECTION 2: Pearson相关系数矩阵                              │
│   - pwcorr 含显著性星号                                     │
├─────────────────────────────────────────────────────────────┤
│ SECTION 3: Spearman秩相关系数                               │
│   - spearman 稳健估计                                       │
├─────────────────────────────────────────────────────────────┤
│ SECTION 4: 高度相关变量识别                                 │
│   - |r| ≥ 0.8 警告                                         │
│   - 多重共线性风险提示                                      │
├─────────────────────────────────────────────────────────────┤
│ SECTION 5: 相关系数解释参考                                 │
├─────────────────────────────────────────────────────────────┤
│ SECTION 6: 导出结果文件                                     │
│   - table_T09_corr_pearson.csv                             │
│   - table_T09_corr_spearman.csv                            │
│   - table_T09_corr_pairwise.csv                            │
├─────────────────────────────────────────────────────────────┤
│ SECTION 7: 任务完成摘要                                     │
└─────────────────────────────────────────────────────────────┘
```

## 输出文件清单与 Schema

### 0. result.log

任务执行日志，包含相关系数输出、高度相关警告和多重共线性风险提示。

### 1. table_T09_corr_pearson.csv

Pearson相关系数矩阵。

| 列名 | 类型 | 说明 |
|------|------|------|
| `variable` | string | 行变量名 |
| `var1, var2, ...` | float | 与各列变量的Pearson相关系数 |

### 2. table_T09_corr_spearman.csv

Spearman秩相关系数矩阵，结构同上。

### 3. table_T09_corr_pairwise.csv

两两相关详情表。

| 列名 | 类型 | 说明 |
|------|------|------|
| `var1` | string | 变量1 |
| `var2` | string | 变量2 |
| `pearson_r` | float | Pearson相关系数 |
| `pearson_p` | float | p值 |
| `n_obs` | integer | 观测数 |

## 上层 JSON 配置示例

### 示例 1：回归变量相关性检查

```json
{
  "task_id": "T09_corr_matrix",
  "description": "检查回归模型变量间的相关性",
  "numeric_vars": ["roa", "size", "leverage", "growth", "age", "cash", "tangible"]
}
```

**场景说明**：在运行回归前，检查自变量间是否存在多重共线性风险。

### 示例 2：论文表2生成

```json
{
  "task_id": "T09_corr_matrix",
  "description": "生成论文相关系数表",
  "numeric_vars": ["y", "x1", "x2", "control1", "control2", "control3"]
}
```

**场景说明**：生成论文表2，展示主要变量的两两相关性。

## 报告写作骨架

### 论文"相关性分析"章节结构

```markdown
## X.X 相关性分析

表2报告了主要变量的Pearson相关系数（下三角）和Spearman相关系数（上三角）。
从表中可以看出：

（1）因变量[Y]与主要解释变量[X]呈显著[正/负]相关（r=[值]，p<0.01），
初步支持了本文的研究假设。

（2）解释变量之间的相关系数大多低于0.7，表明变量间不存在严重的
多重共线性问题。后续我们将通过VIF检验进一步确认（见表X）。

（3）[控制变量]与因变量的相关性与预期一致，如公司规模（Size）与
绩效呈显著正相关，符合规模效应的一般规律。

### 表2 相关系数矩阵
─────────────────────────────────────────────────────────────────
         (1)      (2)      (3)      (4)      (5)      (6)
─────────────────────────────────────────────────────────────────
(1) ROA   1.000   0.652*** 0.123*** 0.234*** -0.156** 0.089*
(2) ROE   0.678***  1.000   0.145*** 0.267*** -0.189*** 0.102**
(3) Size  0.134*** 0.156***  1.000   0.456*** 0.234*** 0.345***
(4) Lev   0.245*** 0.278*** 0.467***  1.000   -0.123** 0.156***
(5) Growth-0.167** -0.198*** 0.245*** -0.134**  1.000   0.078
(6) Age   0.092*   0.108**  0.356*** 0.167*** 0.089    1.000
─────────────────────────────────────────────────────────────────
注：下三角为Pearson相关系数，上三角为Spearman相关系数。
    * p<0.1, ** p<0.05, *** p<0.01
```

## 常见坑与建议

### 1. 高度相关导致多重共线性
- **问题**：两个解释变量相关系数 > 0.8
- **建议**：剔除一个变量，或做主成分分析

### 2. 相关系数与样本量
- **问题**：小样本时相关系数不稳定
- **建议**：N > 30 时 Pearson 检验较可靠

### 3. 非线性关系
- **问题**：Pearson 只捕捉线性关系
- **建议**：绘制散点图，或使用 Spearman

### 4. 异常值影响
- **问题**：极端值会严重影响 Pearson 相关系数
- **建议**：先做 Winsorize，或使用 Spearman

### 5. 缺失值处理
- **问题**：不同变量对的 N 不同
- **建议**：关注 pairwise 表中的 n_obs

### 6. 虚假相关
- **问题**：存在第三变量导致的虚假相关
- **建议**：回归分析中控制混杂变量

### 7. 相关不等于因果
- **问题**：相关系数不能证明因果关系
- **建议**：在论文中谨慎措辞，用"相关"而非"影响"

## 与其他任务的关系

| 相关任务 | 关系说明 |
|----------|----------|
| T07_summary_numeric | 相关性分析前先做描述统计 |
| T17-T24 回归分析 | 回归前检查多重共线性 |
| T21_vif_multicollinearity | 进一步的VIF诊断 |
| T45_pca | 高相关变量可考虑主成分分析 |

## 技术说明

- **Stata 版本**：18.0+
- **外部依赖**：无，仅使用 Stata 官方命令
- **关键命令**：`correlate`, `pwcorr`, `spearman`
