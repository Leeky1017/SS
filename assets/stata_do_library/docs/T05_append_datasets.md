# T05_append_datasets — 数据集追加（纵向合并）

## 任务元信息

| 属性 | 值 |
|------|-----|
| **Task ID** | T05_append_datasets |
| **任务名称** | 数据集追加（纵向合并） |
| **任务族** | A - 数据管理与预处理 |
| **难度级别** | basic |
| **数据结构** | panel / time_series（最常用） |
| **金融场景适用** | ✓ 是 |

## 任务摘要

将多个数据集纵向追加合并（如合并多年份或多期数据），检查变量结构一致性，生成数据来源标记，检测因变量差异产生的缺失值问题，验证主键唯一性以避免重复记录。

## 适用场景

### 场景 1：合并多年份财务数据
- **数据来源**：各年度单独下载的上市公司财务报表
- **数据文件**：data_2019.csv, data_2020.csv, data_2021.csv, ...
- **目的**：构建多年面板数据用于实证研究

### 场景 2：合并多季度交易数据
- **数据来源**：按季度导出的股票交易数据
- **数据文件**：data_Q1.csv, data_Q2.csv, data_Q3.csv, data_Q4.csv
- **目的**：形成完整年度的日交易记录

### 场景 3：合并多数据源的同类数据
- **数据来源**：不同数据库的同类数据（如 CSMAR + Wind）
- **数据文件**：data_csmar.csv, data_wind.csv
- **目的**：扩大样本覆盖范围，交叉验证

### 场景 4：合并多批次调查数据
- **数据来源**：分批次进行的问卷调查
- **数据文件**：survey_batch1.csv, survey_batch2.csv
- **目的**：汇总多批次样本

## 理论背景

### 纵向合并 vs 横向合并

| 类型 | 命令 | 作用 | 结果 |
|------|------|------|------|
| 纵向合并 (append) | `append` | 追加观测（行） | 样本量增加 |
| 横向合并 (merge) | `merge` | 添加变量（列） | 变量数增加 |

### 面板数据的构建
纵向合并是构建面板数据的常用方法：
1. 从数据库按年份单独下载数据
2. 使用 append 合并为长面板
3. 用 xtset 声明面板结构

### 变量一致性的重要性
- **变量名一致**：Stata 按变量名匹配
- **变量类型一致**：数值 vs 字符串不能混合
- **变量含义一致**：确保同名变量定义相同

## 输入与占位符说明

### 占位符列表

| 占位符 | 含义 | 类型 | 必填 | 合法取值示例 |
|--------|------|------|------|-------------|
| `__ID_VAR__` | 个体标识变量 | 单变量名 | 否 | `stkcd` |
| `__TIME_VAR__` | 时间标识变量 | 单变量名 | 否 | `year` |

### 渲染规则

```python
# Python 渲染示例
config = {
    "id_var": "stkcd",
    "time_var": "year"
}

placeholders = {
    "__ID_VAR__": config.get("id_var", ""),
    "__TIME_VAR__": config.get("time_var", "")
}
```

### 数据文件命名
- **主数据集**：`data.csv`
- **追加数据集**：`data_append.csv`

如需追加多个数据集，可多次调用本任务或修改模板。

## 数据要求与前置条件

### 数据文件
- **data.csv**：主数据集（通常是较早时期）
- **data_append.csv**：追加数据集（通常是较晚时期）

### 变量要求
| 要求 | 说明 | 不满足时的后果 |
|------|------|---------------|
| 核心变量名一致 | 关键变量应同名 | 无法正确对齐 |
| 变量类型一致 | 同名变量类型相同 | 可能合并失败或产生缺失 |
| 时间标识不重叠 | 避免同一 ID 同一时间重复 | 产生重复记录 |

## Stata 执行流程

```
┌─────────────────────────────────────────────────────────────┐
│ SECTION 0: 环境初始化                                       │
├─────────────────────────────────────────────────────────────┤
│ SECTION 1: 导入追加数据集                                   │
│   - 记录样本量和变量                                        │
│   - 生成来源标记 _source=2                                  │
├─────────────────────────────────────────────────────────────┤
│ SECTION 2: 导入主数据集                                     │
│   - 记录样本量和变量                                        │
│   - 生成来源标记 _source=1                                  │
├─────────────────────────────────────────────────────────────┤
│ SECTION 3: 变量结构一致性检查                               │
│   - 对比变量数量                                            │
│   - 识别共同变量和差异变量                                  │
├─────────────────────────────────────────────────────────────┤
│ SECTION 4: 执行纵向合并                                     │
│   - append using ..., force                                │
│   - 验证样本量                                              │
├─────────────────────────────────────────────────────────────┤
│ SECTION 5: 合并结果诊断                                     │
│   - 数据来源分布                                            │
│   - 各变量有效率检查                                        │
├─────────────────────────────────────────────────────────────┤
│ SECTION 6: 主键唯一性检查                                   │
│   - 检测重复记录                                            │
├─────────────────────────────────────────────────────────────┤
│ SECTION 7: 时间覆盖检查                                     │
│   - 合并后时间范围                                          │
│   - 各时期样本分布                                          │
├─────────────────────────────────────────────────────────────┤
│ SECTION 8: 导出结果文件                                     │
│   - table_T05_append_report.csv                            │
│   - appended_data.csv / .dta                               │
├─────────────────────────────────────────────────────────────┤
│ SECTION 9: 任务完成摘要                                     │
└─────────────────────────────────────────────────────────────┘
```

## 输出文件清单与 Schema

### 0. result.log

任务执行日志，记录变量一致性检查、主键检查、警告信息。

### 1. table_T05_append_report.csv

追加诊断报告。

| 列名 | 类型 | 说明 |
|------|------|------|
| `item` | string | 指标名称 |
| `value` | string | 指标值 |

**包含指标**：主数据集样本量、追加数据集样本量、合并后总样本量、共同变量数、差异变量数

### 2. appended_data.csv / appended_data.dta

追加后的数据集，包含：
- 两个数据集的所有观测
- 所有变量（缺失的部分显示为 missing）
- `_source`：数据来源标记（1=主数据集, 2=追加数据集）

## 上层 JSON 配置示例

### 示例 1：合并多年份财务数据

```json
{
  "task_id": "T05_append_datasets",
  "description": "合并2019-2020年上市公司财务数据",
  "id_var": "stkcd",
  "time_var": "year"
}
```

**场景说明**：将2019年和2020年的财务数据纵向合并，形成两年的面板数据。

### 示例 2：合并多季度交易数据

```json
{
  "task_id": "T05_append_datasets",
  "description": "合并2020年各季度股票交易数据",
  "id_var": "stkcd",
  "time_var": "date"
}
```

**场景说明**：将按季度下载的日交易数据合并为全年数据。

## 报告写作骨架

### 论文"数据来源"章节结构

```markdown
## X.X 数据来源

本文样本期间为 [起始年份] 至 [结束年份]。由于数据库导出限制，
我们分年度下载数据后进行纵向合并，共获得 [N] 个公司-年度观测值。

合并过程中，我们检查了各年度数据的变量一致性：
- [年份1] 数据包含 [n1] 条观测，[k1] 个变量
- [年份2] 数据包含 [n2] 条观测，[k2] 个变量
- 合并后共 [N_total] 条观测

各年度数据的变量结构保持一致，未出现因变量缺失导致的数据损失。
```

## 常见坑与建议

### 1. 变量名不一致
- **问题**：2019年数据用 `ROA`，2020年用 `roa`
- **建议**：合并前用 `rename *, lower` 统一为小写

### 2. 变量类型不一致
- **问题**：股票代码在一个文件是字符串，另一个是数值
- **建议**：统一用 `tostring` 或 `destring` 转换

### 3. 时间范围重叠
- **问题**：两个数据集包含同一年份的数据
- **建议**：合并后检查主键唯一性，发现重复需排查来源

### 4. 变量结构差异
- **问题**：新年份数据包含新变量，旧年份没有
- **建议**：正常现象，合并后该变量在旧年份为缺失

### 5. 数据顺序混乱
- **问题**：合并后数据不按时间顺序排列
- **建议**：合并后 `sort __ID_VAR__ __TIME_VAR__`

### 6. 编码不一致
- **问题**：不同年份的分类变量编码不同（如行业代码变更）
- **建议**：检查分类变量的取值范围，必要时重新编码

### 7. 样本量验证失败
- **问题**：合并后样本量不等于两个数据集之和
- **建议**：Stata 的 append 不会丢失观测，检查是否有其他操作

### 8. 数据来源丢失
- **问题**：合并后无法区分数据来自哪个文件
- **建议**：使用本任务自动生成的 `_source` 变量

## 与其他任务的关系

| 相关任务 | 关系说明 |
|----------|----------|
| T04_merge_datasets | 横向合并（添加变量） |
| T01_desc_overview | 合并后检查数据质量 |
| T30_panel_setup | 合并后声明面板结构 |
| T03_filter_and_sample | 合并后筛选样本 |

## 技术说明

- **Stata 版本**：18.0+
- **外部依赖**：无，仅使用 Stata 官方命令
- **关键命令**：`append`, `duplicates report`, `tabulate`, `describe`
