# T34_diff_in_diff_2x2 — 经典2×2双重差分（Difference-in-Differences）

## 任务元信息

| 属性 | 值 |
|------|-----|
| **Task ID** | T34_diff_in_diff_2x2 |
| **任务名称** | 经典2×2双重差分 |
| **任务族** | F - 面板数据与政策评估 |
| **难度级别** | intermediate |
| **数据结构** | panel / cross_section |
| **金融场景适用** | ✓ 是 |

## 任务摘要

估计经典双重差分（DID）模型，评估政策的平均处理效应（ATT）。适用于准自然实验的因果推断。**会计与金融政策评估研究的核心方法**。

## 适用场景

### 场景 1：会计准则变更
- **处理组**：受新准则影响的公司
- **控制组**：不受影响的公司
- **政策**：准则实施日期
- **应用**：准则效果评估

### 场景 2：监管政策
- **处理组**：受监管的行业
- **控制组**：未受监管的行业
- **政策**：监管政策出台
- **应用**：监管效果研究

### 场景 3：公司事件
- **处理组**：发生事件的公司
- **控制组**：未发生事件的公司
- **事件**：并购、重组、违规等
- **应用**：事件影响分析

## 理论背景

### DID模型设定

$$Y_{it} = \beta_0 + \beta_1 \cdot Treat_i + \beta_2 \cdot Post_t + \beta_3 \cdot (Treat_i \times Post_t) + X_{it}'\gamma + \varepsilon_{it}$$

- $\beta_3$：**DID估计量**（核心关注）
- $\beta_1$：处理组与控制组的固定差异
- $\beta_2$：政策前后的共同趋势

### 2×2分解

|  | 政策前 | 政策后 | 差异 |
|--|--------|--------|------|
| **处理组** | $Y_{10}$ | $Y_{11}$ | $Y_{11}-Y_{10}$ |
| **控制组** | $Y_{00}$ | $Y_{01}$ | $Y_{01}-Y_{00}$ |
| **组间差** | | | **DID** |

$$ATT = (Y_{11} - Y_{10}) - (Y_{01} - Y_{00}) = \beta_3$$

### 识别假设

| 假设 | 含义 | 检验方法 |
|------|------|----------|
| **平行趋势** | 无政策时两组趋势相同 | 事件研究图 |
| **无预期效应** | 政策前处理组无反应 | 检验政策前系数 |
| **SUTVA** | 无溢出效应 | 理论论证 |

## 数据文件要求

### 数据文件
- **首选**：`data.dta`（Stata 格式）
- **备选**：`data.csv`（自动转换为 data.dta）
- **编码**：UTF-8（推荐）

### 变量要求
- 处理组指示变量：0/1
- 政策时期指示变量：0/1
- 因变量为数值型

## 输入与占位符说明

### 占位符列表

| 占位符 | 含义 | 类型 | 必填 | 合法取值示例 |
|--------|------|------|------|-------------|
| `__DEP_VAR__` | 因变量 | 单变量名 | ✓ 是 | `roa` |
| `__TREAT_VAR__` | 处理组指示（0/1） | 单变量名 | ✓ 是 | `treated` |
| `__POST_VAR__` | 政策后指示（0/1） | 单变量名 | ✓ 是 | `post` |
| `__CONTROL_VARS__` | 控制变量 | 空格分隔变量 | ✓ 是 | `size lev age` |

## 输出文件清单与 Schema

### 0. result.log

任务执行日志，包含2×2分组统计、各组均值、DID分解、回归结果和结果摘要。

### 1. table_T34_did_coef.csv

DID估计结果表。

| 列名 | 类型 | 说明 |
|------|------|------|
| `did_estimate` | float | DID估计量 |
| `did_se` | float | 标准误 |
| `did_t` | float | t统计量 |
| `did_p` | float | p值 |
| `r2` | float | R² |
| `n` | int | 样本量 |

### 2. fig_T34_did_trend.png

处理组与控制组趋势对比图（PNG格式）。

## 上层 JSON 配置示例

```json
{
  "task_id": "T34_diff_in_diff_2x2",
  "description": "新会计准则实施效果评估",
  "dep_var": "earnings_quality",
  "treat_var": "affected",
  "post_var": "post_ifrs",
  "control_vars": ["size", "lev", "roa", "growth"]
}
```

## 报告写作骨架

```markdown
## X.X 双重差分分析

本文采用双重差分（DID）方法评估[政策名称]的效果：

$$ Y_{it} = \beta_0 + \beta_1 Treat_i + \beta_2 Post_t + \beta_3 (Treat_i \times Post_t) + X_{it}'\gamma + \varepsilon_{it} $$

其中，Treat为处理组指示变量，Post为政策后时期指示变量，
交互项系数$\beta_3$为我们关注的DID估计量，衡量政策的平均处理效应（ATT）。

表X报告了DID回归结果。DID估计量为[β₃]（t=[t]），
在[1%/5%/10%]水平下显著[为正/为负]，表明[政策名称]
[提高/降低]了[因变量][β₃个单位 / β₃*100%]。

### 表X 双重差分回归结果
─────────────────────────────────────────────────────────────
                   (1)无控制       (2)含控制
─────────────────────────────────────────────────────────────
Treat×Post      0.050***        0.045***
               (0.015)         (0.012)
Treat           0.020           0.015
               (0.018)         (0.015)
Post            0.030**         0.025**
               (0.012)         (0.010)
─────────────────────────────────────────────────────────────
控制变量           No              Yes
N               10,000          10,000
R²               0.05            0.12
─────────────────────────────────────────────────────────────
注：括号内为稳健标准误；***、**、*分别表示在1%、5%、10%水平下显著。
```

## 常见坑与建议

### 1. 未检验平行趋势
- **问题**：直接报告DID结果
- **建议**：使用T35事件研究图检验

### 2. 错误的标准误
- **问题**：使用普通标准误
- **建议**：使用聚类标准误（按个体）

### 3. 处理时点不同
- **问题**：公司处理时点不同
- **建议**：使用多期DID（staggered DID）

### 4. 时变混杂
- **问题**：存在时变遗漏变量
- **建议**：加入控制变量或使用PSM-DID

## 与其他任务的关系

| 相关任务 | 关系说明 |
|----------|----------|
| T35_diff_in_diff_event_study | 事件研究图检验平行趋势 |
| T31_panel_fe_basic | 固定效应控制 |

## 技术说明

- **Stata 版本**：18.0+
- **外部依赖**：无，仅使用 Stata 官方命令
- **关键命令**：`regress`, `table`, `tabulate`, `vce(robust)`
- **退出码**：错误时统一返回 200
