# T12_ttest_one_sample — 单样本t检验

## 任务元信息

| 属性 | 值 |
|------|-----|
| **Task ID** | T12_ttest_one_sample |
| **任务名称** | 单样本t检验 |
| **任务族** | C - 假设检验 |
| **难度级别** | basic |
| **数据结构** | cross_section / panel / time_series（均适用） |
| **金融场景适用** | ✓ 是 |

## 任务摘要

检验单个数值变量的总体均值是否等于指定的理论值或基准值。包含正态性检验、置信区间、效应量（Cohen's d）计算和详细的结果解读，输出论文可用的检验结果表。

## 适用场景

### 场景 1：收益率是否显著异于零
- **变量**：超额收益率（CAR）
- **原假设**：H0: μ = 0（超额收益率为零）
- **应用**：事件研究中检验累积异常收益是否显著

### 场景 2：财务指标是否达标
- **变量**：资产负债率（leverage）
- **原假设**：H0: μ = 0.5（行业平均值）
- **应用**：检验样本企业杠杆是否偏离行业基准

### 场景 3：增长率是否显著为正
- **变量**：营业收入增长率（growth）
- **原假设**：H0: μ = 0（零增长）
- **应用**：检验样本企业是否实现正增长

### 场景 4：效率指标与理论值比较
- **变量**：市场效率指标
- **原假设**：H0: μ = 1（有效市场假说）
- **应用**：检验市场是否偏离有效状态

## 理论背景

### 单样本t检验原理

**检验统计量**：
$$t = \frac{\bar{X} - \mu_0}{s / \sqrt{n}}$$

其中：
- $\bar{X}$：样本均值
- $\mu_0$：原假设中的理论值
- $s$：样本标准差
- $n$：样本量

**自由度**：df = n - 1

### 假设检验框架

| 假设类型 | 数学表达 | 适用场景 |
|----------|----------|----------|
| 双侧检验 | H1: μ ≠ μ₀ | 检验是否存在差异 |
| 左侧检验 | H1: μ < μ₀ | 检验是否小于基准 |
| 右侧检验 | H1: μ > μ₀ | 检验是否大于基准 |

### 效应量（Cohen's d）

$$d = \frac{\bar{X} - \mu_0}{s}$$

| |d| 范围 | 效应大小 | 实际意义 |
|----------|----------|----------|
| < 0.2 | 小效应 | 差异很小，可能无实际意义 |
| 0.2-0.5 | 小到中效应 | 差异可察觉 |
| 0.5-0.8 | 中效应 | 差异明显 |
| ≥ 0.8 | 大效应 | 差异很大，具有重要实际意义 |

### 前提假设
1. **独立性**：样本观测相互独立
2. **正态性**：总体近似正态分布（大样本时可放宽，N > 30）

## 输入与占位符说明

### 占位符列表

| 占位符 | 含义 | 类型 | 必填 | 合法取值示例 |
|--------|------|------|------|-------------|
| `__TEST_VAR__` | 检验变量 | 单变量名 | ✓ 是 | `car` |
| `__NULL_VALUE__` | 原假设值 | 数值 | ✓ 是 | `0` |

### 渲染规则

```python
# Python 渲染示例
config = {
    "test_var": "car",
    "null_value": 0
}

placeholders = {
    "__TEST_VAR__": config["test_var"],
    "__NULL_VALUE__": str(config["null_value"])
}
```

## 数据要求与前置条件

### 数据文件
- **首选**：`data.dta`（Stata 格式）
- **备选**：`data.csv`（自动转换为 data.dta）

### 变量要求
- 检验变量必须存在且为数值类型
- 原假设值必须为有效数值

## Stata 执行流程

```
┌─────────────────────────────────────────────────────────────┐
│ SECTION 0: 环境初始化与标准化数据加载                         │
├─────────────────────────────────────────────────────────────┤
│ SECTION 1: 变量检查                                         │
├─────────────────────────────────────────────────────────────┤
│ SECTION 2: 描述性统计                                       │
├─────────────────────────────────────────────────────────────┤
│ SECTION 3: 正态性检验                                       │
│   - Shapiro-Wilk 检验                                      │
├─────────────────────────────────────────────────────────────┤
│ SECTION 4: 单样本 t 检验                                    │
│   - 双侧检验                                                │
│   - 单侧检验 p 值                                           │
├─────────────────────────────────────────────────────────────┤
│ SECTION 5: 均值置信区间                                     │
├─────────────────────────────────────────────────────────────┤
│ SECTION 6: 效应量（Cohen's d）                              │
├─────────────────────────────────────────────────────────────┤
│ SECTION 7: 检验结论汇总                                     │
├─────────────────────────────────────────────────────────────┤
│ SECTION 8: 导出结果文件                                     │
└─────────────────────────────────────────────────────────────┘
```

## 输出文件清单与 Schema

### 0. result.log

任务执行日志，包含t检验过程、正态性检验结果、置信区间和效应量输出。

### 1. table_T12_ttest_result.csv

单样本t检验结果汇总表。

| 列名 | 类型 | 说明 |
|------|------|------|
| `test_type` | string | 检验类型（one_sample_ttest） |
| `variable` | string | 检验变量名 |
| `null_value` | float | 原假设值 |
| `n` | integer | 样本量 |
| `mean` | float | 样本均值 |
| `sd` | float | 标准差 |
| `se` | float | 标准误 |
| `t_stat` | float | t统计量 |
| `df` | float | 自由度 |
| `p_two_sided` | float | 双侧p值 |
| `p_left` | float | 左侧p值 |
| `p_right` | float | 右侧p值 |
| `ci_lower` | float | 95%置信区间下限 |
| `ci_upper` | float | 95%置信区间上限 |
| `cohens_d` | float | Cohen's d效应量 |
| `significance` | string | 显著性标记（***/**/*） |

## 上层 JSON 配置示例

### 示例 1：事件研究CAR检验

```json
{
  "task_id": "T12_ttest_one_sample",
  "description": "检验累积异常收益是否显著异于零",
  "test_var": "car",
  "null_value": 0
}
```

**场景说明**：事件研究中检验事件窗口期的CAR是否显著不为零。

### 示例 2：财务指标基准检验

```json
{
  "task_id": "T12_ttest_one_sample",
  "description": "检验样本ROA是否显著高于行业平均",
  "test_var": "roa",
  "null_value": 0.05
}
```

**场景说明**：检验样本公司的ROA是否显著高于5%的行业平均水平。

## 报告写作骨架

### 论文"单样本检验"章节结构

```markdown
## X.X 单变量检验

为检验[变量]是否显著异于[基准值]，本文采用单样本t检验。
检验结果如表X所示。

[变量]的样本均值为[mean]，标准差为[sd]。单样本t检验结果显示，
t统计量为[t_stat]（df=[df]），双侧p值为[p_value]，在[1%/5%/10%]
水平下[显著/不显著]。效应量Cohen's d为[d]，属于[小/中/大]效应。

上述结果表明，样本[变量]与基准值[null_value][存在/不存在]
统计上的显著差异，[支持/不支持]研究假设H[X]。

### 表X 单样本t检验结果
────────────────────────────────────────────────────
变量     N     Mean     SD      t       p      95% CI
────────────────────────────────────────────────────
CAR    1,000  0.025   0.080   9.87   <0.001  [0.020, 0.030]
────────────────────────────────────────────────────
注：***、**、*分别表示在1%、5%、10%水平下显著。
```

## 常见坑与建议

### 1. 样本量太小
- **问题**：N < 30 时对正态性要求严格
- **建议**：先进行正态性检验，或使用非参数检验

### 2. 严重偏态分布
- **问题**：t检验假设被违反
- **建议**：使用Wilcoxon符号秩检验

### 3. 只报告p值不报告效应量
- **问题**：大样本时微小差异也会显著
- **建议**：同时报告Cohen's d，评估实际意义

### 4. 混淆单侧和双侧检验
- **问题**：研究假设有方向性时应使用单侧
- **建议**：根据研究假设预先选择检验方向

### 5. 多重比较问题
- **问题**：同时检验多个变量会增加假阳性
- **建议**：进行Bonferroni或FDR校正

### 6. 置信区间解读错误
- **问题**：95% CI不包含原假设值等价于p < 0.05
- **建议**：正确理解置信区间的含义

## 非参数替代方法

### Wilcoxon符号秩检验（中位数检验）
```stata
signrank var = null_value
```

### 符号检验（仅检验正负）
```stata
signtest var = null_value
```

## 与其他任务的关系

| 相关任务 | 关系说明 |
|----------|----------|
| T13_ttest_two_sample | 两组均值比较用独立样本t检验 |
| T14_ttest_paired | 配对数据用配对t检验 |
| T07_summary_numeric | 检验前先进行描述统计 |
| T10_distribution_plots | 检验前检查分布形态 |

## 技术说明

- **Stata 版本**：18.0+
- **外部依赖**：无，仅使用 Stata 官方命令
- **关键命令**：`ttest`, `ci means`, `swilk`, `summarize`
