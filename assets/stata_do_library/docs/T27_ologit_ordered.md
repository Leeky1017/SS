# T27_ologit_ordered — 有序Logit模型（Ordered Logistic Regression）

## 任务元信息

| 属性 | 值 |
|------|-----|
| **Task ID** | T27_ologit_ordered |
| **任务名称** | 有序Logit模型 |
| **任务族** | E - 有限因变量模型 |
| **难度级别** | intermediate |
| **数据结构** | cross_section / panel |
| **金融场景适用** | ✓ 是 |

## 任务摘要

估计有序多分类因变量（如1,2,3,4,5）的Ordered Logit模型，输出系数、比值比和各类别边际效应。**适用于评级、满意度等有自然顺序的因变量**。

## 适用场景

### 场景 1：信用评级
- **因变量**：信用等级（AAA=5, AA=4, A=3, BBB=2, 其他=1）
- **自变量**：财务指标、公司特征
- **应用**：信用评级决定因素研究

### 场景 2：分析师评级
- **因变量**：推荐评级（强烈推荐=5, 推荐=4, 持有=3, 卖出=2, 强烈卖出=1）
- **自变量**：公司特征、分析师特征
- **应用**：分析师行为研究

### 场景 3：信息披露质量
- **因变量**：披露评级（优秀=4, 良好=3, 及格=2, 不及格=1）
- **自变量**：治理变量、财务变量
- **应用**：信息披露决定因素

### 场景 4：ESG评分等级
- **因变量**：ESG等级（A-E五级）
- **自变量**：公司特征、行业因素
- **应用**：ESG评分影响因素

## 理论背景

### 累积Logit模型

**潜变量设定**：
$$Y_i^* = X_i'\beta + \varepsilon_i$$

**观测值与潜变量关系**：
$$Y_i = j \quad \text{if} \quad \alpha_{j-1} < Y_i^* \leq \alpha_j$$

**累积概率模型**：
$$P(Y_i \leq j | X_i) = \Lambda(\alpha_j - X_i'\beta)$$

其中 $\alpha_j$ 是截断点（cut points），$\Lambda(\cdot)$ 是Logistic CDF。

### 平行线假设

有序Logit假设**各类别间的系数相同**（Proportional Odds Assumption）：

$$\log\frac{P(Y \leq j)}{P(Y > j)} = \alpha_j - X'\beta$$

- 如果违反该假设，应使用广义有序Logit（gologit2）

### 比值比解释

| OR值 | 解释 |
|------|------|
| OR > 1 | 倾向于选择更高类别 |
| OR < 1 | 倾向于选择更低类别 |
| OR = 2 | 选择更高类别的累积几率翻倍 |

## 数据文件要求

### 数据文件
- **首选**：`data.dta`（Stata 格式）
- **备选**：`data.csv`（自动转换为 data.dta）
- **编码**：UTF-8（推荐）

### 变量要求
- 因变量必须为有序整数（如1,2,3,4,5）
- 自变量必须为数值型
- 至少需要 3 个类别

## 输入与占位符说明

### 占位符列表

| 占位符 | 含义 | 类型 | 必填 | 合法取值示例 |
|--------|------|------|------|-------------|
| `__DEP_VAR__` | 因变量（有序分类） | 单变量名 | ✓ 是 | `rating` |
| `__INDEP_VARS__` | 自变量列表 | 空格分隔变量 | ✓ 是 | `size lev roa` |

### 渲染规则

```python
config = {
    "dep_var": "rating",
    "indep_vars": ["size", "lev", "roa", "growth"]
}

placeholders = {
    "__DEP_VAR__": config["dep_var"],
    "__INDEP_VARS__": " ".join(config["indep_vars"])
}
```

## 输出文件清单与 Schema

### 0. result.log

任务执行日志，包含有序Logit回归、比值比、边际效应、预测概率、拟合优度和结果摘要。

### 1. table_T27_ologit_coef.csv

系数与比值比表。

| 列名 | 类型 | 说明 |
|------|------|------|
| `variable` | string | 变量名 |
| `coef` | float | 系数 |
| `se` | float | 标准误 |
| `z` | float | z统计量 |
| `p` | float | p值 |
| `or` | float | 比值比 |
| `or_ll` | float | OR 95%置信下限 |
| `or_ul` | float | OR 95%置信上限 |
| `sig` | string | 显著性标记 |

### 2. table_T27_ologit_gof.csv

拟合优度指标。

| 列名 | 类型 | 说明 |
|------|------|------|
| `n` | int | 样本量 |
| `n_categories` | int | 类别数 |
| `ll` | float | 对数似然 |
| `pseudo_r2` | float | Pseudo R² |

## 上层 JSON 配置示例

```json
{
  "task_id": "T27_ologit_ordered",
  "description": "信用评级影响因素分析",
  "dep_var": "credit_rating",
  "indep_vars": ["size", "lev", "roa", "int_cov", "growth", "vol"]
}
```

## 报告写作骨架

```markdown
## X.X 有序Logit回归分析

由于因变量[Y]为有序多分类变量（[类别说明]），本文采用有序Logit模型：

$$ P(Y_i \leq j | X_i) = \frac{1}{1 + e^{-(α_j - X_i'β)}} $$

表X报告了有序Logit回归结果。[核心变量]的系数为[β]（z=[z]），
在[1%/5%/10%]水平下显著[为正/为负]，对应的比值比为[OR]，
表明该变量每增加1单位，选择更高[评级/等级]的累积几率
[增加/减少] [(OR-1)*100 / (1-OR)*100]%。

从边际效应来看，[核心变量]增加1单位，处于最高类别的概率
[增加/减少] [ME] 个百分点，处于最低类别的概率[减少/增加] [ME] 个百分点。

### 表X 有序Logit回归结果
─────────────────────────────────────────────────────────────
                   系数           OR          边际效应(最高类别)
─────────────────────────────────────────────────────────────
Size            0.350***       1.42***       0.035***
               (0.080)        [1.21,1.67]    (0.008)
─────────────────────────────────────────────────────────────
N               10,000
Pseudo R²        0.08
─────────────────────────────────────────────────────────────
注：括号内为标准误，方括号内为95%置信区间；***、**、*分别表示在1%、5%、10%水平下显著。
```

## 常见坑与建议

### 1. 忽略平行线假设检验
- **问题**：直接使用ologit而不检验假设
- **建议**：使用brant命令检验

### 2. 系数解读错误
- **问题**：把系数解读为对特定类别的影响
- **建议**：系数是对累积几率的影响

### 3. 类别太少
- **问题**：只有2个类别却用ologit
- **建议**：2类别用二元logit

### 4. 类别无序
- **问题**：因变量类别无自然顺序
- **建议**：用多项logit（mlogit）

## 与其他任务的关系

| 相关任务 | 关系说明 |
|----------|----------|
| T25_logit_binary | 二元因变量用logit |
| T28_mlogit_multinomial | 无序多分类用mlogit |

## 技术说明

- **Stata 版本**：18.0+
- **外部依赖**：无，仅使用 Stata 官方命令
- **关键命令**：`ologit`, `margins`
- **退出码**：错误时统一返回 200
- **平行线检验**：通过对比各类别二元Logit模型系数稳定性近似检验
