# T25_logit_binary — 二元Logit模型（Binary Logistic Regression）

## 任务元信息

| 属性 | 值 |
|------|-----|
| **Task ID** | T25_logit_binary |
| **任务名称** | 二元Logit模型 |
| **任务族** | E - 有限因变量模型 |
| **难度级别** | intermediate |
| **数据结构** | cross_section / panel |
| **金融场景适用** | ✓ 是 |

## 任务摘要

估计二分类因变量（0/1）的Logit模型，输出系数、比值比（OR）、边际效应和拟合优度（Pseudo R²、AUC）。包含ROC曲线和分类准确率。**金融研究中预测二元事件（违约、退市、并购等）的标准方法**。

## 适用场景

### 场景 1：财务困境/违约预测
- **因变量**：是否ST（0/1）、是否违约（0/1）
- **自变量**：财务比率、公司特征
- **应用**：信用风险评估、预警模型

### 场景 2：CEO离职预测
- **因变量**：CEO是否离职（0/1）
- **自变量**：公司绩效、治理特征
- **应用**：高管变更研究

### 场景 3：审计意见预测
- **因变量**：是否非标审计意见（0/1）
- **自变量**：财务指标、治理变量
- **应用**：审计风险研究

### 场景 4：并购决策
- **因变量**：是否发起并购（0/1）
- **自变量**：公司特征、行业因素
- **应用**：并购动因研究

## 理论背景

### Logit模型

**潜变量模型**：
$$Y_i^* = X_i'\beta + \varepsilon_i$$
$$Y_i = \begin{cases} 1 & \text{if } Y_i^* > 0 \\ 0 & \text{otherwise} \end{cases}$$

**概率模型**：
$$P(Y_i = 1 | X_i) = \Lambda(X_i'\beta) = \frac{e^{X_i'\beta}}{1 + e^{X_i'\beta}}$$

其中 $\Lambda(\cdot)$ 是Logistic累积分布函数。

### 三种效应解释

| 效应类型 | 公式 | 解释 |
|----------|------|------|
| **系数 (β)** | 直接估计 | 对数几率 ln(p/(1-p)) 的变化 |
| **比值比 (OR)** | $e^\beta$ | 几率的乘数变化 |
| **边际效应 (ME)** | $\frac{\partial P}{\partial X} = \Lambda'(X'\beta) \cdot \beta$ | 概率的变化（最直观） |

### 比值比解读

| OR值 | 解读 |
|------|------|
| OR = 1 | 无影响 |
| OR = 1.5 | 几率增加50% |
| OR = 2 | 几率翻倍 |
| OR = 0.5 | 几率减半 |
| OR = 0.8 | 几率减少20% |

### 拟合优度指标

| 指标 | 公式 | 说明 |
|------|------|------|
| **Pseudo R²** | $1 - \frac{LL}{LL_0}$ | McFadden R²，类似OLS R² |
| **AUC** | ROC曲线下面积 | 模型区分能力 |
| **分类准确率** | 正确预测比例 | 预测效果 |

## 数据文件要求

### 数据文件
- **首选**：`data.dta`（Stata 格式）
- **备选**：`data.csv`（自动转换为 data.dta）
- **编码**：UTF-8（推荐）

### 变量要求
- 因变量必须为 0/1 二元变量
- 自变量必须为数值型
- 不允许完全缺失

## 输入与占位符说明

### 占位符列表

| 占位符 | 含义 | 类型 | 必填 | 合法取值示例 |
|--------|------|------|------|-------------|
| `__DEPVAR__` | 因变量（0/1） | 单变量名 | ✓ 是 | `st` |
| `__INDEPVARS__` | 自变量列表 | 空格分隔变量 | ✓ 是 | `size lev roa` |

### 渲染规则

```python
config = {
    "dep_var": "st",
    "indep_vars": ["size", "lev", "roa", "growth", "soe"]
}

placeholders = {
    "__DEPVAR__": config["dep_var"],
    "__INDEPVARS__": " ".join(config["indep_vars"])
}
```

## Stata 执行流程

```
┌─────────────────────────────────────────────────────────────┐
│ SECTION 0: 环境初始化与数据导入                             │
├─────────────────────────────────────────────────────────────┤
│ SECTION 1: 变量检查与因变量分布                             │
├─────────────────────────────────────────────────────────────┤
│ SECTION 2: 描述性统计                                       │
├─────────────────────────────────────────────────────────────┤
│ SECTION 3: Logit回归（系数）                                │
├─────────────────────────────────────────────────────────────┤
│ SECTION 4: 比值比（Odds Ratio）                             │
├─────────────────────────────────────────────────────────────┤
│ SECTION 5: 边际效应（AME）                                  │
├─────────────────────────────────────────────────────────────┤
│ SECTION 6: 模型拟合优度                                     │
├─────────────────────────────────────────────────────────────┤
│ SECTION 7: ROC曲线与AUC                                     │
├─────────────────────────────────────────────────────────────┤
│ SECTION 8: 导出结果文件                                     │
└─────────────────────────────────────────────────────────────┘
```

## 输出文件清单与 Schema

### 0. result.log

任务执行日志，包含Logit回归、比值比、边际效应、拟合优度、ROC分析和结果摘要。

### 1. table_T25_logit_coef.csv

系数与比值比表。

| 列名 | 类型 | 说明 |
|------|------|------|
| `variable` | string | 变量名 |
| `coef` | float | 系数（对数几率） |
| `se` | float | 标准误 |
| `z` | float | z统计量 |
| `p` | float | p值 |
| `or` | float | 比值比 |
| `or_ll` | float | OR 95%置信下限 |
| `or_ul` | float | OR 95%置信上限 |
| `sig` | string | 显著性标记 |

### 2. table_T25_logit_gof.csv

拟合优度指标表。

| 列名 | 类型 | 说明 |
|------|------|------|
| `n` | int | 样本量 |
| `ll` | float | 对数似然 |
| `pseudo_r2` | float | Pseudo R² |
| `auc` | float | AUC |
| `correctly_classified` | float | 正确分类率 |

### 3. fig_T25_roc.png

ROC曲线图（PNG格式）。

## 上层 JSON 配置示例

### 示例 1：财务困境预测

```json
{
  "task_id": "T25_logit_binary",
  "description": "预测公司是否被ST",
  "dep_var": "st",
  "indep_vars": ["size", "lev", "roa", "cfoa", "growth", "age"]
}
```

### 示例 2：CEO离职预测

```json
{
  "task_id": "T25_logit_binary",
  "description": "预测CEO是否离职",
  "dep_var": "ceo_turnover",
  "indep_vars": ["roa", "ret", "board_size", "indep_ratio", "ceo_age"]
}
```

## 报告写作骨架

### 论文"Logit回归"章节结构

```markdown
## X.X Logit回归分析

由于因变量[Y]为二元变量（是/否），本文采用Logit模型进行估计：

$$ P(Y_i = 1 | X_i) = \frac{1}{1 + e^{-(X_i'\beta)}} $$

表X报告了Logit回归结果。列(1)报告系数估计值，列(2)报告比值比（OR）。

[核心变量]的系数为[β]（z=[z]），在[1%/5%/10%]水平下显著[为正/为负]，
对应的比值比为[OR]，表明该变量每增加1单位，[因变量=1]的几率
[增加/减少] [(OR-1)*100% / (1-OR)*100%]。

从边际效应来看，[核心变量]的平均边际效应为[ME]，即该变量每增加1单位，
[因变量=1]的概率平均[增加/减少] [ME*100] 个百分点。

模型的Pseudo R²为[r2]，AUC为[auc]，表明模型具有[良好/可接受]的区分能力。

### 表X Logit回归结果
─────────────────────────────────────────────────────────────
                   (1)系数        (2)OR        (3)边际效应
─────────────────────────────────────────────────────────────
X               0.350***       1.42***       0.035***
               (0.080)        [1.21,1.67]    (0.008)
Size           -0.120***       0.89***      -0.012***
               (0.030)        [0.84,0.94]    (0.003)
─────────────────────────────────────────────────────────────
N               10,000         10,000        10,000
Pseudo R²        0.15           0.15          0.15
AUC              0.78           0.78          0.78
─────────────────────────────────────────────────────────────
注：列(1)括号内为标准误，列(2)方括号内为95%置信区间；
***、**、*分别表示在1%、5%、10%水平下显著。
```

## 常见坑与建议

### 1. 事件稀有问题
- **问题**：Y=1的比例很低（<5%）
- **建议**：考虑稀有事件Logit或样本匹配

### 2. 完全分离
- **问题**：某变量完美预测因变量
- **建议**：检查数据，考虑Firth修正

### 3. 系数解读困难
- **问题**：系数是对数几率，不直观
- **建议**：报告边际效应或OR

### 4. 忽略非线性
- **问题**：边际效应不是常数
- **建议**：在不同X水平计算边际效应

### 5. 只报告系数显著性
- **问题**：不报告经济意义
- **建议**：同时报告OR和ME的大小

## AUC解读标准

| AUC | 区分能力 |
|-----|----------|
| 0.9-1.0 | 优秀 |
| 0.8-0.9 | 良好 |
| 0.7-0.8 | 可接受 |
| 0.6-0.7 | 较弱 |
| 0.5-0.6 | 差 |

## 与其他任务的关系

| 相关任务 | 关系说明 |
|----------|----------|
| T26_probit_binary | Probit是替代方法 |
| T27_ologit_ordered | 有序因变量用有序Logit |
| T28_mlogit_multinomial | 多类别用多项Logit |

## 技术说明

- **Stata 版本**：18.0+
- **外部依赖**：无，仅使用 Stata 官方命令
- **关键命令**：`logit`, `margins`, `lroc`, `estat classification`
- **退出码**：错误时统一返回 200
