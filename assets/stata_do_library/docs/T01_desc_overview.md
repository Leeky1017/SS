# T01_desc_overview — 数据集整体概况与描述统计

## 任务元信息

| 属性 | 值 |
|------|-----|
| **Task ID** | T01_desc_overview |
| **任务名称** | 数据集整体概况与描述统计 |
| **任务族** | A - 数据管理与预处理 |
| **难度级别** | basic |
| **数据结构** | cross_section / panel / time_series（均适用） |
| **金融场景适用** | ✓ 是 |

## 任务摘要

对数据集进行全面的概况分析，包括变量结构检查、描述统计（含完整分位数）、缺失值模式分析、主键唯一性校验、变量类型检测和极端值初筛。此任务是所有后续分析的基础，用于数据质量评估和预处理决策。

## 适用场景

### 场景 1：上市公司财务数据面板
- 数据来源：CSMAR、Wind、国泰安等数据库导出的企业年度/季度财务数据
- 典型变量：ROA、ROE、Leverage、Size、Tobin's Q、Cash Holdings
- 目的：检查数据完整性、识别异常值、为后续回归准备

### 场景 2：股票日度收益率时间序列
- 数据来源：股票交易数据库导出的日度收盘价/收益率
- 典型变量：return、volume、turnover、volatility
- 目的：了解收益率分布特征、检查缺失交易日、识别极端收益

### 场景 3：问卷调查截面数据
- 数据来源：投资者行为调查、公司治理评分等
- 典型变量：各类评分、年龄、收入、教育程度等
- 目的：检查问卷填写完整性、识别无效样本

### 场景 4：宏观经济时间序列
- 数据来源：央行、统计局公布的宏观数据
- 典型变量：GDP、CPI、利率、汇率、货币供应量
- 目的：了解数据时间跨度、检查缺失期间

## 理论背景

### 描述性统计的作用
描述性统计是实证研究的基础，通过集中趋势（均值、中位数）和离散程度（标准差、分位距）刻画变量分布特征。在金融研究中，描述性统计表通常是论文的"表1"，读者通过它快速了解样本特征。

### 关键统计量解释
- **均值（Mean）**：算术平均，对极端值敏感
- **中位数（Median/P50）**：位置中心，稳健性更好
- **标准差（SD）**：衡量离散程度，金融中常用于度量风险
- **偏度与峰度**：描述分布形态，金融收益率常呈尖峰厚尾
- **分位数（P1/P5/.../P99）**：用于识别极端值和进行 Winsorize 处理

### 缺失值处理策略
- **完全随机缺失（MCAR）**：直接删除影响较小
- **随机缺失（MAR）**：可考虑多重插补
- **非随机缺失（MNAR）**：需特别谨慎，可能导致选择偏差

## 输入与占位符说明

### 占位符列表

| 占位符 | 含义 | 类型 | 必填 | 合法取值示例 |
|--------|------|------|------|-------------|
| `__NUMERIC_VARS__` | 需要分析的数值变量列表 | 多变量名（空格分隔） | ✓ 是 | `roa roe leverage size` |
| `__ID_VAR__` | 个体标识变量 | 单变量名 | 否 | `stkcd` / `firm_id` |
| `__TIME_VAR__` | 时间标识变量 | 单变量名 | 否 | `year` / `date` |

### 渲染规则

```python
# Python 渲染示例
config = {
    "numeric_vars": ["roa", "roe", "leverage", "size"],
    "id_var": "stkcd",
    "time_var": "year"
}

placeholders = {
    "__NUMERIC_VARS__": " ".join(config["numeric_vars"]),  # "roa roe leverage size"
    "__ID_VAR__": config.get("id_var", ""),                # "stkcd"
    "__TIME_VAR__": config.get("time_var", "")             # "year"
}
```

## 数据要求与前置条件

### 数据文件
- **首选**：`data.dta`（Stata 格式）
- **备选**：`data.csv`（自动转换为 data.dta）
- **编码**：UTF-8（推荐）
- **首行**：必须为变量名

### 变量要求
| 变量类型 | 要求 | 不满足时的后果 |
|----------|------|---------------|
| `__NUMERIC_VARS__` | 必须存在于数据中 | 缺失变量被跳过，日志输出警告 |
| `__NUMERIC_VARS__` | 应为数值类型 | 字符型变量统计受限 |
| `__ID_VAR__` | 可选，用于主键检查 | 若不提供则跳过唯一性检查 |
| `__TIME_VAR__` | 可选，用于面板检测 | 若不提供则视为截面数据 |

### 样本量要求
- **最小样本**：无硬性下限，但 < 30 时输出警告
- **建议样本**：≥ 100 可进行较可靠的统计推断

## Stata 执行流程

```
┌─────────────────────────────────────────────────────────────┐
│ SECTION 0: 环境初始化与数据导入                             │
│   - clear all, set more off                                │
│   - 检查 data.csv 存在性                                    │
│   - import delimited                                        │
├─────────────────────────────────────────────────────────────┤
│ SECTION 1: 变量存在性检查                                   │
│   - 逐个检查 __NUMERIC_VARS__ 中的变量                      │
│   - 记录缺失变量，输出警告                                  │
├─────────────────────────────────────────────────────────────┤
│ SECTION 2: 数据集基本信息                                   │
│   - describe: 变量结构                                      │
│   - 检测数据类型（截面/面板/时序）                          │
├─────────────────────────────────────────────────────────────┤
│ SECTION 3: 主键唯一性检查                                   │
│   - duplicates report: 检查重复                             │
│   - 输出重复记录示例                                        │
├─────────────────────────────────────────────────────────────┤
│ SECTION 4: 描述统计                                         │
│   - summarize: 基础统计                                     │
│   - summarize, detail: 详细统计                             │
│   - tabstat: 扩展分位数 (p1-p99)                           │
├─────────────────────────────────────────────────────────────┤
│ SECTION 5: 缺失值分析                                       │
│   - 各变量缺失数量与比例                                    │
│   - misstable summarize/patterns                           │
├─────────────────────────────────────────────────────────────┤
│ SECTION 6: 有效样本量检查                                   │
│   - 计算完整案例数                                          │
│   - 样本量不足警告                                          │
├─────────────────────────────────────────────────────────────┤
│ SECTION 7: 变量类型检测与极端值初筛                         │
│   - 识别变量类型（二元/分类/连续）                          │
│   - 1%/99%分位数外的观测统计                               │
├─────────────────────────────────────────────────────────────┤
│ SECTION 8: 导出结果文件                                     │
│   - table_T01_desc_stats.csv                               │
│   - table_T01_missing_pattern.csv                          │
├─────────────────────────────────────────────────────────────┤
│ SECTION 9: 任务完成摘要                                     │
│   - 输出概况总结                                            │
└─────────────────────────────────────────────────────────────┘
```

## 输出文件清单与 Schema

### 0. result.log

任务执行日志，包含所有控制台输出，便于上层 LLM 解析。

### 1. table_T01_desc_stats.csv

描述统计表，每行一个变量。

| 列名 | 类型 | 说明 |
|------|------|------|
| `variable` | string | 变量名 |
| `n` | integer | 有效观测数 |
| `mean` | float | 均值 |
| `sd` | float | 标准差 |
| `min` | float | 最小值 |
| `p1` | float | 1%分位数 |
| `p5` | float | 5%分位数 |
| `p10` | float | 10%分位数 |
| `p25` | float | 25%分位数（下四分位） |
| `p50` | float | 50%分位数（中位数） |
| `p75` | float | 75%分位数（上四分位） |
| `p90` | float | 90%分位数 |
| `p95` | float | 95%分位数 |
| `p99` | float | 99%分位数 |
| `max` | float | 最大值 |

### 2. table_T01_missing_pattern.csv

缺失值模式表，每行一个变量。

| 列名 | 类型 | 说明 |
|------|------|------|
| `variable` | string | 变量名 |
| `n_total` | integer | 总观测数 |
| `n_missing` | integer | 缺失数 |
| `pct_missing` | float | 缺失比例（%） |

## 上层 JSON 配置示例

### 示例 1：上市公司面板数据

```json
{
  "task_id": "T01_desc_overview",
  "description": "A股上市公司2010-2022年财务数据描述统计",
  "numeric_vars": ["roa", "roe", "leverage", "size", "tobinq", "cash", "age"],
  "id_var": "stkcd",
  "time_var": "year"
}
```

**场景说明**：分析沪深A股上市公司的财务指标分布，检查面板数据的平衡性和缺失情况，为后续公司金融回归做准备。

### 示例 2：股票收益率截面数据

```json
{
  "task_id": "T01_desc_overview",
  "description": "某月股票横截面收益率特征",
  "numeric_vars": ["ret", "mktcap", "bm", "mom", "vol", "turnover"],
  "id_var": "stkcd"
}
```

**场景说明**：分析某个月股票的截面特征，用于资产定价因子构建前的数据质量检查。

## 报告写作骨架

### 论文"描述性统计"章节结构

```markdown
## X.X 描述性统计

### X.X.1 样本概况

本文样本来源于[数据来源]，时间跨度为[起止年份]。经过以下筛选：
1. 剔除金融行业样本
2. 剔除 ST/*ST 样本  
3. 剔除关键变量缺失样本
最终得到 [N] 个公司-年度观测值，涉及 [n] 家上市公司。

### X.X.2 变量定义与描述统计

表 X 报告了主要变量的描述性统计结果。
- 因变量 [Y] 的均值为 [mean]，标准差为 [sd]，表明...
- 解释变量 [X] 的均值为 [mean]，中位数为 [median]，两者接近/差异表明分布...
- 为缓解极端值影响，本文对连续变量在 1% 和 99% 分位数进行了 Winsorize 处理。

### X.X.3 缺失值处理

原始数据中，变量 [var] 缺失率为 [pct]%，主要原因可能是...
本文采用 [listwise deletion / 多重插补] 方法处理缺失值。
```

### 描述性统计表格式（论文表1）

```
表 1 描述性统计
─────────────────────────────────────────────────────────────────
变量      N        Mean      SD       Min      P25      P50      P75      Max
─────────────────────────────────────────────────────────────────
ROA     12,345    0.045    0.067   -0.312    0.015    0.042    0.078    0.298
ROE     12,340    0.089    0.156   -0.856    0.032    0.085    0.152    0.612
...
─────────────────────────────────────────────────────────────────
注：本表报告了主要变量的描述性统计。连续变量在1%和99%分位数进行了Winsorize处理。
```

## 常见坑与建议

### 1. 变量名大小写问题
- **问题**：Stata 变量名区分大小写，`ROA` 和 `roa` 是不同变量
- **建议**：导入数据后统一用 `rename *, lower` 转为小写

### 2. 字符型数值变量
- **问题**：数据库导出的数字可能被识别为字符串（如股票代码前导零）
- **建议**：检查 `describe` 输出的变量类型，必要时用 `destring`

### 3. 缺失值编码不一致
- **问题**：不同来源的缺失值可能编码为 -999、空白、"NA" 等
- **建议**：导入时用 `import delimited, missing("NA" "-999" ".")` 指定缺失值编码

### 4. 分位数与极端值
- **问题**：P1/P99 可能仍含极端值，直接用于回归可能有问题
- **建议**：检查 P1/P99 值是否合理，考虑 Winsorize 或 Truncate

### 5. 面板不平衡
- **问题**：不平衡面板可能导致某些公司权重过大
- **建议**：关注日志中的"平衡面板/不平衡面板"提示

### 6. 主键重复
- **问题**：数据合并时可能产生重复行
- **建议**：检查主键唯一性检查的结果，有重复时先清理

### 7. 样本量过小
- **问题**：完整案例数不足影响统计推断可靠性
- **建议**：关注日志中的样本量警告，考虑是否需要扩大样本或插补缺失

### 8. 变量尺度差异大
- **问题**：如资产规模（亿元级）与比率（小数级）混合分析
- **建议**：检查描述统计的量级，考虑取对数或标准化

### 9. 忽略分布形态
- **问题**：均值 ≠ 中位数时说明分布偏斜
- **建议**：比较 mean 和 p50，差异大时考虑取对数或使用稳健方法

### 10. 时间序列的特殊性
- **问题**：时间序列数据可能存在缺失日期（非交易日、停牌等）
- **建议**：检查时间变量的连续性，必要时填充缺失期间

## 与其他任务的关系

| 后续任务 | 关系说明 |
|----------|----------|
| T02_desc_by_group | 本任务的分组版本，可按行业/年份等分组统计 |
| T03_filter_and_sample | 基于本任务发现的问题进行数据筛选 |
| T07_summary_numeric | 更简洁的描述统计输出 |
| T17-T24 线性回归 | 本任务检查的变量将用于回归分析 |

## 技术说明

- **Stata 版本**：18.0+
- **外部依赖**：无，仅使用 Stata 官方命令
- **关键命令**：`describe`, `summarize`, `tabstat`, `misstable`, `duplicates`, `bysort`, `count`
- **注意**：统计唯一值数量采用官方命令 `bysort var: gen tag = _n==1` + `count if tag` 替代社区命令 `distinct`
