# T29_poisson_count — 计数模型（Poisson/负二项回归）

## 任务元信息

| 属性 | 值 |
|------|-----|
| **Task ID** | T29_poisson_count |
| **任务名称** | 计数模型 |
| **任务族** | E - 有限因变量模型 |
| **难度级别** | intermediate |
| **数据结构** | cross_section / panel |
| **金融场景适用** | ✓ 是 |

## 任务摘要

估计计数数据（非负整数）的Poisson或负二项回归模型，输出系数、发生率比（IRR）和边际效应。包含过度分散检验和模型比较。**专利、引用、违规次数等计数因变量的标准分析方法**。

## 适用场景

### 场景 1：专利产出
- **因变量**：专利申请数量
- **自变量**：研发投入、公司规模、行业
- **应用**：创新产出研究

### 场景 2：被引次数
- **因变量**：论文被引次数、分析师关注数
- **自变量**：公司特征、信息披露
- **应用**：信息传播研究

### 场景 3：违规次数
- **因变量**：公司违规次数
- **自变量**：治理变量、财务变量
- **应用**：公司治理研究

### 场景 4：交易频率
- **因变量**：交易笔数
- **自变量**：市场特征、投资者类型
- **应用**：市场微观结构

## 理论背景

### Poisson回归

**条件均值**：
$$E[Y_i | X_i] = \exp(X_i'\beta) = \lambda_i$$

**Poisson分布**：
$$P(Y_i = y) = \frac{\lambda_i^y e^{-\lambda_i}}{y!}$$

**关键假设**：$Var[Y|X] = E[Y|X]$（等分散）

### 负二项回归

当存在**过度分散**（$Var > E$）时：

$$Var[Y_i | X_i] = \lambda_i + \alpha \lambda_i^2$$

- α = 0：退化为Poisson
- α > 0：存在过度分散

### 发生率比（IRR）

$$IRR = e^\beta$$

| IRR值 | 解释 |
|-------|------|
| IRR = 1 | 无影响 |
| IRR = 1.2 | 计数增加20% |
| IRR = 0.8 | 计数减少20% |
| IRR = 2 | 计数翻倍 |

## 模型选择决策树

```
方差/均值 >> 1？
├─ 否 → Poisson
└─ 是 → 负二项
        └─ 零值 > 30%？
            ├─ 是 → 考虑零膨胀模型
            └─ 否 → 负二项
```

## 数据文件要求

### 数据文件
- **首选**：`data.dta`（Stata 格式）
- **备选**：`data.csv`（自动转换为 data.dta）
- **编码**：UTF-8（推荐）

### 变量要求
- 因变量必须为非负整数（计数变量）
- 自变量必须为数值型
- 不允许完全缺失

## 输入与占位符说明

### 占位符列表

| 占位符 | 含义 | 类型 | 必填 | 合法取值示例 |
|--------|------|------|------|-------------|
| `__DEP_VAR__` | 因变量（计数） | 单变量名 | ✓ 是 | `patent_count` |
| `__INDEP_VARS__` | 自变量列表 | 空格分隔变量 | ✓ 是 | `rd size age` |

### 渲染规则

```python
config = {
    "dep_var": "patent_count",
    "indep_vars": ["rd", "size", "age", "soe"]
}

placeholders = {
    "__DEP_VAR__": config["dep_var"],
    "__INDEP_VARS__": " ".join(config["indep_vars"])
}
```

## 输出文件清单与 Schema

### 0. result.log

任务执行日志，包含Poisson/负二项回归、发生率比（IRR）、过度分散检验、模型比较、边际效应和结果摘要。

### 1. table_T29_count_gof.csv

模型比较指标表。

| 列名 | 类型 | 说明 |
|------|------|------|
| `model` | string | 模型名称 |
| `n` | int | 样本量 |
| `ll` | float | 对数似然 |
| `aic` | float | AIC |
| `bic` | float | BIC |
| `alpha` | float | 过度分散参数 |

## 上层 JSON 配置示例

```json
{
  "task_id": "T29_poisson_count",
  "description": "专利产出影响因素分析",
  "dep_var": "patent_count",
  "indep_vars": ["rd", "size", "age", "lev", "soe"]
}
```

## 报告写作骨架

```markdown
## X.X 计数模型回归分析

由于因变量[Y]为计数变量（非负整数），本文采用计数模型进行分析。
首先，我们检验过度分散问题：因变量的方差/均值比为[ratio]，
显著大于1，表明存在过度分散。过度分散参数α的LR检验（χ²=[stat]，
p<0.01）进一步确认了这一点。因此，本文采用负二项回归模型。

表X报告了负二项回归结果。[核心变量]的系数为[β]（z=[z]），
在[1%/5%/10%]水平下显著[为正/为负]，对应的发生率比（IRR）为[IRR]，
表明该变量每增加1单位，[专利数量/引用次数]平均[增加/减少] 
[(IRR-1)*100 / (1-IRR)*100]%。

### 表X 计数模型回归结果
─────────────────────────────────────────────────────────────
                   Poisson          负二项
                   IRR              IRR
─────────────────────────────────────────────────────────────
RD              1.35***          1.28***
               [1.20,1.52]      [1.15,1.43]
Size            1.15***          1.12***
               [1.08,1.23]      [1.05,1.20]
─────────────────────────────────────────────────────────────
N               10,000           10,000
Log-L           -25000           -24000
α                 —               0.85***
─────────────────────────────────────────────────────────────
注：方括号内为95%置信区间；***、**、*分别表示在1%、5%、10%水平下显著。
```

## 常见坑与建议

### 1. 忽略过度分散
- **问题**：直接使用Poisson而不检验
- **建议**：必须先检验过度分散

### 2. 零值过多
- **问题**：30%以上为零值
- **建议**：考虑零膨胀Poisson/负二项

### 3. 解读为概率
- **问题**：把IRR解读为概率变化
- **建议**：IRR是计数的乘数变化

### 4. 暴露变量
- **问题**：观测窗口长度不同
- **建议**：使用offset或exposure选项

## 与其他任务的关系

| 相关任务 | 关系说明 |
|----------|----------|
| T25_logit_binary | 二元因变量用logit |
| T17_ols_simple | 连续因变量用OLS |

## 技术说明

- **Stata 版本**：18.0+
- **外部依赖**：无，仅使用 Stata 官方命令
- **关键命令**：`poisson`, `nbreg`, `estat gof`, `margins`
- **退出码**：错误时统一返回 200
