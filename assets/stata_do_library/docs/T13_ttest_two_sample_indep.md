# T13_ttest_two_sample_indep — 独立样本t检验（两组均值比较）

## 任务元信息

| 属性 | 值 |
|------|-----|
| **Task ID** | T13_ttest_two_sample_indep |
| **任务名称** | 独立样本t检验（两组均值比较） |
| **任务族** | C - 假设检验 |
| **难度级别** | basic |
| **数据结构** | cross_section / panel（截面比较） |
| **金融场景适用** | ✓ 是 |

## 任务摘要

比较两组独立样本的均值是否存在显著差异。包含方差齐性检验（Levene检验）、Student's t检验、Welch t检验（稳健）、效应量（Cohen's d）计算和分组箱线图可视化。适用于国企vs民企、处理组vs对照组等两组比较场景。

## 适用场景

### 场景 1：国企与民企绩效差异
- **检验变量**：ROA、ROE等绩效指标
- **分组变量**：产权性质（ownership: 0=民企, 1=国企）
- **应用**：检验不同产权性质企业的绩效是否存在显著差异

### 场景 2：政策处理效应初步检验
- **检验变量**：因变量（如投资水平）
- **分组变量**：是否受政策影响（treated: 0/1）
- **应用**：DID分析前的初步均值差异检验

### 场景 3：事件前后CAR比较
- **检验变量**：累积异常收益（CAR）
- **分组变量**：好消息vs坏消息
- **应用**：检验不同类型事件的市场反应差异

### 场景 4：高低组别比较
- **检验变量**：公司绩效
- **分组变量**：高研发组vs低研发组
- **应用**：检验研发投入高低对绩效的影响

## 理论背景

### 独立样本t检验原理

**检验统计量**（方差齐性时）：
$$t = \frac{\bar{X}_1 - \bar{X}_2}{S_p \sqrt{\frac{1}{n_1} + \frac{1}{n_2}}}$$

其中合并标准差：
$$S_p = \sqrt{\frac{(n_1-1)S_1^2 + (n_2-1)S_2^2}{n_1 + n_2 - 2}}$$

**Welch t检验**（方差不齐时）：
$$t = \frac{\bar{X}_1 - \bar{X}_2}{\sqrt{\frac{S_1^2}{n_1} + \frac{S_2^2}{n_2}}}$$

### Student's t vs Welch t

| 特征 | Student's t | Welch t |
|------|-------------|---------|
| 方差假设 | 假设相等 | 不假设相等 |
| 自由度 | n₁ + n₂ - 2 | Satterthwaite近似 |
| 适用场景 | 方差齐性成立 | 一般情况（推荐） |
| 稳健性 | 方差不齐时偏误 | 更稳健 |

### 效应量（Cohen's d）

$$d = \frac{\bar{X}_1 - \bar{X}_2}{S_p}$$

| |d| 范围 | 效应大小 | 实际意义 |
|----------|----------|----------|
| < 0.2 | 小效应 | 差异很小 |
| 0.2-0.5 | 小到中效应 | 差异可察觉 |
| 0.5-0.8 | 中效应 | 差异明显 |
| ≥ 0.8 | 大效应 | 差异很大 |

### 前提假设
1. **独立性**：两组样本相互独立
2. **正态性**：两组总体近似正态（大样本时可放宽）
3. **方差齐性**：Student's t检验要求方差相等（Levene检验）

## 输入与占位符说明

### 占位符列表

| 占位符 | 含义 | 类型 | 必填 | 合法取值示例 |
|--------|------|------|------|-------------|
| `__TEST_VAR__` | 检验变量 | 单变量名 | ✓ 是 | `roa` |
| `__GROUP_VAR__` | 分组变量（二分类） | 单变量名 | ✓ 是 | `ownership` |

### 渲染规则

```python
# Python 渲染示例
config = {
    "test_var": "roa",
    "group_var": "ownership"
}

placeholders = {
    "__TEST_VAR__": config["test_var"],
    "__GROUP_VAR__": config["group_var"]
}
```

## 数据要求与前置条件

### 数据文件
- **首选**：`data.dta`（Stata 格式）
- **备选**：`data.csv`（自动转换为 data.dta）

### 变量要求
- 检验变量必须存在且为数值类型
- 分组变量必须有且仅有 2 个类别

## Stata 执行流程

```
┌─────────────────────────────────────────────────────────────┐
│ SECTION 0: 环境初始化与标准化数据加载                         │
├─────────────────────────────────────────────────────────────┤
│ SECTION 1: 变量检查                                         │
│   - 确认分组变量为二分类                                    │
├─────────────────────────────────────────────────────────────┤
│ SECTION 2: 分组描述统计                                     │
├─────────────────────────────────────────────────────────────┤
│ SECTION 3: 方差齐性检验（Levene检验）                       │
├─────────────────────────────────────────────────────────────┤
│ SECTION 4: 独立样本 t 检验                                  │
│   - Student's t 检验                                       │
│   - Welch t 检验                                           │
├─────────────────────────────────────────────────────────────┤
│ SECTION 5: 效应量（Cohen's d）                              │
├─────────────────────────────────────────────────────────────┤
│ SECTION 6: 检验结论汇总                                     │
├─────────────────────────────────────────────────────────────┤
│ SECTION 7: 可视化                                           │
├─────────────────────────────────────────────────────────────┤
│ SECTION 8: 导出结果文件                                     │
└─────────────────────────────────────────────────────────────┘
```

## 输出文件清单与 Schema

### 0. result.log

任务执行日志，包含分组描述统计、方差齐性检验、t检验结果和效应量输出。

### 1. table_T13_ttest_result.csv

独立样本t检验结果汇总表。

| 列名 | 类型 | 说明 |
|------|------|------|
| `test_type` | string | 检验类型 |
| `test_var` | string | 检验变量名 |
| `group_var` | string | 分组变量名 |
| `n1` | integer | 组1样本量 |
| `n2` | integer | 组2样本量 |
| `mean1` | float | 组1均值 |
| `mean2` | float | 组2均值 |
| `sd1` | float | 组1标准差 |
| `sd2` | float | 组2标准差 |
| `mean_diff` | float | 均值差异 |
| `levene_p` | float | Levene检验p值 |
| `t_equal` | float | Student's t统计量 |
| `p_equal` | float | Student's t p值 |
| `t_welch` | float | Welch t统计量 |
| `p_welch` | float | Welch t p值 |
| `cohens_d` | float | Cohen's d效应量 |
| `significance` | string | 显著性标记 |

### 2. fig_T13_boxplot.png

分组箱线图（PNG格式）。

## 上层 JSON 配置示例

### 示例 1：国企民企绩效比较

```json
{
  "task_id": "T13_ttest_two_sample_indep",
  "description": "比较国企与民企的ROA差异",
  "test_var": "roa",
  "group_var": "ownership"
}
```

**场景说明**：检验国有企业与民营企业的资产收益率是否存在显著差异。

### 示例 2：处理组对照组比较

```json
{
  "task_id": "T13_ttest_two_sample_indep",
  "description": "比较政策处理组与对照组的投资水平",
  "test_var": "investment",
  "group_var": "treated"
}
```

**场景说明**：DID分析的初步检验，比较处理组和对照组的因变量均值。

## 报告写作骨架

### 论文"均值差异检验"章节结构

```markdown
## X.X 单变量差异检验

为初步检验[分组变量]对[检验变量]的影响，本文进行独立样本t检验。
检验结果如表X所示。

[组1名称]的[检验变量]均值为[mean1]（SD=[sd1]），[组2名称]的
[检验变量]均值为[mean2]（SD=[sd2]），均值差异为[diff]。

Levene方差齐性检验结果显示p=[levene_p]，[可以/不能]认为两组方差相等，
因此采用[Student's t/Welch t]检验。检验结果显示，t统计量为[t]，
p值为[p]，在[1%/5%/10%]水平下[显著/不显著]。
Cohen's d效应量为[d]，属于[小/中/大]效应。

上述结果表明，[组1名称]与[组2名称]的[检验变量][存在/不存在]
统计上的显著差异，初步[支持/不支持]研究假设H[X]。

### 表X 均值差异检验
──────────────────────────────────────────────────────────────
变量        组1(N)      组2(N)      Diff       t        p
──────────────────────────────────────────────────────────────
ROA      0.045(5000)  0.038(5000)   0.007    3.56    <0.001***
ROE      0.092(5000)  0.078(5000)   0.014    2.89     0.004**
──────────────────────────────────────────────────────────────
注：Diff=组1均值-组2均值；***、**、*分别表示在1%、5%、10%水平下显著。
```

## 常见坑与建议

### 1. 分组变量超过两类
- **问题**：t检验只能比较两组
- **建议**：使用ANOVA（T15），或两两比较

### 2. 样本量严重不平衡
- **问题**：n₁ >> n₂ 时检验效力下降
- **建议**：报告效应量，考虑倾向得分匹配

### 3. 忽略方差齐性检验
- **问题**：方差不齐时Student's t有偏
- **建议**：始终报告Levene检验，推荐使用Welch t

### 4. 只报告显著性不报告效应量
- **问题**：大样本时微小差异也会显著
- **建议**：同时报告Cohen's d，评估实际意义

### 5. 数据严重非正态
- **问题**：t检验假设被违反
- **建议**：使用Mann-Whitney U非参数检验

### 6. 多重比较问题
- **问题**：同时比较多个变量增加假阳性
- **建议**：进行Bonferroni校正

## 非参数替代方法

### Mann-Whitney U检验（Wilcoxon秩和检验）
```stata
ranksum var, by(group)
```

### Kolmogorov-Smirnov检验（分布差异）
```stata
ksmirnov var, by(group)
```

## 与其他任务的关系

| 相关任务 | 关系说明 |
|----------|----------|
| T12_ttest_one_sample | 单变量与基准值比较 |
| T14_ttest_paired | 配对样本比较 |
| T15_anova_oneway | 多组比较用ANOVA |
| T02_desc_by_group | 分组描述统计 |
| T10_distribution_plots | 分组箱线图 |

## 技术说明

- **Stata 版本**：18.0+
- **外部依赖**：无，仅使用 Stata 官方命令
- **关键命令**：`ttest`, `robvar`, `tabstat`, `graph box`
