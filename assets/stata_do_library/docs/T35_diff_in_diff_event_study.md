# T35_diff_in_diff_event_study — 事件研究法DID（Event Study DID）

## 任务元信息

| 属性 | 值 |
|------|-----|
| **Task ID** | T35_diff_in_diff_event_study |
| **任务名称** | 事件研究法DID |
| **任务族** | F - 面板数据与政策评估 |
| **难度级别** | advanced |
| **数据结构** | panel |
| **金融场景适用** | ✓ 是 |

## 任务摘要

估计事件研究法DID模型，绘制动态处理效应图（Event Study Plot），检验平行趋势假设。**DID分析中必须包含的平行趋势验证步骤**。

## 适用场景

### 场景 1：平行趋势检验
- **目的**：验证DID的关键假设
- **方法**：检验事件前系数是否联合为0
- **应用**：所有DID研究

### 场景 2：动态效应分析
- **目的**：观察处理效应的时间模式
- **方法**：估计各期效应
- **应用**：政策效果持续性研究

### 场景 3：预期效应检验
- **目的**：检验是否存在政策预期
- **方法**：观察事件前系数趋势
- **应用**：政策公告效应研究

## 理论背景

### 事件研究DID模型

$$Y_{it} = \alpha_i + \gamma_t + \sum_{\tau \neq -1} \beta_\tau \cdot (Treat_i \times I(t - Event_i = \tau)) + \varepsilon_{it}$$

- $\alpha_i$：个体固定效应
- $\gamma_t$：时间固定效应
- $\beta_\tau$：相对事件时间τ期的处理效应
- 基准期：$\tau = -1$（系数固定为0）

### 平行趋势假设

$$H_0: \beta_{-4} = \beta_{-3} = \beta_{-2} = 0$$

| 检验结果 | 含义 |
|----------|------|
| 不拒绝H0 | 支持平行趋势 |
| 拒绝H0 | 平行趋势可能不成立 |

### 图形解读

| 时期 | 期望结果 | 含义 |
|------|----------|------|
| **事件前** | 系数≈0，无趋势 | 平行趋势成立 |
| **事件时** | 系数显著 | 政策即时效应 |
| **事件后** | 系数持续/变化 | 效应持续性 |

## 数据文件要求

### 数据文件
- **首选**：`data.dta`（Stata 格式）
- **备选**：`data.csv`（自动转换为 data.dta）
- **编码**：UTF-8（推荐）

### 变量要求
- 个体变量必须为数值型
- 时间变量必须为数值型
- 相对事件时间变量（负=事件前，0=事件年，正=事件后）
- 处理组指示变量：0/1

## 输入与占位符说明

### 占位符列表

| 占位符 | 含义 | 类型 | 必填 | 合法取值示例 |
|--------|------|------|------|-------------|
| `__DEP_VAR__` | 因变量 | 单变量名 | ✓ 是 | `roa` |
| `__TREAT_VAR__` | 处理组指示（0/1） | 单变量名 | ✓ 是 | `treated` |
| `__TIME_VAR__` | 时间变量 | 单变量名 | ✓ 是 | `year` |
| `__EVENT_TIME__` | 相对事件时间 | 单变量名 | ✓ 是 | `relative_year` |
| `__ID_VAR__` | 个体标识 | 单变量名 | ✓ 是 | `stkcd` |

### 相对事件时间变量

```
relative_year = year - event_year
```

| 值 | 含义 |
|----|------|
| -3, -2, -1 | 事件前3年、2年、1年 |
| 0 | 事件年 |
| 1, 2, 3 | 事件后1年、2年、3年 |

## 输出文件清单与 Schema

### 0. result.log

任务执行日志，包含相对事件时间分布、事件研究回归、各期系数、平行趋势检验和结果摘要。

### 1. table_T35_event_coef.csv

各期系数表。

| 列名 | 类型 | 说明 |
|------|------|------|
| `event_time` | int | 相对事件时间 |
| `coef` | float | 系数估计 |
| `se` | float | 标准误 |
| `pvalue` | float | p值 |
| `ci_lo` | float | 95%置信区间下限 |
| `ci_hi` | float | 95%置信区间上限 |

### 2. fig_T35_event_study.png

事件研究系数图（PNG格式）。

## 上层 JSON 配置示例

```json
{
  "task_id": "T35_diff_in_diff_event_study",
  "description": "新准则实施的动态效应分析",
  "dep_var": "earnings_quality",
  "treat_var": "affected",
  "time_var": "year",
  "event_time": "relative_year",
  "id_var": "stkcd"
}
```

## 报告写作骨架

```markdown
## X.X 平行趋势检验

为验证双重差分的平行趋势假设，本文采用事件研究法估计动态处理效应：

$$ Y_{it} = \alpha_i + \gamma_t + \sum_{\tau \neq -1} \beta_\tau (Treat_i \times I_{t-Event=\tau}) + \varepsilon_{it} $$

其中以事件前一年（τ=-1）为基准期。

图X绘制了各期系数估计值及其95%置信区间。可以看到：
(1) 事件前各期系数（τ=-4,-3,-2）均不显著异于0，
事件前系数联合检验F=[F]（p=[p]），无法拒绝零假设，
支持平行趋势假设。
(2) 事件当年（τ=0）系数开始显著为[正/负]，
表明政策产生了即时效应。
(3) 事件后各期系数[持续显著/逐渐消失]，
表明政策效应[具有持续性/为暂时性]。

### 图X 事件研究：动态处理效应
[插入 fig_T35_event_study.png]

注：实心点为各期系数估计值，竖线为95%置信区间，
红色虚线为零参考线，灰色虚线为事件发生时点。
基准期为τ=-1。
```

## 常见坑与建议

### 1. 基准期选择
- **问题**：选择t=0作为基准期
- **建议**：使用t=-1，避免与处理效应混淆

### 2. 端点效应
- **问题**：两端系数不稳定
- **建议**：合并端点期（如-4及之前合并）

### 3. 多期DID偏误
- **问题**：处理时点不同导致的偏误
- **建议**：考虑使用Sun & Abraham等新方法

### 4. 忽略联合检验
- **问题**：仅看图不做统计检验
- **建议**：必须报告事件前系数联合F检验

## 与其他任务的关系

| 相关任务 | 关系说明 |
|----------|----------|
| T34_diff_in_diff_2x2 | 经典2×2 DID |
| T31_panel_fe_basic | 面板固定效应 |

## 技术说明

- **Stata 版本**：18.0+
- **外部依赖**：无，仅使用 Stata 官方命令
- **关键命令**：`xtset`, `regress`, `test`, `twoway`, `vce(cluster)`
- **退出码**：错误时统一返回 200
