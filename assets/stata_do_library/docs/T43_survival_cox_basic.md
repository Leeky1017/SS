# T43_survival_cox_basic — Cox比例风险回归（Cox Proportional Hazards）

## 任务元信息

| 属性 | 值 |
|------|-----|
| **Task ID** | T43_survival_cox_basic |
| **任务名称** | Cox比例风险回归 |
| **任务族** | H - 生存分析 |
| **难度级别** | intermediate |
| **数据结构** | survival |
| **金融场景适用** | ✓ 是 |

## 任务摘要

估计Cox比例风险回归模型，分析协变量对生存的影响，进行比例风险假设检验。**生存分析的核心回归方法**。

## 适用场景

### 场景 1：违约风险建模
- **目的**：识别影响违约的因素
- **方法**：Cox回归
- **应用**：信用风险管理

### 场景 2：客户流失因素分析
- **目的**：分析影响客户留存的因素
- **方法**：估计各因素的HR
- **应用**：客户保留策略

### 场景 3：企业存续分析
- **目的**：分析企业退市/破产的影响因素
- **方法**：Cox回归+比例风险检验
- **应用**：投资风险评估

## 理论背景

### Cox比例风险模型

$$h(t|X) = h_0(t) \cdot \exp(\beta_1 X_1 + \beta_2 X_2 + ... + \beta_p X_p)$$

- $h(t|X)$：给定协变量X时在t时刻的瞬时风险
- $h_0(t)$：基准风险函数（未指定）
- $\exp(\beta)$：危险比（Hazard Ratio）

### 危险比（HR）

$$HR = \frac{h(t|X+1)}{h(t|X)} = \exp(\beta)$$

| HR | 含义 |
|----|------|
| **HR > 1** | 风险增加（危险因素） |
| **HR < 1** | 风险降低（保护因素） |
| **HR = 1** | 无影响 |

### 比例风险假设

$$\frac{h_1(t)}{h_0(t)} = HR = constant$$

即各组的风险比例不随时间变化。

### 检验方法

- **Schoenfeld残差检验**：残差不应与时间相关
- **图形诊断**：log(-log(S(t)))曲线应平行

## 数据文件要求

### 数据文件
- **首选**：`data.dta`（Stata 格式）
- **备选**：`data.csv`（自动转换为 data.dta）
- **编码**：UTF-8（推荐）

### 变量要求
- 生存时间变量：数值型，正值
- 事件变量：0/1二元变量（0=删失，1=事件）
- 协变量：数值型（连续或虚拟变量）

## 输入与占位符说明

### 占位符列表

| 占位符 | 含义 | 类型 | 必填 | 合法取值示例 |
|--------|------|------|------|-------------|
| `__TIME_VAR__` | 生存时间 | 单变量名 | ✓ 是 | `duration` |
| `__EVENT_VAR__` | 事件指示 | 单变量名 | ✓ 是 | `default` |
| `__INDEP_VARS__` | 协变量列表 | 多变量名 | ✓ 是 | `age leverage roa` |

## 输出文件清单与 Schema

### 0. result.log

任务执行日志，包含Cox模型估计、危险比输出、比例风险假设检验和模型拟合指标。

### 1. table_T43_cox_coef.csv

Cox回归系数表。

| 列名 | 类型 | 说明 |
|------|------|------|
| `variable` | string | 变量名 |
| `coef` | float | 系数β |
| `se` | float | 标准误 |
| `hr` | float | 危险比exp(β) |
| `z` | float | z统计量 |
| `p` | float | p值 |
| `hr_lo` | float | HR 95%CI下限 |
| `hr_hi` | float | HR 95%CI上限 |

### 2. table_T43_phtest.csv

比例风险假设检验结果表。

| 列名 | 类型 | 说明 |
|------|------|------|
| `variable` | string | 变量名（global为全局检验） |
| `rho` | float | Schoenfeld相关系数ρ |
| `chi2` | float | χ²统计量 |
| `df` | float | 自由度 |
| `p` | float | p值 |

### 3. fig_T43_cox_survival.png

Cox模型生存曲线（PNG格式）。

## 上层 JSON 配置示例

```json
{
  "task_id": "T43_survival_cox_basic",
  "description": "企业违约风险因素分析",
  "time_var": "survival_years",
  "event_var": "default",
  "indep_vars": ["leverage", "roa", "size", "age"]
}
```

## 报告写作骨架

```markdown
## X.X Cox比例风险回归

为分析影响[结局事件]的因素，本文采用Cox比例风险回归模型：

$$ h(t|X) = h_0(t) \cdot \exp(\beta'X) $$

表X报告了回归结果。[变量1]的危险比为[HR]（95% CI: [下限, 上限]，p<0.01），
表明[变量1]每增加1单位，[事件]风险增加[HR-1]×100%。
[变量2]的危险比为[HR]（p<0.05），显示其为[保护/危险]因素。

比例风险假设检验显示，全局检验χ²=[χ²]（p=[p]>[0.05]），
各变量的Schoenfeld残差检验p值均大于0.05，表明模型满足比例风险假设。

### 表X Cox比例风险回归结果
─────────────────────────────────────────────────────────────
变量             HR        95% CI            p值
─────────────────────────────────────────────────────────────
Leverage        2.15***   [1.52, 3.04]     <0.001
ROA             0.42***   [0.28, 0.63]     <0.001
Size            0.85**    [0.74, 0.98]      0.023
Age             0.98      [0.95, 1.01]      0.186
─────────────────────────────────────────────────────────────
样本量          2,500
事件数            180
Log-likelihood  -856.32
─────────────────────────────────────────────────────────────
注：***、**、*分别表示在1%、5%、10%水平下显著。
HR为危险比（Hazard Ratio），HR>1表示风险增加。
```

## 常见坑与建议

### 1. 忽略比例风险假设
- **问题**：不检验假设直接报告结果
- **建议**：必须报告Schoenfeld检验

### 2. HR解读错误
- **问题**：将HR误解为相对风险或OR
- **建议**：明确HR是瞬时风险比

### 3. 删失过多
- **问题**：删失比例过高影响估计
- **建议**：报告删失比例，考虑敏感性分析

### 4. 共线性
- **问题**：协变量高度相关
- **建议**：检查VIF，必要时剔除

## 与其他任务的关系

| 相关任务 | 关系说明 |
|----------|----------|
| T41_survival_km_curve | 描述性分析 |
| T42_survival_logrank_test | 单因素比较 |
| T44_survival_cox_time_varying | 时变协变量扩展 |

## 技术说明

- **Stata 版本**：18.0+
- **外部依赖**：无，仅使用 Stata 官方命令
- **关键命令**：`stset`, `stdescribe`, `stcox`, `estat phtest`, `stcurve`
- **退出码**：错误时统一返回 200
