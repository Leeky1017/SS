# T16_chi_square_independence — 卡方独立性检验

## 任务元信息

| 属性 | 值 |
|------|-----|
| **Task ID** | T16_chi_square_independence |
| **任务名称** | 卡方独立性检验 |
| **任务族** | C - 假设检验 |
| **难度级别** | basic |
| **数据结构** | cross_section / panel（截面数据） |
| **金融场景适用** | ✓ 是 |

## 任务摘要

检验两个分类变量之间是否存在显著关联（独立性检验）。包含交叉表展示、Pearson卡方检验、Fisher精确检验（2×2表）、Cramér's V关联强度指标和堆叠条形图可视化。适用于分类变量间关联分析。

## 适用场景

### 场景 1：产权性质与审计意见
- **行变量**：产权性质（国企/民企）
- **列变量**：审计意见类型（标准/非标准）
- **应用**：检验企业产权性质与审计意见是否存在关联

### 场景 2：行业与融资约束
- **行变量**：行业分类
- **列变量**：融资约束程度（高/中/低）
- **应用**：检验不同行业的融资约束分布是否存在差异

### 场景 3：公司特征与信息披露
- **行变量**：公司规模组
- **列变量**：信息披露质量评级
- **应用**：检验公司规模与信息披露质量是否相关

### 场景 4：高管特征与战略选择
- **行变量**：CEO学历水平
- **列变量**：创新战略类型
- **应用**：检验高管学历与公司战略选择是否独立

## 理论背景

### Pearson卡方检验原理

**检验统计量**：
$$\chi^2 = \sum_{i=1}^{r}\sum_{j=1}^{c}\frac{(O_{ij} - E_{ij})^2}{E_{ij}}$$

其中：
- $O_{ij}$：第i行第j列的观测频数
- $E_{ij}$：第i行第j列的期望频数（独立性假设下）
- $E_{ij} = \frac{n_{i\cdot} \times n_{\cdot j}}{n}$

**自由度**：df = (r-1) × (c-1)

### Cramér's V 关联强度

$$V = \sqrt{\frac{\chi^2}{n \times \min(r-1, c-1)}}$$

| V 值范围 | 关联强度 | 解释 |
|----------|----------|------|
| < 0.1 | 弱关联 | 几乎独立 |
| 0.1-0.3 | 中等关联 | 存在一定关联 |
| 0.3-0.5 | 较强关联 | 关联明显 |
| ≥ 0.5 | 强关联 | 高度相关 |

### 前提假设
1. **分类变量**：两个变量都是分类型
2. **期望频数**：≥80%的单元格期望频数≥5
3. **独立观测**：各观测相互独立

## 数据文件要求

### 数据文件
- **首选**：`data.dta`（Stata 格式）
- **备选**：`data.csv`（自动转换为 data.dta）
- **编码**：UTF-8（推荐）

### 变量要求
- 行变量和列变量必须为分类变量（数值或字符型均可）
- 不允许完全缺失

## 输入与占位符说明

### 占位符列表

| 占位符 | 含义 | 类型 | 必填 | 合法取值示例 |
|--------|------|------|------|-------------|
| `__ROW_VAR__` | 行变量 | 单变量名 | ✓ 是 | `ownership` |
| `__COL_VAR__` | 列变量 | 单变量名 | ✓ 是 | `audit_opinion` |

### 渲染规则

```python
# Python 渲染示例
config = {
    "row_var": "ownership",
    "col_var": "audit_opinion"
}

placeholders = {
    "__ROW_VAR__": config["row_var"],
    "__COL_VAR__": config["col_var"]
}
```

## Stata 执行流程

```
┌─────────────────────────────────────────────────────────────┐
│ SECTION 0: 环境初始化与数据导入                             │
├─────────────────────────────────────────────────────────────┤
│ SECTION 1: 变量检查                                         │
├─────────────────────────────────────────────────────────────┤
│ SECTION 2: 交叉表（列联表）                                 │
│   - 频数表                                                  │
│   - 行/列百分比                                             │
├─────────────────────────────────────────────────────────────┤
│ SECTION 3: 卡方独立性检验                                   │
│   - 期望频数                                                │
│   - χ² 统计量                                               │
├─────────────────────────────────────────────────────────────┤
│ SECTION 4: 关联强度指标（Cramér's V）                       │
├─────────────────────────────────────────────────────────────┤
│ SECTION 5: Fisher 精确检验（2×2表）                         │
├─────────────────────────────────────────────────────────────┤
│ SECTION 6: 检验结论汇总                                     │
├─────────────────────────────────────────────────────────────┤
│ SECTION 7: 可视化                                           │
├─────────────────────────────────────────────────────────────┤
│ SECTION 8: 导出结果文件                                     │
└─────────────────────────────────────────────────────────────┘
```

## 输出文件清单与 Schema

### 0. result.log

任务执行日志，包含卡方检验过程、统计输出、警告信息和检验结论。

### 1. table_T16_chi2_result.csv

卡方检验结果汇总表。

| 列名 | 类型 | 说明 |
|------|------|------|
| `row_var` | string | 行变量名 |
| `col_var` | string | 列变量名 |
| `n_obs` | integer | 样本量 |
| `n_row` | integer | 行变量类别数 |
| `n_col` | integer | 列变量类别数 |
| `chi2` | float | χ²统计量 |
| `df` | float | 自由度 |
| `p_value` | float | p值 |
| `cramers_v` | float | Cramér's V |
| `fisher_p` | float | Fisher精确检验p值（2×2表） |
| `significance` | string | 显著性标记 |

### 2. table_T16_crosstab.csv

交叉表（宽格式）。

### 3. fig_T16_stacked_bar.png

堆叠条形图（PNG格式）。

## 上层 JSON 配置示例

### 示例 1：产权性质与审计意见

```json
{
  "task_id": "T16_chi_square_independence",
  "description": "检验产权性质与审计意见的关联",
  "row_var": "ownership",
  "col_var": "audit_opinion"
}
```

**场景说明**：检验国企与民企在审计意见分布上是否存在显著差异。

### 示例 2：行业与融资约束

```json
{
  "task_id": "T16_chi_square_independence",
  "description": "检验行业与融资约束程度的关联",
  "row_var": "industry_type",
  "col_var": "fc_level"
}
```

**场景说明**：检验不同行业类型的融资约束程度分布是否存在差异。

## 报告写作骨架

### 论文"分类变量关联"章节结构

```markdown
## X.X 分类变量关联分析

为检验[行变量]与[列变量]之间是否存在关联，本文采用卡方独立性检验。
表X报告了交叉表和检验结果。

从频数分布来看，[描述观测到的分布模式]。例如，在[行变量=A]组中，
[列变量=X]的比例为[%]，而在[行变量=B]组中该比例为[%]。

Pearson卡方检验结果显示，χ²=[chi2]（df=[df]），p值为[p]，
在[1%/5%/10%]水平下[显著/不显著]。Cramér's V=[V]，
表明两变量之间存在[弱/中等/强]关联。

上述结果表明，[行变量]与[列变量][存在/不存在]显著关联，
[支持/不支持]研究假设H[X]。

### 表X 交叉表与卡方检验结果
──────────────────────────────────────────────────────────
              列变量
行变量        类别1      类别2      Total
──────────────────────────────────────────────────────────
类别A         500        300        800
             (62.5%)    (37.5%)
类别B         400        600       1,000
             (40.0%)    (60.0%)
──────────────────────────────────────────────────────────
χ²=50.25, df=1, p<0.001***, V=0.167
──────────────────────────────────────────────────────────
```

## 常见坑与建议

### 1. 期望频数过低
- **问题**：>20%单元格期望频数<5
- **建议**：合并类别或使用Fisher精确检验

### 2. 混淆显著性与关联强度
- **问题**：大样本时弱关联也会显著
- **建议**：同时报告Cramér's V

### 3. 类别过多
- **问题**：表格稀疏，检验效力下降
- **建议**：合并相似类别

### 4. 忽略行/列百分比
- **问题**：只看频数不看比例
- **建议**：重点关注行或列百分比的差异

### 5. 应用于连续变量
- **问题**：连续变量不适用卡方检验
- **建议**：先分组或使用相关/回归分析

## 特殊情况处理

### 2×2表的特殊指标
```stata
tabulate row_var col_var, chi2 exact or
* or选项计算比值比（Odds Ratio）
```

### McNemar检验（配对数据）
```stata
mcc var1 var2
```

### 期望频数检查
```stata
tabulate row_var col_var, expected
* 检查是否有期望频数<5的单元格
```

## 与其他任务的关系

| 相关任务 | 关系说明 |
|----------|----------|
| T08_freq_categorical | 单变量频数分析 |
| T15_anova_oneway | 连续因变量的多组比较 |
| T13_ttest_two_sample | 连续变量两组比较 |
| T09_corr_matrix | 连续变量的相关分析 |

## 技术说明

- **Stata 版本**：18.0+
- **外部依赖**：无，仅使用 Stata 官方命令
- **关键命令**：`tabulate`, `graph bar`
- **退出码**：错误时统一返回 200
