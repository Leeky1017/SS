# T48_hierarchical_clustering — 层次聚类（Hierarchical Clustering）

## 任务元信息

| 属性 | 值 |
|------|-----|
| **Task ID** | T48_hierarchical_clustering |
| **任务名称** | 层次聚类 |
| **任务族** | I - 多变量与无监督学习 |
| **难度级别** | intermediate |
| **数据结构** | cross_sectional |
| **金融场景适用** | ✓ 是 |

## 任务摘要

进行层次聚类分析，生成树状图和聚类标签。**无需预设K值的聚类方法**。

## 适用场景

### 场景 1：探索性聚类
- **目的**：不确定簇数时探索结构
- **方法**：层次聚类+树状图
- **应用**：初步分析

### 场景 2：小样本聚类
- **目的**：样本量较小时的聚类
- **方法**：层次聚类
- **应用**：案例研究

### 场景 3：分类体系构建
- **目的**：构建层次分类体系
- **方法**：树状图分析
- **应用**：行业分类、产品分类

## 理论背景

### 凝聚型层次聚类

自底向上的聚类过程：
1. 每个样本初始为一个簇
2. 合并最近的两个簇
3. 重复直到所有样本合并为一个簇

### 连接方法

| 方法 | 说明 | 特点 |
|------|------|------|
| **single** | 最近邻距离 | 易形成链状 |
| **complete** | 最远邻距离 | 紧凑簇 |
| **average** | 平均距离 | 折中，常用 |
| **ward** | 最小方差增量 | 倾向等大小簇 |

### 树状图（Dendrogram）

- **Y轴**：合并距离
- **切割水平**：决定簇数
- **垂直线长度**：反映簇间差异

## 数据文件要求

### 数据文件
- **首选**：`data.dta`（Stata 格式）
- **备选**：`data.csv`（自动转换为 data.dta）
- **编码**：UTF-8（推荐）

### 变量要求
- 所有聚类变量必须为数值型
- 建议无缺失值或预先处理
- 样本量不宜过大（<500 为佳）

## 输入与占位符说明

### 占位符列表

| 占位符 | 含义 | 类型 | 必填 | 合法取值示例 |
|--------|------|------|------|-------------|
| `__NUMERIC_VARS__` | 聚类变量列表 | 多变量名 | ✓ 是 | `x1 x2 x3` |
| `__LINKAGE_METHOD__` | 连接方法 | 字符串 | ✓ 是 | `average` |

### 连接方法选项

- `single`：单连接
- `complete`：完全连接
- `average`：平均连接
- `ward`：Ward法

## 输出文件清单与 Schema

### 0. result.log

任务执行日志，包含描述统计、变量标准化、层次聚类结果、树状图和各簇特征。

### 1. table_T48_clusters.csv

聚类结果表。

| 列名 | 类型 | 说明 |
|------|------|------|
| `cluster3` | int | 3簇标签 |
| `cluster4` | int | 4簇标签 |
| `[原始变量]` | float | 原始变量值 |

### 2. fig_T48_dendrogram.png

树状图（PNG格式）。

## 上层 JSON 配置示例

```json
{
  "task_id": "T48_hierarchical_clustering",
  "description": "企业层次分类",
  "numeric_vars": ["size", "age", "leverage"],
  "linkage_method": "ward"
}
```

## 报告写作骨架

```markdown
## X.X 层次聚类分析

为探索[研究对象]的自然分组结构，本文采用层次聚类方法。
使用[Ward/平均]连接法，基于[变量列表]进行聚类。

图X展示了树状图。根据树状图的形态和分支高度，
本文选择将样本分为[K]个簇。

表X报告了各簇的特征。簇1（N=[n1]）的特征为[高XX、低YY]；
簇2（N=[n2]）的特征为...

### 图X 层次聚类树状图
[插入 fig_T48_dendrogram.png]

注：使用Ward连接法，变量已标准化。

### 表X 各簇特征
─────────────────────────────────────────────────────────────
簇        样本数        Size        Age        Leverage
─────────────────────────────────────────────────────────────
簇1        120          Large       Old         Low
簇2        250          Medium      Young       High
簇3         80          Small       Old         Medium
─────────────────────────────────────────────────────────────
```

## 常见坑与建议

### 1. 大样本问题
- **问题**：样本多时树状图难以阅读
- **建议**：考虑抽样或K-means

### 2. 连接方法选择
- **问题**：不同方法结果差异大
- **建议**：Ward法通常效果较好

### 3. 簇数确定
- **问题**：主观切割树状图
- **建议**：观察分支高度跳跃点

### 4. 计算复杂度
- **问题**：O(n²)空间和时间
- **建议**：大样本优先考虑K-means

## 与其他任务的关系

| 相关任务 | 关系说明 |
|----------|----------|
| T47_kmeans_clustering | K-means（需预设K） |
| T45_pca_principal_components | 降维后聚类 |

## 技术说明

- **Stata 版本**：18.0+
- **外部依赖**：无，仅使用 Stata 官方命令
- **关键命令**：`cluster [linkage]linkage`, `cluster dendrogram`, `cluster generate`
- **退出码**：错误时统一返回 200
