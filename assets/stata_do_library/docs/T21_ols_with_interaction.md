# T21_ols_with_interaction — 含交互项的回归（调节效应分析）

## 任务元信息

| 属性 | 值 |
|------|-----|
| **Task ID** | T21_ols_with_interaction |
| **任务名称** | 含交互项的回归 |
| **任务族** | D - 线性回归 |
| **难度级别** | intermediate |
| **数据结构** | cross_section / panel |
| **金融场景适用** | ✓ 是 |

## 任务摘要

估计包含变量交互项的回归模型，分析调节效应（Moderation Effect）。包含简单斜率分析、边际效应计算和可视化。**金融/会计研究中检验异质性影响的核心方法**。

## 适用场景

### 场景 1：产权性质调节效应
- **核心变量**：研发投入
- **调节变量**：产权性质（国企=1）
- **研究问题**：研发投入对绩效的影响是否因产权性质而异

### 场景 2：市场化程度调节
- **核心变量**：政治关联
- **调节变量**：市场化指数
- **研究问题**：政治关联的价值是否因市场化程度而变化

### 场景 3：机构投资者调节
- **核心变量**：盈余管理
- **调节变量**：机构持股比例
- **研究问题**：机构投资者能否抑制盈余管理的负面影响

### 场景 4：分析师关注调节
- **核心变量**：信息披露质量
- **调节变量**：分析师跟踪数量
- **研究问题**：分析师关注是否强化了信息披露的作用

## 理论背景

### 调节效应模型

$$Y = \beta_0 + \beta_1 X + \beta_2 M + \beta_3 (X \times M) + \gamma Controls + \varepsilon$$

- **X**：核心自变量
- **M**：调节变量
- **X × M**：交互项

### 边际效应解释

**X 对 Y 的边际效应**：
$$\frac{\partial Y}{\partial X} = \beta_1 + \beta_3 \times M$$

- 当 M = 0 时，X 的效应 = β₁
- 当 M 增加1单位，X 的效应变化 β₃

### 调节效应类型

| β₁ | β₃ | 调节类型 |
|----|-----|----------|
| + | + | 增强效应 |
| + | - | 削弱效应 |
| - | - | 增强（负向） |
| - | + | 削弱（负向） |

### 简单斜率分析

在调节变量的不同水平（如 M-1SD, M, M+1SD）检验 X 的效应：
- **低水平**：$\beta_1 + \beta_3 \times (M - SD_M)$
- **均值**：$\beta_1 + \beta_3 \times \bar{M}$
- **高水平**：$\beta_1 + \beta_3 \times (M + SD_M)$

## 数据文件要求

### 数据文件
- **首选**：`data.dta`（Stata 格式）
- **备选**：`data.csv`（自动转换为 data.dta）
- **编码**：UTF-8（推荐）

### 变量要求
- 因变量、核心自变量、调节变量必须为数值型
- 控制变量必须为数值型
- 不允许完全缺失

## 输入与占位符说明

### 占位符列表

| 占位符 | 含义 | 类型 | 必填 | 合法取值示例 |
|--------|------|------|------|-------------|
| `__DEPVAR__` | 因变量 | 单变量名 | ✓ 是 | `roa` |
| `__INDEPVARS__` | 控制变量 | 空格分隔变量 | ✓ 是 | `size lev` |
| `__INTERACT_VAR1__` | 核心自变量 | 单变量名 | ✓ 是 | `rd` |
| `__INTERACT_VAR2__` | 调节变量 | 单变量名 | ✓ 是 | `soe` |

### 渲染规则

```python
# Python 渲染示例
config = {
    "dep_var": "roa",
    "indep_vars": ["size", "lev", "growth"],
    "interact_var1": "rd",
    "interact_var2": "soe"
}

placeholders = {
    "__DEPVAR__": config["dep_var"],
    "__INDEPVARS__": " ".join(config["indep_vars"]),
    "__INTERACT_VAR1__": config["interact_var1"],
    "__INTERACT_VAR2__": config["interact_var2"]
}
```

## Stata 执行流程

```
┌─────────────────────────────────────────────────────────────┐
│ SECTION 0: 环境初始化与数据导入                             │
├─────────────────────────────────────────────────────────────┤
│ SECTION 1: 变量检查                                         │
├─────────────────────────────────────────────────────────────┤
│ SECTION 2: 变量描述统计                                     │
├─────────────────────────────────────────────────────────────┤
│ SECTION 3: 基准模型（无交互项）                             │
├─────────────────────────────────────────────────────────────┤
│ SECTION 4: 交互项模型                                       │
├─────────────────────────────────────────────────────────────┤
│ SECTION 5: 交互效应解读                                     │
├─────────────────────────────────────────────────────────────┤
│ SECTION 6: 边际效应分析（简单斜率）                         │
├─────────────────────────────────────────────────────────────┤
│ SECTION 7: 模型比较                                         │
├─────────────────────────────────────────────────────────────┤
│ SECTION 8: 可视化                                           │
├─────────────────────────────────────────────────────────────┤
│ SECTION 9: 导出结果文件                                     │
└─────────────────────────────────────────────────────────────┘
```

## 输出文件清单与 Schema

### 0. result.log

任务执行日志，包含回归过程、交互效应解读、边际效应分析、模型比较和结果摘要。

### 1. table_T21_reg_interaction.csv

回归结果表（含交互项）。

| 列名 | 类型 | 说明 |
|------|------|------|
| `variable` | string | 变量名 |
| `coef` | float | 回归系数 |
| `se` | float | 标准误 |
| `t` | float | t统计量 |
| `p` | float | p值 |
| `sig` | string | 显著性标记 |

### 2. fig_T21_margins.png

边际效应图（PNG格式）。

## 上层 JSON 配置示例

### 示例 1：产权性质调节效应

```json
{
  "task_id": "T21_ols_with_interaction",
  "description": "检验产权性质对研发-绩效关系的调节效应",
  "dep_var": "roa",
  "indep_vars": ["size", "lev", "growth", "age"],
  "interact_var1": "rd",
  "interact_var2": "soe"
}
```

**场景说明**：检验国企与非国企中研发投入对ROA影响的差异。

### 示例 2：市场化程度调节

```json
{
  "task_id": "T21_ols_with_interaction",
  "description": "检验市场化程度对政治关联价值的调节效应",
  "dep_var": "tobinq",
  "indep_vars": ["size", "lev", "age"],
  "interact_var1": "pc",
  "interact_var2": "market"
}
```

## 报告写作骨架

### 论文"调节效应分析"章节结构

```markdown
## X.X 调节效应分析

为检验[调节变量]对[核心变量]-[因变量]关系的调节作用，本文构建如下模型：

$$ Y_{it} = \beta_0 + \beta_1 X_{it} + \beta_2 M_{it} + \beta_3 (X_{it} \times M_{it}) + \sum_j \gamma_j Control_{jit} + \varepsilon_{it} $$

其中，X为[核心变量]，M为[调节变量]，X×M为交互项。若β₃显著，
表明[调节变量]对[核心变量]与[因变量]之间的关系存在调节效应。

表X报告了回归结果。交互项X×M的系数为[β₃]（t=[t]），
在[1%/5%/10%]水平下显著[为正/为负]。这表明[调节变量]
[增强/削弱]了[核心变量]对[因变量]的影响。

具体而言，当[调节变量]处于[低/高]水平时，[核心变量]对[因变量]的
边际效应为[计算值]，[显著/不显著]；当[调节变量]处于[高/低]水平时，
边际效应变为[计算值]，[显著性]发生了[增强/削弱/反转]。

图X展示了[核心变量]在不同[调节变量]水平下的边际效应，
直观地呈现了调节效应的模式。

### 表X 调节效应回归结果
─────────────────────────────────────────────────────────────
                   (1)无交互      (2)含交互
─────────────────────────────────────────────────────────────
X               0.035***        0.025***
               (0.008)         (0.009)
M               0.012           0.010
               (0.010)         (0.010)
X × M                           0.020**
                               (0.008)
─────────────────────────────────────────────────────────────
Controls          Yes             Yes
N               10,000          10,000
R²              0.085           0.092
─────────────────────────────────────────────────────────────
注：括号内为标准误；***、**、*分别表示在1%、5%、10%水平下显著。
```

## 常见坑与建议

### 1. 遗漏主效应
- **问题**：只放交互项不放主效应
- **建议**：必须同时包含 X、M 和 X×M

### 2. 多重共线性
- **问题**：交互项与主效应高度相关
- **建议**：对连续变量进行中心化处理

### 3. 只看交互项显著性
- **问题**：忽略边际效应的实际意义
- **建议**：计算并报告简单斜率

### 4. 变量尺度影响
- **问题**：交互项系数受变量单位影响
- **建议**：标准化或中心化后解释

### 5. 因果推断问题
- **问题**：调节变量可能是内生的
- **建议**：讨论识别策略，考虑工具变量

## 变量中心化说明

```stata
* 中心化处理（减少多重共线性）
summarize x, meanonly
generate x_c = x - r(mean)

summarize m, meanonly
generate m_c = m - r(mean)

generate xm_c = x_c * m_c
regress y x_c m_c xm_c controls
```

## 与其他任务的关系

| 相关任务 | 关系说明 |
|----------|----------|
| T18_ols_multiple | 无交互项的基准回归 |
| T20_ols_cluster_se | 可加聚类标准误 |
| T30_panel_fe | 面板固定效应+交互项 |

## 技术说明

- **Stata 版本**：18.0+
- **外部依赖**：无，仅使用 Stata 官方命令
- **关键命令**：`regress`, `margins`, `marginsplot`
- **退出码**：错误时统一返回 200
