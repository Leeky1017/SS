# T31_panel_fe_basic — 面板固定效应回归（Panel Fixed Effects）

## 任务元信息

| 属性 | 值 |
|------|-----|
| **Task ID** | T31_panel_fe_basic |
| **任务名称** | 面板固定效应回归 |
| **任务族** | F - 面板数据与政策评估 |
| **难度级别** | intermediate |
| **数据结构** | panel |
| **金融场景适用** | ✓ 是 |

## 任务摘要

估计面板固定效应（FE）回归模型，控制不可观测的个体异质性。包含混合OLS比较、聚类标准误和固定效应显著性检验。**公司金融研究中控制公司固定特征的标准方法**。

## 适用场景

### 场景 1：控制公司固定特征
- **个体效应**：公司文化、管理能力、地理位置
- **目的**：消除遗漏变量偏误
- **应用**：公司绩效研究

### 场景 2：DID设计中的固定效应
- **个体效应**：处理组和控制组的固定差异
- **时间效应**：共同的宏观冲击
- **应用**：政策效果评估

### 场景 3：控制个人固定特征
- **个体效应**：能力、偏好、性格
- **目的**：识别时变变量的效应
- **应用**：劳动经济学

## 理论背景

### 固定效应模型

$$Y_{it} = \alpha_i + X_{it}'\beta + \varepsilon_{it}$$

- $\alpha_i$：个体固定效应（不随时间变化）
- $X_{it}$：时变自变量
- $\varepsilon_{it}$：特质误差

### 组内变换（Within Transformation）

对每个变量减去个体均值：
$$\tilde{Y}_{it} = Y_{it} - \bar{Y}_i$$
$$\tilde{X}_{it} = X_{it} - \bar{X}_i$$

估计：$\tilde{Y}_{it} = \tilde{X}_{it}'\beta + \tilde{\varepsilon}_{it}$

个体效应 $\alpha_i$ 被消除。

### R²类型

| R² | 公式 | 含义 |
|----|------|------|
| **Within** | $1 - \frac{SSR_{within}}{SST_{within}}$ | 解释组内变异 |
| **Between** | $Corr(\bar{Y}_i, \hat{\bar{Y}}_i)^2$ | 解释组间变异 |
| **Overall** | $Corr(Y_{it}, \hat{Y}_{it})^2$ | 总体拟合 |

### ρ（rho）的含义

$$\rho = \frac{\sigma_u^2}{\sigma_u^2 + \sigma_e^2}$$

- ρ 接近 1：个体效应主导，固定效应很重要
- ρ 接近 0：个体效应不重要

## 数据文件要求

### 数据文件
- **首选**：`data.dta`（Stata 格式）
- **备选**：`data.csv`（自动转换为 data.dta）
- **编码**：UTF-8（推荐）

### 变量要求
- 个体变量必须为数值型（如字符型需先 encode）
- 时间变量必须为数值型（年份或 Stata 日期）
- 面板结构：同一个体多个时期

## 输入与占位符说明

### 占位符列表

| 占位符 | 含义 | 类型 | 必填 | 合法取值示例 |
|--------|------|------|------|-------------|
| `__DEPVAR__` | 因变量 | 单变量名 | ✓ 是 | `roa` |
| `__INDEPVARS__` | 自变量列表 | 空格分隔变量 | ✓ 是 | `size lev growth` |
| `__ID_VAR__` | 个体标识 | 单变量名 | ✓ 是 | `stkcd` |
| `__TIME_VAR__` | 时间变量 | 单变量名 | ✓ 是 | `year` |

### 渲染规则

```python
config = {
    "dep_var": "roa",
    "indep_vars": ["size", "lev", "growth"],
    "id_var": "stkcd",
    "time_var": "year"
}

placeholders = {
    "__DEPVAR__": config["dep_var"],
    "__INDEPVARS__": " ".join(config["indep_vars"]),
    "__ID_VAR__": config["id_var"],
    "__TIME_VAR__": config["time_var"]
}
```

## 输出文件清单与 Schema

### 0. result.log

任务执行日志，包含混合OLS基准、固定效应回归、聚类标准误、固定效应F检验、模型比较和结果摘要。

### 1. table_T31_fe_coef.csv

FE回归系数表。

| 列名 | 类型 | 说明 |
|------|------|------|
| `variable` | string | 变量名 |
| `coef` | float | 系数 |
| `se` | float | 聚类标准误 |
| `t` | float | t统计量 |
| `p` | float | p值 |
| `sig` | string | 显著性标记 |

### 2. table_T31_fe_gof.csv

拟合优度指标表。

| 列名 | 类型 | 说明 |
|------|------|------|
| `n_obs` | int | 观测数 |
| `n_groups` | int | 个体数 |
| `r2_within` | float | Within R² |
| `r2_overall` | float | Overall R² |
| `rho` | float | 个体效应占比 |
| `f_stat` | float | 固定效应F统计量 |
| `f_p` | float | F检验p值 |

## 上层 JSON 配置示例

```json
{
  "task_id": "T31_panel_fe_basic",
  "description": "公司绩效的固定效应分析",
  "dep_var": "roa",
  "indep_vars": ["rd", "size", "lev", "growth"],
  "id_var": "stkcd",
  "time_var": "year"
}
```

## 报告写作骨架

```markdown
## X.X 固定效应回归分析

为控制不可观测的公司固定特征，本文采用面板固定效应模型：

$$ Y_{it} = \alpha_i + X_{it}'\beta + \varepsilon_{it} $$

其中 $\alpha_i$ 为公司固定效应，控制了公司层面不随时间变化的遗漏变量。

表X报告了固定效应回归结果。在控制公司固定效应后，[核心变量]的系数为[β]
（t=[t]），在[1%/5%/10%]水平下显著[为正/为负]。与混合OLS相比，
系数[增大/减小]了[%]，表明不考虑公司固定特征会导致[高估/低估]该效应。

模型的Within R²为[r2_w]，ρ为[rho]，表明约[rho*100]%的残差变异
来自公司间差异。固定效应的F检验（F=[f_stat]，p<0.01）表明公司效应
联合显著，使用固定效应模型是合适的。

### 表X 固定效应回归结果
─────────────────────────────────────────────────────────────
                   (1)混合OLS      (2)FE          (3)FE+聚类
─────────────────────────────────────────────────────────────
X               0.050***       0.030***       0.030**
               (0.010)        (0.008)        (0.012)
─────────────────────────────────────────────────────────────
公司固定效应        No             Yes            Yes
聚类标准误          No             No             Yes
N               28,000         28,000         28,000
R²/Within R²     0.15           0.08           0.08
─────────────────────────────────────────────────────────────
注：括号内为标准误；***、**、*分别表示在1%、5%、10%水平下显著。
```

## 常见坑与建议

### 1. 时不变变量被吸收
- **问题**：性别、行业等时不变变量无法估计
- **建议**：改用随机效应或添加交互项

### 2. 不使用聚类标准误
- **问题**：低估标准误
- **建议**：始终使用vce(cluster id_var)

### 3. Within R²很低
- **问题**：误以为模型不好
- **建议**：Within R²仅衡量组内解释力

### 4. 忘记固定效应检验
- **问题**：不知道是否需要FE
- **建议**：报告F检验结果

## 与其他任务的关系

| 相关任务 | 关系说明 |
|----------|----------|
| T30_panel_setup_check | 先设置面板 |
| T32_panel_re_basic | 随机效应替代 |
| T33_panel_fe_re_hausman | FE vs RE选择 |

## 技术说明

- **Stata 版本**：18.0+
- **外部依赖**：无，仅使用 Stata 官方命令
- **关键命令**：`xtset`, `xtreg, fe`, `vce(cluster)`
- **退出码**：错误时统一返回 200
