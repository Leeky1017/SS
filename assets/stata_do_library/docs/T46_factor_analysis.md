# T46_factor_analysis — 因子分析（Exploratory Factor Analysis）

## 任务元信息

| 属性 | 值 |
|------|-----|
| **Task ID** | T46_factor_analysis |
| **任务名称** | 因子分析 |
| **任务族** | I - 多变量与无监督学习 |
| **难度级别** | intermediate |
| **数据结构** | cross_sectional |
| **金融场景适用** | ✓ 是 |

## 任务摘要

进行探索性因子分析（EFA），提取潜在因子并进行旋转。**发现变量背后潜在结构的核心方法**。

## 适用场景

### 场景 1：问卷维度识别
- **目的**：识别问卷的潜在维度
- **方法**：因子分析
- **应用**：量表开发与验证

### 场景 2：潜变量构建
- **目的**：构建不可直接观测的变量
- **方法**：因子得分
- **应用**：金融发展指数、制度质量指数

### 场景 3：变量降维
- **目的**：将多个指标综合为少数因子
- **方法**：因子提取
- **应用**：风险因子识别

## 理论背景

### 因子模型

$$X_j = \lambda_{j1}F_1 + \lambda_{j2}F_2 + ... + \lambda_{jk}F_k + \varepsilon_j$$

- $X_j$：观测变量
- $F_k$：公共因子
- $\lambda_{jk}$：因子载荷
- $\varepsilon_j$：特殊因子

### 因子载荷

载荷表示变量与因子的相关程度：

| 载荷绝对值 | 关联强度 |
|------------|----------|
| **> 0.7** | 强关联 |
| **0.4-0.7** | 中等关联 |
| **< 0.4** | 弱关联 |

### 因子旋转

- **Varimax**：正交旋转，因子不相关，最常用
- **Promax**：斜交旋转，允许因子相关

### KMO检验

评估数据是否适合因子分析：

| KMO | 适合程度 |
|-----|----------|
| **> 0.9** | 非常适合 |
| **0.8-0.9** | 适合 |
| **0.7-0.8** | 一般 |
| **0.6-0.7** | 勉强可以 |
| **< 0.6** | 不适合 |

## 数据文件要求

### 数据文件
- **首选**：`data.dta`（Stata 格式）
- **备选**：`data.csv`（自动转换为 data.dta）
- **编码**：UTF-8（推荐）

### 变量要求
- 所有输入变量必须为数值型
- 建议无缺失值或预先处理
- 样本量建议至5-10倍于变量数

## 输入与占位符说明

### 占位符列表

| 占位符 | 含义 | 类型 | 必填 | 合法取值示例 |
|--------|------|------|------|-------------|
| `__NUMERIC_VARS__` | 数值变量列表 | 多变量名 | ✓ 是 | `q1 q2 q3 q4 q5 q6` |
| `__N_FACTORS__` | 提取因子数 | 整数 | ✓ 是 | `2` |

## 输出文件清单与 Schema

### 0. result.log

任务执行日志，包含描述统计、相关矩阵、KMO检验、因子分析结果、旋转载荷和结果摘要。

### 1. table_T46_loadings.csv

因子载荷矩阵（旋转后）。

| 列名 | 类型 | 说明 |
|------|------|------|
| `variable` | string | 变量名 |
| `Factor1` | float | 因子1载荷 |
| `Factor2` | float | 因子2载荷 |

### 2. table_T46_scores.csv

因子得分表。

| 列名 | 类型 | 说明 |
|------|------|------|
| `f1` | float | 因子1得分 |
| `f2` | float | 因子2得分 |

## 上层 JSON 配置示例

```json
{
  "task_id": "T46_factor_analysis",
  "description": "公司治理评价因子分析",
  "numeric_vars": ["board_size", "indep_ratio", "ceo_duality", "ownership_conc"],
  "n_factors": 2
}
```

## 报告写作骨架

```markdown
## X.X 因子分析

为提取[研究变量]的潜在维度，本文对[p]个指标进行探索性因子分析。

首先，KMO检验值为[KMO]（>[0.7]），Bartlett球形检验χ²=[χ²]（p<0.001），
表明数据适合进行因子分析。

根据特征值大于1的准则，提取[k]个公共因子，累计解释方差[%]。
表X报告了Varimax旋转后的因子载荷矩阵。

因子1主要由[变量1]（载荷=[l₁]）、[变量2]（载荷=[l₂]）等
高载荷变量构成，可命名为"[XX因子]"。
因子2主要由[变量3]（载荷=[l₃]）构成，可命名为"[YY因子]"。

### 表X 因子载荷矩阵（Varimax旋转）
─────────────────────────────────────────────────────────────
变量              因子1        因子2        共同度
─────────────────────────────────────────────────────────────
Board Size        0.82         0.15         0.70
Indep Ratio       0.78         0.22         0.66
CEO Duality       0.12         0.85         0.74
Ownership         0.18         0.79         0.66
─────────────────────────────────────────────────────────────
特征值            2.15         1.45
方差比例          35.8%        24.2%
累积方差          35.8%        60.0%
─────────────────────────────────────────────────────────────
注：载荷>0.5已加粗。KMO=0.78。
```

## 常见坑与建议

### 1. 因子数选择
- **问题**：主观确定因子数
- **建议**：结合特征值>1、碎石图、理论

### 2. 载荷过低
- **问题**：变量在所有因子上载荷都低
- **建议**：考虑剔除该变量

### 3. 交叉载荷
- **问题**：变量在多个因子上载荷都高
- **建议**：考虑斜交旋转或剔除

### 4. KMO过低
- **问题**：KMO < 0.6
- **建议**：不适合因子分析，考虑PCA

## 与其他任务的关系

| 相关任务 | 关系说明 |
|----------|----------|
| T45_pca_principal_components | PCA（无潜变量假设） |
| T07_descriptive_univariate | 前置描述统计 |

## 技术说明

- **Stata 版本**：18.0+
- **外部依赖**：无，仅使用 Stata 官方命令
- **关键命令**：`factor`, `estat kmo`, `rotate, varimax`, `estat loadings`, `predict, regression`
- **退出码**：错误时统一返回 200
