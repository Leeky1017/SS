# T30_panel_setup_check — 面板数据设置与检查（Panel Data Setup）

## 任务元信息

| 属性 | 值 |
|------|-----|
| **Task ID** | T30_panel_setup_check |
| **任务名称** | 面板数据设置与检查 |
| **任务族** | F - 面板数据与政策评估 |
| **难度级别** | basic |
| **数据结构** | panel |
| **金融场景适用** | ✓ 是 |

## 任务摘要

设置面板数据结构（xtset），检查平衡性、缺失情况，提供组内组间变异分解。**面板分析的第一步，必须在运行xtreg等命令前执行**。

## 适用场景

### 场景 1：公司年度面板
- **个体**：公司（stkcd）
- **时间**：年份（year）
- **应用**：公司财务研究

### 场景 2：公司季度面板
- **个体**：公司（stkcd）
- **时间**：季度（quarter）
- **应用**：盈余管理、业绩预测

### 场景 3：基金月度面板
- **个体**：基金（fund_id）
- **时间**：月份（month）
- **应用**：基金业绩研究

## 理论背景

### 面板数据结构

$$Y_{it} = \alpha + X_{it}'\beta + \mu_i + \varepsilon_{it}$$

- $i$：个体维度（N个个体）
- $t$：时间维度（T个时期）
- $\mu_i$：个体效应
- $\varepsilon_{it}$：特质误差

### 面板类型

| 类型 | 定义 | 特点 |
|------|------|------|
| **强平衡** | 所有个体都有完整T期 | N×T = 总观测数 |
| **弱平衡** | 各个体期数相同但不连续 | 有间隔 |
| **非平衡** | 各个体期数不同 | 存在缺失 |

### 组内组间分解

xtsum命令将变量变异分解为：
- **Overall**：总体标准差
- **Between**：组间标准差（个体间差异）
- **Within**：组内标准差（个体内时变）

## 数据文件要求

### 数据文件
- **首选**：`data.dta`（Stata 格式）
- **备选**：`data.csv`（自动转换为 data.dta）
- **编码**：UTF-8（推荐）

### 变量要求
- 个体变量为数值型（如字符型需先 encode）
- 时间变量为数值型（年份或 Stata 日期）
- 不允许重复观测（同一个体同一时期）

## 输入与占位符说明

### 占位符列表

| 占位符 | 含义 | 类型 | 必填 | 合法取值示例 |
|--------|------|------|------|-------------|
| `__ID_VAR__` | 个体标识变量 | 单变量名 | ✓ 是 | `stkcd` |
| `__TIME_VAR__` | 时间变量 | 单变量名 | ✓ 是 | `year` |

### 渲染规则

```python
config = {
    "id_var": "stkcd",
    "time_var": "year"
}

placeholders = {
    "__ID_VAR__": config["id_var"],
    "__TIME_VAR__": config["time_var"]
}
```

## 输出文件清单与 Schema

### 0. result.log

任务执行日志，包含面板设置、结构描述、平衡性检查、时间跨度、缺失值概况、组内组间分解和结果摘要。

### 1. table_T30_panel_structure.csv

面板结构摘要表。

| 列名 | 类型 | 说明 |
|------|------|------|
| `n_obs` | int | 总观测数 |
| `n_ids` | int | 个体数 |
| `n_times` | int | 时期数 |
| `t_min` | int | 起始时期 |
| `t_max` | int | 结束时期 |
| `balanced` | string | 面板类型 |
| `avg_t_per_id` | float | 平均每个体期数 |

## 上层 JSON 配置示例

```json
{
  "task_id": "T30_panel_setup_check",
  "description": "设置上市公司年度面板",
  "id_var": "stkcd",
  "time_var": "year"
}
```

## 报告写作骨架

```markdown
## X.X 数据与样本

### X.X.1 面板数据结构

本文使用[数据库名称]中[开始年份]-[结束年份]的上市公司数据，
构建公司-年度面板数据集。

表X报告了面板数据的基本结构。样本包含[N]家公司，
时间跨度为[T]年，共计[N×T]个公司-年度观测。
面板为[强平衡/非平衡]面板，平均每家公司有[avg_t]年的观测。

### 表X 面板数据结构
─────────────────────────────────────────────────────────────
公司数 (N)                    3,500
时期数 (T)                    10 (2014-2023)
总观测数                      28,000
面板类型                      非平衡面板
平均期数/公司                 8.0
─────────────────────────────────────────────────────────────
```

## 常见坑与建议

### 1. 忘记xtset
- **问题**：直接运行xtreg报错
- **建议**：必须先执行xtset

### 2. ID变量非数值
- **问题**：字符型股票代码无法xtset
- **建议**：使用encode转换或destring

### 3. 时间变量格式问题
- **问题**：日期格式无法识别
- **建议**：使用年份整数或Stata日期格式

### 4. 重复观测
- **问题**：同一个体同一时期有多条记录
- **建议**：使用duplicates drop或聚合

## 与其他任务的关系

| 相关任务 | 关系说明 |
|----------|----------|
| T31_panel_fe_basic | 固定效应回归 |
| T32_panel_re_basic | 随机效应回归 |
| T33_panel_fe_re_hausman | Hausman检验 |

## 技术说明

- **Stata 版本**：18.0+
- **外部依赖**：无，仅使用 Stata 官方命令
- **关键命令**：`xtset`, `xtdescribe`, `xtsum`, `misstable`
- **退出码**：错误时统一返回 200
