# T17_ols_simple — 简单线性回归（一元OLS）

## 任务元信息

| 属性 | 值 |
|------|-----|
| **Task ID** | T17_ols_simple |
| **任务名称** | 简单线性回归 |
| **任务族** | D - 线性回归 |
| **难度级别** | basic |
| **数据结构** | cross_section |
| **金融场景适用** | ✓ 是 |

## 任务摘要

估计单个自变量对因变量的线性关系（一元OLS回归）。包含相关性分析、回归估计、异方差检验（Breusch-Pagan、White）、残差正态性检验和可视化。适用于探索性分析和简单因果推断。

## 适用场景

### 场景 1：规模与绩效的简单关系
- **因变量**：ROA
- **自变量**：企业规模（Size）
- **应用**：初步探索规模与绩效的关系

### 场景 2：研发与创新产出
- **因变量**：专利数量
- **自变量**：研发投入
- **应用**：检验研发投入对创新产出的边际效应

### 场景 3：杠杆与价值
- **因变量**：Tobin's Q
- **自变量**：资产负债率
- **应用**：检验资本结构对公司价值的影响

### 场景 4：教育与收入
- **因变量**：收入水平
- **自变量**：教育年限
- **应用**：估计教育的回报率

## 理论背景

### 简单线性回归模型

$$Y_i = \beta_0 + \beta_1 X_i + \varepsilon_i$$

**OLS估计量**（最小化残差平方和）：
$$\hat{\beta}_1 = \frac{\sum(X_i - \bar{X})(Y_i - \bar{Y})}{\sum(X_i - \bar{X})^2} = \frac{Cov(X,Y)}{Var(X)}$$

$$\hat{\beta}_0 = \bar{Y} - \hat{\beta}_1 \bar{X}$$

### 拟合优度

**决定系数**：
$$R^2 = 1 - \frac{SS_{res}}{SS_{tot}} = \frac{SS_{reg}}{SS_{tot}}$$

**调整R²**：
$$R^2_{adj} = 1 - \frac{(1-R^2)(n-1)}{n-k-1}$$

### Gauss-Markov假设

| 假设 | 内容 | 违反后果 |
|------|------|----------|
| A1 | 线性：$Y = X\beta + \varepsilon$ | 模型设定偏误 |
| A2 | 随机抽样 | 估计量有偏 |
| A3 | 无完全共线性 | 无法估计 |
| A4 | 零条件均值：$E(\varepsilon|X)=0$ | 内生性偏误 |
| A5 | 同方差：$Var(\varepsilon|X)=\sigma^2$ | 标准误无效 |

## 数据文件要求

### 数据文件
- **首选**：`data.dta`（Stata 格式）
- **备选**：`data.csv`（自动转换为 data.dta）
- **编码**：UTF-8（推荐）

### 变量要求
- 因变量和自变量必须为数值型
- 不允许完全缺失

## 输入与占位符说明

### 占位符列表

| 占位符 | 含义 | 类型 | 必填 | 合法取值示例 |
|--------|------|------|------|-------------|
| `__DEPVAR__` | 因变量 | 单变量名 | ✓ 是 | `roa` |
| `__INDEP_VAR__` | 自变量 | 单变量名 | ✓ 是 | `size` |

### 渲染规则

```python
# Python 渲染示例
config = {
    "dep_var": "roa",
    "indep_var": "size"
}

placeholders = {
    "__DEPVAR__": config["dep_var"],
    "__INDEP_VAR__": config["indep_var"]
}
```

## Stata 执行流程

```
┌─────────────────────────────────────────────────────────────┐
│ SECTION 0: 环境初始化与数据导入                             │
├─────────────────────────────────────────────────────────────┤
│ SECTION 1: 变量检查                                         │
├─────────────────────────────────────────────────────────────┤
│ SECTION 2: 变量描述统计                                     │
├─────────────────────────────────────────────────────────────┤
│ SECTION 3: 相关性分析                                       │
├─────────────────────────────────────────────────────────────┤
│ SECTION 4: 简单线性回归                                     │
├─────────────────────────────────────────────────────────────┤
│ SECTION 5: 回归诊断                                         │
│   - 残差统计                                                │
│   - Breusch-Pagan 异方差检验                               │
│   - White 异方差检验                                        │
│   - 残差正态性检验                                          │
├─────────────────────────────────────────────────────────────┤
│ SECTION 6: 回归结果汇总                                     │
├─────────────────────────────────────────────────────────────┤
│ SECTION 7: 可视化                                           │
├─────────────────────────────────────────────────────────────┤
│ SECTION 8: 导出结果文件                                     │
└─────────────────────────────────────────────────────────────┘
```

## 输出文件清单与 Schema

### 0. result.log

任务执行日志，包含回归过程、诊断检验输出、警告信息和结果摘要。

### 1. table_T17_reg_result.csv

回归结果汇总表。

| 列名 | 类型 | 说明 |
|------|------|------|
| `model` | string | 模型类型 |
| `dep_var` | string | 因变量名 |
| `indep_var` | string | 自变量名 |
| `n_obs` | integer | 样本量 |
| `b_x` | float | 斜率系数 |
| `se_x` | float | 标准误 |
| `t_x` | float | t统计量 |
| `p_x` | float | p值 |
| `b_cons` | float | 截距 |
| `r2` | float | R² |
| `r2_adj` | float | 调整R² |
| `f_stat` | float | F统计量 |
| `f_p` | float | F检验p值 |
| `rmse` | float | 均方根误差 |
| `bp_chi2` | float | BP检验χ² |
| `bp_p` | float | BP检验p值 |
| `white_chi2` | float | White检验χ² |
| `white_p` | float | White检验p值 |
| `significance` | string | 显著性标记 |

### 2. 图表文件

| 文件 | 说明 |
|------|------|
| `fig_T17_scatter_fit.png` | 散点图+拟合线 |
| `fig_T17_residuals.png` | 标准化残差诊断图 |

## 上层 JSON 配置示例

### 示例 1：规模与绩效

```json
{
  "task_id": "T17_ols_simple",
  "description": "检验企业规模对ROA的影响",
  "dep_var": "roa",
  "indep_var": "size"
}
```

**场景说明**：估计企业规模每增加1单位对ROA的边际效应。

### 示例 2：研发与专利

```json
{
  "task_id": "T17_ols_simple",
  "description": "检验研发投入对专利产出的影响",
  "dep_var": "patents",
  "indep_var": "rd_intensity"
}
```

**场景说明**：估计研发强度对创新产出的影响。

## 报告写作骨架

### 论文"简单回归分析"章节结构

```markdown
## X.X 简单回归分析

为初步检验[自变量]对[因变量]的影响，本文估计如下简单线性回归模型：

$$ Y_i = \beta_0 + \beta_1 X_i + \varepsilon_i $$

其中，Y为[因变量]，X为[自变量]。

表X报告了OLS回归结果。[自变量]的系数为[β₁]（t=[t]），
在[1%/5%/10%]水平下[显著/不显著]。该系数表明，[自变量]每增加1单位，
[因变量]平均变化[β₁]单位。模型的R²为[R²]，表明[自变量]解释了
[因变量]变异的[R²×100]%。

Breusch-Pagan检验（χ²=[bp_chi2]，p=[bp_p]）和White检验
（χ²=[white_chi2]，p=[white_p]）结果表明，[存在/不存在]异方差问题。
[若存在异方差，后续分析将使用稳健标准误。]

### 表X 简单线性回归结果
──────────────────────────────────────────────────────────
                (1)
        被解释变量: Y
──────────────────────────────────────────────────────────
X               0.035***
               (0.008)
               [4.38]
常数项          0.125***
               (0.015)
──────────────────────────────────────────────────────────
N               10,000
R²              0.125
F统计量         19.18***
──────────────────────────────────────────────────────────
注：括号内为标准误，方括号内为t值；***、**、*分别表示在1%、5%、10%水平下显著。
```

## 常见坑与建议

### 1. 遗漏变量偏误
- **问题**：简单回归未控制混淆因素
- **建议**：使用多元回归（T18），控制其他变量

### 2. 异方差问题
- **问题**：BP/White检验显著
- **建议**：使用稳健标准误（T19）

### 3. 相关不等于因果
- **问题**：回归系数不代表因果效应
- **建议**：明确研究设计，考虑工具变量或自然实验

### 4. 极端值影响
- **问题**：离群点可能严重影响OLS估计
- **建议**：检查残差图，考虑缩尾处理

### 5. 非线性关系
- **问题**：真实关系可能是非线性的
- **建议**：检查残差图，考虑多项式或对数变换

## 与其他任务的关系

| 相关任务 | 关系说明 |
|----------|----------|
| T09_corr_matrix | 相关分析是回归的前置步骤 |
| T18_ols_multiple | 多元回归可控制混淆因素 |
| T19_ols_robust_se | 异方差时使用稳健标准误 |
| T11_scatter_matrix | 可视化检查线性关系 |

## 技术说明

- **Stata 版本**：18.0+
- **外部依赖**：无，仅使用 Stata 官方命令
- **关键命令**：`regress`, `estat hettest`, `estat imtest`, `predict`
- **退出码**：错误时统一返回 200
