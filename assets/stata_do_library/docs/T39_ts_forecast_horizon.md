# T39_ts_forecast_horizon — 时间序列预测（Time Series Forecasting）

## 任务元信息

| 属性 | 值 |
|------|-----|
| **Task ID** | T39_ts_forecast_horizon |
| **任务名称** | 时间序列预测 |
| **任务族** | G - 时间序列分析 |
| **难度级别** | intermediate |
| **数据结构** | time_series |
| **金融场景适用** | ✓ 是 |

## 任务摘要

基于ARIMA模型进行多期预测，输出点预测和95%置信区间。**时间序列分析的最终应用步骤**。

## 适用场景

### 场景 1：销售预测
- **目的**：预测未来销售额
- **方法**：ARIMA动态预测
- **应用**：库存管理、预算规划

### 场景 2：宏观预测
- **目的**：预测经济指标
- **方法**：多步向前预测
- **应用**：GDP、通胀预测

### 场景 3：需求预测
- **目的**：预测产品需求
- **方法**：短期预测
- **应用**：生产计划

## 理论背景

### 动态预测

对于h步向前预测：

$$\hat{Y}_{T+h|T} = E[Y_{T+h} | Y_1, ..., Y_T]$$

使用递归方式：
- 1步预测：使用实际值
- 2步预测：使用1步预测值
- h步预测：使用前h-1步预测值

### 预测误差

预测误差方差随预测期数增加：
$$Var(e_{T+h}) > Var(e_{T+1})$$

因此置信区间会逐渐变宽。

### 置信区间

95%置信区间：
$$\hat{Y}_{T+h} \pm 1.96 \times \sqrt{MSE_h}$$

## 数据文件要求

### 数据文件
- **首选**：`data.dta`（Stata 格式）
- **备选**：`data.csv`（自动转换为 data.dta）
- **编码**：UTF-8（推荐）

### 变量要求
- 时间变量必须为数值型
- 序列变量为数值型、连续变量
- 应已通过平稳性检验和ARIMA估计

## 输入与占位符说明

### 占位符列表

| 占位符 | 含义 | 类型 | 必填 | 合法取值示例 |
|--------|------|------|------|-------------|
| `__TIME_VAR__` | 时间变量 | 单变量名 | ✓ 是 | `month` |
| `__SERIES_VAR__` | 序列变量 | 单变量名 | ✓ 是 | `sales` |
| `__P__` | AR阶数 | 整数 | ✓ 是 | `1` |
| `__D__` | 差分阶数 | 整数 | ✓ 是 | `1` |
| `__Q__` | MA阶数 | 整数 | ✓ 是 | `1` |
| `__HORIZON__` | 预测期数 | 整数 | ✓ 是 | `12` |

## 输出文件清单与 Schema

### 0. result.log

任务执行日志，包含ARIMA估计、样本内拟合评估、动态预测结果和摘要。

### 1. table_T39_forecast.csv

预测结果表。

| 列名 | 类型 | 说明 |
|------|------|------|
| `time` | int/date | 预测时期 |
| `forecast` | float | 点预测 |
| `forecast_lo` | float | 95%置信下限 |
| `forecast_hi` | float | 95%置信上限 |

### 2. fig_T39_forecast.png

预测可视化图（PNG格式）。

## 上层 JSON 配置示例

```json
{
  "task_id": "T39_ts_forecast_horizon",
  "description": "未来12个月销售预测",
  "time_var": "month",
  "series_var": "sales",
  "p": 1,
  "d": 1,
  "q": 1,
  "horizon": 12
}
```

## 报告写作骨架

```markdown
## X.X 时间序列预测

基于前文估计的ARIMA([p],[d],[q])模型，本文对[变量名]进行
未来[h]期预测。表X报告了点预测值及95%置信区间。

从预测结果来看，[变量名]在未来[h]期内预计将
[上升/下降/保持平稳]，第[h]期预测值为[值]
（95% CI: [下限, 上限]）。

图X展示了历史数据与预测值的对比。可以观察到，
预测置信区间随预测期数增加而逐渐变宽，
反映了长期预测的不确定性增加。

### 表X 时间序列预测结果
─────────────────────────────────────────────────────────────
时期        点预测          95% CI下限      95% CI上限
─────────────────────────────────────────────────────────────
T+1        125.4           118.2           132.6
T+2        128.7           116.5           140.9
...
T+12       145.2           102.8           187.6
─────────────────────────────────────────────────────────────

### 图X 时间序列预测
[插入 fig_T39_forecast.png]

注：实线为历史实际值，虚线为预测值，阴影区域为95%置信区间。
```

## 常见坑与建议

### 1. 长期预测过度自信
- **问题**：忽略置信区间变宽
- **建议**：始终报告置信区间

### 2. 结构变化
- **问题**：假设未来结构不变
- **建议**：定期更新模型

### 3. 外推陷阱
- **问题**：预测期过长
- **建议**：短期预测更可靠

### 4. 季节性
- **问题**：未考虑季节模式
- **建议**：使用SARIMA

## 与其他任务的关系

| 相关任务 | 关系说明 |
|----------|----------|
| T38_ts_arima_estimation | ARIMA模型估计 |
| T36_ts_diagnostics_plots | 序列特征分析 |
| T37_ts_unit_root_adf | 平稳性检验 |

## 技术说明

- **Stata 版本**：18.0+
- **外部依赖**：无，仅使用 Stata 官方命令
- **关键命令**：`tsset`, `arima`, `predict, dynamic()`
- **退出码**：错误时统一返回 200
