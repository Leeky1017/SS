# T22_ols_fe_entity_dummies — 实体固定效应（Entity Fixed Effects）

## 任务元信息

| 属性 | 值 |
|------|-----|
| **Task ID** | T22_ols_fe_entity_dummies |
| **任务名称** | 实体固定效应 |
| **任务族** | D - 线性回归 |
| **难度级别** | intermediate |
| **数据结构** | panel |
| **金融场景适用** | ✓ 是 |

## 任务摘要

通过`areg`实现实体固定效应，控制不随时间变化的个体特征。包含固定效应联合显著性检验、模型比较和聚类标准误。**金融/会计面板数据研究的标准做法**。

## 适用场景

### 场景 1：公司固定效应
- **实体变量**：公司ID（stkcd）
- **控制因素**：公司文化、管理能力、行业地位等时不变因素
- **应用**：绝大多数公司金融研究

### 场景 2：个人固定效应
- **实体变量**：个人ID
- **控制因素**：能力、教育背景、个人特质
- **应用**：劳动经济学、高管特征研究

### 场景 3：地区固定效应
- **实体变量**：省份/城市ID
- **控制因素**：地理位置、气候、制度环境
- **应用**：区域经济研究

### 场景 4：行业固定效应
- **实体变量**：行业代码
- **控制因素**：行业特定的技术、市场结构
- **应用**：行业层面分析

## 理论背景

### 固定效应模型

$$Y_{it} = \alpha_i + \beta X_{it} + \varepsilon_{it}$$

- **$\alpha_i$**：实体固定效应（entity-specific intercept）
- **$X_{it}$**：时变自变量
- **$\varepsilon_{it}$**：误差项

### 组内变换（Within Transformation）

固定效应估计等价于对数据进行组内去均值：
$$Y_{it} - \bar{Y}_i = \beta(X_{it} - \bar{X}_i) + (\varepsilon_{it} - \bar{\varepsilon}_i)$$

### 固定效应的作用

| 控制因素 | 示例 |
|----------|------|
| 时不变遗漏变量 | 公司文化、管理能力 |
| 选择偏误 | 公司自选择进入特定行业 |
| 不可观测异质性 | 无法量化的公司特征 |

### 固定效应 vs 随机效应

| 方面 | 固定效应 | 随机效应 |
|------|----------|----------|
| 假设 | $\alpha_i$ 与 $X_{it}$ 相关 | $\alpha_i$ 与 $X_{it}$ 不相关 |
| 估计 | 组内变异 | 组内+组间变异 |
| 效率 | 较低 | 较高 |
| 一致性 | 总是一致 | 仅当假设成立 |

## 数据文件要求

### 数据文件
- **首选**：`data.dta`（Stata 格式）
- **备选**：`data.csv`（自动转换为 data.dta）
- **编码**：UTF-8（推荐）

### 变量要求
- 因变量和自变量必须为数值型
- 实体变量可为数值或字符型
- 面板数据结构（每个实体多期观测）

## 输入与占位符说明

### 占位符列表

| 占位符 | 含义 | 类型 | 必填 | 合法取值示例 |
|--------|------|------|------|-------------|
| `__DEP_VAR__` | 因变量 | 单变量名 | ✓ 是 | `roa` |
| `__INDEP_VARS__` | 自变量列表 | 空格分隔变量 | ✓ 是 | `size lev growth` |
| `__ENTITY_VAR__` | 实体变量 | 单变量名 | ✓ 是 | `stkcd` |

### 渲染规则

```python
# Python 渲染示例
config = {
    "dep_var": "roa",
    "indep_vars": ["size", "lev", "growth", "soe"],
    "entity_var": "stkcd"
}

placeholders = {
    "__DEP_VAR__": config["dep_var"],
    "__INDEP_VARS__": " ".join(config["indep_vars"]),
    "__ENTITY_VAR__": config["entity_var"]
}
```

## Stata 执行流程

```
┌─────────────────────────────────────────────────────────────┐
│ SECTION 0: 环境初始化与数据导入                             │
├─────────────────────────────────────────────────────────────┤
│ SECTION 1: 数据结构检查                                     │
├─────────────────────────────────────────────────────────────┤
│ SECTION 2: 混合OLS（Pooled OLS）                            │
├─────────────────────────────────────────────────────────────┤
│ SECTION 3: 实体固定效应（areg）                             │
├─────────────────────────────────────────────────────────────┤
│ SECTION 4: 固定效应联合显著性检验                           │
├─────────────────────────────────────────────────────────────┤
│ SECTION 5: 最终模型（聚类标准误）                           │
├─────────────────────────────────────────────────────────────┤
│ SECTION 6: 模型比较                                         │
├─────────────────────────────────────────────────────────────┤
│ SECTION 7: 导出结果文件                                     │
└─────────────────────────────────────────────────────────────┘
```

## 输出文件清单与 Schema

### 0. result.log

任务执行日志，包含混合OLS、固定效应回归、联合显著性检验、模型比较和结果摘要。

### 1. table_T22_reg_fe.csv

固定效应回归系数表。

| 列名 | 类型 | 说明 |
|------|------|------|
| `variable` | string | 变量名 |
| `coef` | float | 回归系数 |
| `cluster_se` | float | 聚类标准误 |
| `t` | float | t统计量 |
| `p` | float | p值 |
| `sig` | string | 显著性标记 |

## 上层 JSON 配置示例

### 示例 1：公司固定效应

```json
{
  "task_id": "T22_ols_fe_entity_dummies",
  "description": "控制公司固定效应的绩效回归",
  "dep_var": "roa",
  "indep_vars": ["size", "lev", "growth", "age"],
  "entity_var": "stkcd"
}
```

**场景说明**：按公司控制固定效应，利用公司内的时间变异识别效应。

### 示例 2：个人固定效应

```json
{
  "task_id": "T22_ols_fe_entity_dummies",
  "description": "控制个人固定效应的工资回归",
  "dep_var": "lnwage",
  "indep_vars": ["experience", "tenure", "training"],
  "entity_var": "person_id"
}
```

## 报告写作骨架

### 论文"固定效应回归"章节结构

```markdown
## X.X 基准回归分析

为控制不可观测的公司层面异质性，本文采用固定效应模型进行估计：

$$ Y_{it} = \alpha_i + \beta_1 X_{it} + \sum_j \gamma_j Control_{jit} + \varepsilon_{it} $$

其中，$\alpha_i$ 为公司固定效应，用于控制不随时间变化的公司特征。
表X报告了回归结果，括号内为按公司聚类的稳健标准误。

固定效应的联合显著性F检验结果（F=[F], p<0.01）表明，
存在显著的公司层面异质性，固定效应模型是必要的。

[核心变量]的系数为[β]（t=[t]），在[1%/5%/10%]水平下显著[为正/为负]。
该结果表明，在控制了公司固定效应后，[核心变量]对[因变量]仍有显著影响，
排除了公司层面不可观测因素的干扰。

### 表X 固定效应回归结果
─────────────────────────────────────────────────────────────
                   (1)Pooled      (2)FE
─────────────────────────────────────────────────────────────
X               0.035***        0.025***
               (0.008)         (0.010)
Size            0.012***        0.008**
               (0.002)         (0.003)
Lev            -0.045***       -0.030**
               (0.010)         (0.012)
─────────────────────────────────────────────────────────────
Firm FE           No             Yes
N               50,000          50,000
Firms              -             2,500
R²              0.085           0.450
Within R²          -            0.025
─────────────────────────────────────────────────────────────
注：括号内为按公司聚类的稳健标准误；
***、**、*分别表示在1%、5%、10%水平下显著。
```

## 常见坑与建议

### 1. 时不变变量被吸收
- **问题**：行业、产权性质等时不变变量系数无法估计
- **建议**：不放入模型，或使用随机效应

### 2. 忽略聚类标准误
- **问题**：使用默认标准误导致t值虚高
- **建议**：必须使用聚类标准误

### 3. Within R² 误解
- **问题**：认为固定效应模型R²低是问题
- **建议**：Within R²低是正常的，关注系数

### 4. 短面板问题
- **问题**：T很小时固定效应估计不准
- **建议**：确保有足够时间变异

### 5. 组间比较无效
- **问题**：想比较不同公司的差异
- **建议**：固定效应只利用组内变异

## 与其他任务的关系

| 相关任务 | 关系说明 |
|----------|----------|
| T18_ols_multiple | 不含固定效应的基准回归 |
| T20_ols_cluster_se | 聚类标准误 |
| T23_ols_fe_year | 年份固定效应 |
| T30_panel_fe | 双向固定效应（推荐） |

## 技术说明

- **Stata 版本**：18.0+
- **外部依赖**：无，仅使用 Stata 官方命令
- **关键命令**：`areg, absorb()`, `testparm`
- **退出码**：错误时统一返回 200
