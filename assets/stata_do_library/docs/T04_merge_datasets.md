# T04_merge_datasets — 数据集合并（横向）

## 任务元信息

| 属性 | 值 |
|------|-----|
| **Task ID** | T04_merge_datasets |
| **任务名称** | 数据集合并（横向） |
| **任务族** | A - 数据管理与预处理 |
| **难度级别** | basic |
| **数据结构** | cross_section / panel（均适用） |
| **金融场景适用** | ✓ 是 |

## 任务摘要

使用主键横向合并两个数据集（如将公司财务数据与治理数据合并），支持 1:1、m:1、1:m 多种合并类型，提供详细的合并诊断（匹配率、未匹配样本分析），并根据保留策略处理合并结果。

## 适用场景

### 场景 1：财务数据与治理数据合并
- **主数据集**：公司年度财务数据（stkcd × year）
- **辅助数据集**：公司治理数据（stkcd × year）
- **合并键**：股票代码 + 年份
- **合并类型**：1:1
- **目的**：研究公司治理对财务绩效的影响

### 场景 2：面板数据与截面特征合并
- **主数据集**：公司年度面板（stkcd × year）
- **辅助数据集**：公司时不变特征（stkcd）如注册地、行业
- **合并键**：股票代码
- **合并类型**：m:1
- **目的**：为面板数据添加公司固定特征

### 场景 3：交易数据与公司信息合并
- **主数据集**：股票日交易数据（stkcd × date）
- **辅助数据集**：公司基本信息（stkcd）
- **合并键**：股票代码
- **合并类型**：m:1
- **目的**：为交易数据添加公司属性

### 场景 4：事件与公告信息合并
- **主数据集**：公司事件数据（stkcd × event_date）
- **辅助数据集**：公告详细信息（stkcd × event_date）
- **合并键**：股票代码 + 事件日期
- **合并类型**：1:1
- **目的**：构建事件研究数据集

## 理论背景

### 数据合并的类型

| 合并类型 | 主数据集键 | 辅助数据集键 | 典型场景 |
|----------|------------|--------------|----------|
| 1:1 | 唯一 | 唯一 | 两个面板数据合并 |
| m:1 | 可重复 | 唯一 | 面板 + 截面特征 |
| 1:m | 唯一 | 可重复 | 截面 + 多条记录 |
| m:m | 可重复 | 可重复 | 慎用，可能产生笛卡尔积 |

### 合并结果标记（_merge）

| 值 | 含义 | SQL 类比 |
|----|------|----------|
| 1 | 仅在主数据集 | LEFT JOIN 中未匹配 |
| 2 | 仅在辅助数据集 | RIGHT JOIN 中未匹配 |
| 3 | 成功匹配 | INNER JOIN 部分 |

### 匹配率的重要性
- **高匹配率**（>95%）：数据质量好，合并键一致
- **中等匹配率**（80-95%）：可能存在数据源差异
- **低匹配率**（<80%）：需检查合并键是否正确

## 输入与占位符说明

### 占位符列表

| 占位符 | 含义 | 类型 | 必填 | 合法取值示例 |
|--------|------|------|------|-------------|
| `__MERGE_KEYS__` | 合并键变量 | 多变量名（空格分隔） | ✓ 是 | `stkcd year` |
| `__MERGE_TYPE__` | 合并类型 | 字符串 | ✓ 是 | `1:1` / `m:1` / `1:m` |
| `__KEEP_OPTION__` | 保留策略 | 字符串 | 否 | `matched` / `master` / `all` |

### 渲染规则

```python
# Python 渲染示例
config = {
    "merge_keys": ["stkcd", "year"],
    "merge_type": "1:1",
    "keep_option": "matched"  # 仅保留成功匹配
}

placeholders = {
    "__MERGE_KEYS__": " ".join(config["merge_keys"]),  # "stkcd year"
    "__MERGE_TYPE__": config.get("merge_type", "1:1"), # "1:1"
    "__KEEP_OPTION__": config.get("keep_option", "all") # "matched"
}
```

## 数据要求与前置条件

### 数据文件
- **data.csv**：主数据集（Master）
- **data_using.csv**：辅助数据集（Using）

### 变量要求
| 数据集 | 要求 | 不满足时的后果 |
|--------|------|---------------|
| 两个数据集 | 合并键变量必须存在 | 脚本报错退出 |
| 两个数据集 | 合并键数据类型应一致 | 匹配失败 |
| 1:1 合并 | 两边键都唯一 | 合并报错 |
| m:1 合并 | using 键唯一 | 合并报错 |
| 1:m 合并 | master 键唯一 | 合并报错 |

### 保留策略说明
| 策略 | 保留内容 | SQL 类比 |
|------|----------|----------|
| `matched` | 仅 _merge==3 | INNER JOIN |
| `master` | _merge==1 或 3 | LEFT JOIN |
| `using` | _merge==2 或 3 | RIGHT JOIN |
| `all` | 全部 | FULL OUTER JOIN |

## Stata 执行流程

```
┌─────────────────────────────────────────────────────────────┐
│ SECTION 0: 环境初始化                                       │
├─────────────────────────────────────────────────────────────┤
│ SECTION 1: 导入并检查辅助数据集                             │
│   - 检查合并键存在性                                        │
│   - 检查合并键唯一性                                        │
│   - 保存为临时文件                                          │
├─────────────────────────────────────────────────────────────┤
│ SECTION 2: 导入并检查主数据集                               │
│   - 检查合并键存在性                                        │
│   - 检查合并键唯一性                                        │
├─────────────────────────────────────────────────────────────┤
│ SECTION 3: 合并前预览                                       │
│   - 显示两个数据集的维度                                    │
├─────────────────────────────────────────────────────────────┤
│ SECTION 4: 执行合并                                         │
│   - merge __MERGE_TYPE__ __MERGE_KEYS__ using ...          │
├─────────────────────────────────────────────────────────────┤
│ SECTION 5: 合并结果诊断                                     │
│   - _merge 分布                                             │
│   - 匹配率计算                                              │
│   - 未匹配样本示例                                          │
├─────────────────────────────────────────────────────────────┤
│ SECTION 6: 处理合并结果                                     │
│   - 根据保留策略筛选                                        │
├─────────────────────────────────────────────────────────────┤
│ SECTION 7: 合并后数据检查                                   │
│   - 最终样本量                                              │
│   - 主键唯一性                                              │
├─────────────────────────────────────────────────────────────┤
│ SECTION 8: 导出结果文件                                     │
│   - table_T04_merge_report.csv                             │
│   - merged_data.csv / .dta                                 │
├─────────────────────────────────────────────────────────────┤
│ SECTION 9: 任务完成摘要                                     │
└─────────────────────────────────────────────────────────────┘
```

## 输出文件清单与 Schema

### 0. result.log

任务执行日志，记录合并过程、匹配率、警告信息。

### 1. table_T04_merge_report.csv

合并诊断报告。

| 列名 | 类型 | 说明 |
|------|------|------|
| `item` | string | 指标名称 |
| `value` | string | 指标值 |

**包含指标**：主数据集样本量、辅助数据集样本量、成功匹配数、匹配率、最终样本量

### 2. merged_data.csv / merged_data.dta

合并后的数据集，包含：
- 主数据集的所有变量
- 辅助数据集的所有变量（合并键除外）
- `merge_source`：数据来源标记（1=仅主、2=仅辅、3=匹配）

## 上层 JSON 配置示例

### 示例 1：财务数据与治理数据 1:1 合并

```json
{
  "task_id": "T04_merge_datasets",
  "description": "合并财务数据和公司治理数据",
  "merge_keys": ["stkcd", "year"],
  "merge_type": "1:1",
  "keep_option": "matched"
}
```

**场景说明**：将同为公司-年度面板的财务数据和治理数据合并，仅保留两边都有的观测。

### 示例 2：面板数据添加公司固定特征

```json
{
  "task_id": "T04_merge_datasets",
  "description": "为面板数据添加公司行业和地区信息",
  "merge_keys": ["stkcd"],
  "merge_type": "m:1",
  "keep_option": "master"
}
```

**场景说明**：将公司基本信息（行业、注册地等时不变特征）合并到公司-年度面板，保留主数据集所有观测。

## 报告写作骨架

### 论文"数据来源与处理"章节结构

```markdown
## X.X 数据来源与处理

### X.X.1 数据来源

本文使用的数据来自以下数据库：
- 财务数据：[数据库名]，包括 ROA、ROE、资产负债率等
- 治理数据：[数据库名]，包括董事会规模、独立董事比例等
- 股票交易数据：[数据库名]

### X.X.2 数据合并

我们以股票代码（stkcd）和年份（year）为键，将财务数据与治理数据进行匹配合并。
合并结果显示：
- 财务数据共 [N1] 条观测
- 治理数据共 [N2] 条观测
- 成功匹配 [N3] 条，匹配率为 [XX]%

未匹配样本的主要原因包括：[说明原因]
```

## 常见坑与建议

### 1. 合并键数据类型不一致
- **问题**：主数据集中 stkcd 是字符串，辅助数据集中是数值
- **建议**：合并前统一类型，用 `tostring` 或 `destring`

### 2. 合并键有前导零丢失
- **问题**：股票代码 "000001" 被读为数值 1
- **建议**：导入时用 `stringcols()` 保留字符格式

### 3. 选错合并类型
- **问题**：数据实际是 m:1 但用了 1:1，导致报错
- **建议**：先用 `duplicates report` 检查两边的键唯一性

### 4. 匹配率过低
- **问题**：匹配率低于预期
- **建议**：检查合并键变量名是否一致、数据时间范围是否重叠

### 5. 变量名冲突
- **问题**：两个数据集有同名变量（非合并键）
- **建议**：Stata 会保留主数据集的值，辅助数据集的被丢弃，注意检查

### 6. m:m 合并产生笛卡尔积
- **问题**：m:m 合并导致样本量暴增
- **建议**：尽量避免 m:m，如必须使用则检查结果样本量

### 7. 未处理的未匹配样本
- **问题**：未匹配样本保留导致后续分析出错
- **建议**：明确 `keep_option` 参数，通常研究中用 `matched`

### 8. 合并后未检查主键
- **问题**：合并后主键不再唯一
- **建议**：合并后用 `duplicates report` 再次检查

## 与其他任务的关系

| 相关任务 | 关系说明 |
|----------|----------|
| T01_desc_overview | 合并前后都可用 T01 检查数据质量 |
| T03_filter_and_sample | 合并后常需筛选样本 |
| T05_append_datasets | 纵向合并（追加观测） |
| T30_panel_setup | 合并后检查面板结构 |

## 技术说明

- **Stata 版本**：18.0+
- **外部依赖**：无，仅使用 Stata 官方命令
- **关键命令**：`merge`, `duplicates report`, `describe`, `tabulate`
