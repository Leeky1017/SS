# T15_anova_oneway — 单因素方差分析（One-way ANOVA）

## 任务元信息

| 属性 | 值 |
|------|-----|
| **Task ID** | T15_anova_oneway |
| **任务名称** | 单因素方差分析 |
| **任务族** | C - 假设检验 |
| **难度级别** | basic |
| **数据结构** | cross_section / panel（截面比较） |
| **金融场景适用** | ✓ 是 |

## 任务摘要

比较三组或更多组的均值是否存在显著差异。包含方差齐性检验（Levene检验）、ANOVA主效应检验、效应量（η²）计算、事后多重比较（Bonferroni、Scheffé）和分组可视化。适用于行业比较、地区差异、评级分组等多组比较场景。

## 适用场景

### 场景 1：行业间绩效差异
- **因变量**：ROA、ROE等绩效指标
- **分组变量**：行业代码（industry）
- **应用**：检验不同行业的财务绩效是否存在差异

### 场景 2：信用评级组别比较
- **因变量**：融资成本、债券利差
- **分组变量**：信用评级（AAA/AA/A/BBB）
- **应用**：检验不同评级企业的融资成本差异

### 场景 3：地区经济差异
- **因变量**：人均GDP、收入水平
- **分组变量**：地区（东部/中部/西部）
- **应用**：检验区域经济发展差异

### 场景 4：公司规模组别比较
- **因变量**：研发强度、投资效率
- **分组变量**：规模组（大/中/小）
- **应用**：检验不同规模企业的行为差异

## 理论背景

### 单因素方差分析原理

ANOVA将总变异分解为组间变异和组内变异：

$$SS_{total} = SS_{between} + SS_{within}$$

**F统计量**：
$$F = \frac{MS_{between}}{MS_{within}} = \frac{SS_{between}/df_{between}}{SS_{within}/df_{within}}$$

其中：
- $df_{between} = k - 1$（k为组数）
- $df_{within} = N - k$（N为总样本量）

### 效应量

**Eta-squared (η²)**：
$$\eta^2 = \frac{SS_{between}}{SS_{total}}$$

**Omega-squared (ω²)**（偏差校正）：
$$\omega^2 = \frac{SS_{between} - df_{between} \cdot MS_{within}}{SS_{total} + MS_{within}}$$

| η² 范围 | 效应大小 | 解释 |
|---------|----------|------|
| < 0.01 | 小效应 | 组间差异很小 |
| 0.01-0.06 | 中等效应 | 组间存在一定差异 |
| 0.06-0.14 | 较大效应 | 组间差异明显 |
| ≥ 0.14 | 大效应 | 组间差异很大 |

### 前提假设
1. **独立性**：各组样本相互独立
2. **正态性**：各组数据近似正态分布
3. **方差齐性**：各组方差相等（Levene检验）

## 输入与占位符说明

### 占位符列表

| 占位符 | 含义 | 类型 | 必填 | 合法取值示例 |
|--------|------|------|------|-------------|
| `__DEP_VAR__` | 因变量 | 单变量名 | ✓ 是 | `roa` |
| `__GROUP_VAR__` | 分组变量 | 单变量名 | ✓ 是 | `industry` |

### 渲染规则

```python
# Python 渲染示例
config = {
    "dep_var": "roa",
    "group_var": "industry"
}

placeholders = {
    "__DEP_VAR__": config["dep_var"],
    "__GROUP_VAR__": config["group_var"]
}
```

## 数据要求与前置条件

### 数据文件
- **首选**：`data.dta`（Stata 格式）
- **备选**：`data.csv`（自动转换为 data.dta）

### 变量要求
- 因变量必须存在且为数值类型
- 分组变量必须有至少 2 个类别

## Stata 执行流程

```
┌─────────────────────────────────────────────────────────────┐
│ SECTION 0: 环境初始化与标准化数据加载                         │
├─────────────────────────────────────────────────────────────┤
│ SECTION 1: 变量检查                                         │
├─────────────────────────────────────────────────────────────┤
│ SECTION 2: 分组描述统计                                     │
├─────────────────────────────────────────────────────────────┤
│ SECTION 3: 方差齐性检验（Levene检验）                       │
├─────────────────────────────────────────────────────────────┤
│ SECTION 4: 单因素方差分析                                   │
├─────────────────────────────────────────────────────────────┤
│ SECTION 5: 效应量（η², ω²）                                 │
├─────────────────────────────────────────────────────────────┤
│ SECTION 6: 事后多重比较                                     │
│   - Bonferroni                                              │
│   - Scheffé                                                 │
├─────────────────────────────────────────────────────────────┤
│ SECTION 7: 检验结论汇总                                     │
├─────────────────────────────────────────────────────────────┤
│ SECTION 8: 可视化                                           │
├─────────────────────────────────────────────────────────────┤
│ SECTION 9: 导出结果文件                                     │
└─────────────────────────────────────────────────────────────┘
```

## 输出文件清单与 Schema

### 0. result.log

任务执行日志，包含分组描述统计、方差齐性检验、ANOVA结果、事后多重比较和效应量输出。

### 1. table_T15_anova_result.csv

ANOVA结果汇总表。

| 列名 | 类型 | 说明 |
|------|------|------|
| `dep_var` | string | 因变量名 |
| `group_var` | string | 分组变量名 |
| `n_groups` | integer | 组数 |
| `n_obs` | integer | 总样本量 |
| `grand_mean` | float | 总体均值 |
| `ss_between` | float | 组间平方和 |
| `ss_within` | float | 组内平方和 |
| `f_stat` | float | F统计量 |
| `df_between` | float | 组间自由度 |
| `df_within` | float | 组内自由度 |
| `p_value` | float | p值 |
| `eta_sq` | float | η²效应量 |
| `levene_p` | float | Levene检验p值 |
| `significance` | string | 显著性标记 |

### 2. table_T15_group_stats.csv

分组描述统计表。

| 列名 | 类型 | 说明 |
|------|------|------|
| `group_var` | varies | 分组变量值 |
| `n` | integer | 样本量 |
| `mean` | float | 均值 |
| `sd` | float | 标准差 |
| `min` | float | 最小值 |
| `max` | float | 最大值 |

### 3. fig_T15_boxplot.png

分组箱线图（PNG格式）。

## 上层 JSON 配置示例

### 示例 1：行业绩效比较

```json
{
  "task_id": "T15_anova_oneway",
  "description": "检验不同行业的ROA差异",
  "dep_var": "roa",
  "group_var": "industry"
}
```

**场景说明**：检验不同行业企业的资产收益率是否存在显著差异。

### 示例 2：评级组别比较

```json
{
  "task_id": "T15_anova_oneway",
  "description": "检验不同信用评级的融资成本差异",
  "dep_var": "cost_of_debt",
  "group_var": "credit_rating"
}
```

**场景说明**：检验不同信用评级企业的债务融资成本是否存在差异。

## 报告写作骨架

### 论文"组间差异检验"章节结构

```markdown
## X.X 组间差异分析

为检验[分组变量]对[因变量]的影响，本文进行单因素方差分析。
表X报告了各组的描述统计和ANOVA结果。

从描述统计来看，[组1]的[因变量]均值最高（[mean1]），[组k]最低（[meank]）。
Levene方差齐性检验p=[levene_p]，[满足/不满足]方差齐性假设。

ANOVA结果显示，F统计量为[F]（df=[df_b],[df_w]），p值为[p]，
在[1%/5%/10%]水平下[显著/不显著]。η²效应量为[eta_sq]，属于[小/中/大]效应，
表明组间差异解释了总变异的[η²×100]%。

事后多重比较（Bonferroni校正）表明，[组i]与[组j]之间存在显著差异
（均值差=[diff]，p=[p_ij]），而其他组间差异不显著。

### 表X 单因素方差分析结果
──────────────────────────────────────────────────────────────────
分组        N        Mean       SD        F        p        η²
──────────────────────────────────────────────────────────────────
行业A      2,000    0.052     0.085
行业B      3,000    0.045     0.078
行业C      1,500    0.038     0.092
──────────────────────────────────────────────────────────────────
ANOVA                                   12.56   <0.001***   0.035
──────────────────────────────────────────────────────────────────
注：***、**、*分别表示在1%、5%、10%水平下显著。
```

## 常见坑与建议

### 1. ANOVA显著但不知哪组不同
- **问题**：ANOVA只告诉存在差异，不告诉具体哪组
- **建议**：必须进行事后多重比较

### 2. 组别数量过多
- **问题**：组数太多导致两两比较过多
- **建议**：考虑合并相似组别，或使用回归虚拟变量

### 3. 方差不齐
- **问题**：Levene检验显著，ANOVA假设不满足
- **建议**：使用Kruskal-Wallis非参数检验

### 4. 样本量严重不平衡
- **问题**：各组样本量差异很大
- **建议**：注意解读，考虑加权分析

### 5. 多重比较校正
- **问题**：两两比较增加假阳性风险
- **建议**：使用Bonferroni等校正方法

## 非参数替代方法

### Kruskal-Wallis检验（秩和检验）
```stata
kwallis dep_var, by(group_var)
```

### 两两比较后续
```stata
* 事后Dunn检验需要用户自行计算或使用第三方包
```

## 与其他任务的关系

| 相关任务 | 关系说明 |
|----------|----------|
| T13_ttest_two_sample | 两组比较用t检验 |
| T02_desc_by_group | 分组描述统计 |
| T17_reg_ols_basic | 虚拟变量回归是ANOVA的扩展 |
| T16_chi2_independence | 分类变量独立性检验 |

## 技术说明

- **Stata 版本**：18.0+
- **外部依赖**：无，仅使用 Stata 官方命令
- **关键命令**：`anova`, `oneway`, `robvar`, `tabstat`, `graph box`
