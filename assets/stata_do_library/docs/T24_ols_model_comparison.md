# T24_ols_model_comparison — 多模型对比（Model Comparison）

## 任务元信息

| 属性 | 值 |
|------|-----|
| **Task ID** | T24_ols_model_comparison |
| **任务名称** | 多模型对比 |
| **任务族** | D - 线性回归 |
| **难度级别** | intermediate |
| **数据结构** | cross_section / panel |
| **金融场景适用** | ✓ 是 |

## 任务摘要

比较多个回归模型的关键指标（R²、调整R²、AIC、BIC），进行嵌套模型检验（LR检验），帮助选择最优模型规格。**论文中展示模型稳健性和变量选择的标准方法**。

## 适用场景

### 场景 1：逐步加入控制变量
- **基础模型**：仅核心变量
- **完整模型**：加入所有控制变量
- **目的**：检验核心变量的稳健性

### 场景 2：比较不同变量集
- **模型1**：传统控制变量
- **模型2**：加入新理论变量
- **目的**：检验新变量的边际贡献

### 场景 3：模型规格检验
- **模型1**：线性规格
- **模型2**：加入平方项/交互项
- **目的**：检验非线性关系

## 理论背景

### 模型选择标准

| 指标 | 公式 | 选择规则 | 特点 |
|------|------|----------|------|
| **R²** | $1 - \frac{SSR}{SST}$ | 越高越好 | 会随变量增加而膨胀 |
| **调整R²** | $1 - \frac{SSR/(n-k)}{SST/(n-1)}$ | 越高越好 | 惩罚过多变量 |
| **AIC** | $-2\ln L + 2k$ | 越小越好 | 惩罚参数数量 |
| **BIC** | $-2\ln L + k\ln n$ | 越小越好 | 惩罚更重 |
| **RMSE** | $\sqrt{SSR/n}$ | 越小越好 | 预测精度 |

### 嵌套模型检验

**似然比检验（LR Test）**：
$$LR = 2(\ln L_{full} - \ln L_{restricted}) \sim \chi^2(q)$$

其中 $q$ 是新增参数数量。

- H0：新增变量的系数联合为零
- p < 0.05：拒绝H0，完整模型更优

### 非嵌套模型比较

当模型不嵌套时，使用信息准则：
- **AIC**：适合预测
- **BIC**：适合模型识别（大样本下更保守）

## 数据文件要求

### 数据文件
- **首选**：`data.dta`（Stata 格式）
- **备选**：`data.csv`（自动转换为 data.dta）
- **编码**：UTF-8（推荐）

### 变量要求
- 因变量和所有自变量必须为数值型
- 不允许完全缺失

## 输入与占位符说明

### 占位符列表

| 占位符 | 含义 | 类型 | 必填 | 合法取值示例 |
|--------|------|------|------|-------------|
| `__DEPVAR__` | 因变量 | 单变量名 | ✓ 是 | `roa` |
| `__BASE_VARS__` | 基础模型变量 | 空格分隔变量 | ✓ 是 | `size lev` |
| `__FULL_VARS__` | 完整模型变量 | 空格分隔变量 | ✓ 是 | `size lev growth age soe` |

### 渲染规则

```python
config = {
    "dep_var": "roa",
    "base_vars": ["size", "lev"],
    "full_vars": ["size", "lev", "growth", "age", "soe"]
}

placeholders = {
    "__DEPVAR__": config["dep_var"],
    "__BASE_VARS__": " ".join(config["base_vars"]),
    "__FULL_VARS__": " ".join(config["full_vars"])
}
```

## 输出文件清单与 Schema

### 0. result.log

任务执行日志，包含基础模型、完整模型、模型比较汇总、LR检验和系数对比表。

### 1. table_T24_model_comparison.csv

模型比较指标表。

| 列名 | 类型 | 说明 |
|------|------|------|
| `model` | string | 模型名称 |
| `n` | int | 样本量 |
| `k` | int | 参数数量 |
| `r2` | float | R² |
| `r2_adj` | float | 调整R² |
| `rmse` | float | 均方根误差 |
| `aic` | float | AIC |
| `bic` | float | BIC |

## 上层 JSON 配置示例

### 示例 1：逐步加入控制变量

```json
{
  "task_id": "T24_ols_model_comparison",
  "description": "比较仅核心变量与加入控制变量后的模型",
  "dep_var": "roa",
  "base_vars": ["rd"],
  "full_vars": ["rd", "size", "lev", "growth", "age", "soe"]
}
```

### 示例 2：检验新变量贡献

```json
{
  "task_id": "T24_ols_model_comparison",
  "description": "检验ESG变量的边际贡献",
  "dep_var": "tobinq",
  "base_vars": ["size", "lev", "growth", "roa"],
  "full_vars": ["size", "lev", "growth", "roa", "esg_score"]
}
```

## 报告写作骨架

### 论文"模型比较"章节结构

```markdown
## X.X 模型稳健性与变量选择

表X报告了不同模型规格的比较结果。列(1)为仅包含核心解释变量的基础模型，
列(2)为加入全部控制变量的完整模型。

从拟合优度来看，加入控制变量后，调整R²从[r2a_1]提高到[r2a_2]，
AIC从[aic_1]下降到[aic_2]，BIC从[bic_1]下降到[bic_2]，
表明完整模型的拟合效果更好。

似然比检验结果（LR χ²=[lr_chi2]，p<0.01）表明，新增控制变量联合显著，
完整模型显著优于基础模型。

重要的是，核心解释变量[X]的系数在两个模型中符号一致，
且均在[1%/5%/10%]水平下显著，表明本文主要结论是稳健的。

### 表X 模型比较
─────────────────────────────────────────────────────────────
                   (1)基础模型    (2)完整模型
─────────────────────────────────────────────────────────────
X               0.035***        0.030***
               (0.008)         (0.009)
Controls          No             Yes
─────────────────────────────────────────────────────────────
N               10,000          10,000
R²              0.025           0.085
Adj. R²         0.024           0.082
AIC             25000           24500
BIC             25020           24600
─────────────────────────────────────────────────────────────
LR Test                         χ²=500, p<0.01
─────────────────────────────────────────────────────────────
注：括号内为标准误；***、**、*分别表示在1%、5%、10%水平下显著。
```

## 常见坑与建议

### 1. 样本量不一致
- **问题**：缺失值导致不同模型样本量不同
- **建议**：先处理缺失值，确保样本一致

### 2. 只看R²
- **问题**：R²总是随变量增加而增加
- **建议**：优先看调整R²、AIC、BIC

### 3. 忽略经济意义
- **问题**：只关注统计指标
- **建议**：结合理论判断变量合理性

### 4. 过度拟合
- **问题**：加入太多无关变量
- **建议**：BIC惩罚更重，适合识别真实模型

### 5. 非嵌套模型误用LR检验
- **问题**：对非嵌套模型使用LR检验
- **建议**：非嵌套模型只能用AIC/BIC比较

## 模型选择决策树

```
是否嵌套模型？
├─ 是 → 使用LR检验
│       └─ p < 0.05 → 选择完整模型
│       └─ p ≥ 0.05 → 选择简约模型
└─ 否 → 使用AIC/BIC
        └─ 目标是预测 → 选AIC较小者
        └─ 目标是识别 → 选BIC较小者
```

## 与其他任务的关系

| 相关任务 | 关系说明 |
|----------|----------|
| T17_ols_simple | 简单回归 |
| T18_ols_multiple | 多元回归 |
| T21_ols_with_interaction | 交互项模型比较 |

## 技术说明

- **Stata 版本**：18.0+
- **外部依赖**：无，仅使用 Stata 官方命令
- **关键命令**：`regress`, `estimates store`, `lrtest`, `estimates table`
- **退出码**：错误时统一返回 200
