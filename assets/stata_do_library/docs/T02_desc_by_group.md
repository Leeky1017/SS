# T02_desc_by_group — 分组描述统计

## 任务元信息

| 属性 | 值 |
|------|-----|
| **Task ID** | T02_desc_by_group |
| **任务名称** | 分组描述统计 |
| **任务族** | A - 数据管理与预处理 |
| **难度级别** | basic |
| **数据结构** | cross_section / panel（均适用） |
| **金融场景适用** | ✓ 是 |

## 任务摘要

按指定分组变量（如行业、年份、产权性质、地区）对数值变量进行分组描述统计，输出各组的样本量、均值、标准差、分位数等核心统计量，并进行组间差异的初步统计检验（ANOVA/t检验），生成分组箱线图用于可视化比较。

## 适用场景

### 场景 1：按行业分组的财务指标比较
- 数据来源：上市公司财务数据
- 分组变量：行业代码（ind_code）或行业名称
- 分析变量：ROA、ROE、资产负债率、营收增长率
- 目的：了解不同行业的财务特征差异

### 场景 2：按产权性质分组的公司特征比较
- 数据来源：上市公司治理数据
- 分组变量：产权性质（国有/民营/外资）
- 分析变量：管理层薪酬、董事会规模、股权集中度
- 目的：比较不同产权性质企业的治理特征

### 场景 3：按年份分组的时序变化分析
- 数据来源：多年份面板数据
- 分组变量：年份（year）
- 分析变量：各财务指标
- 目的：观察指标随时间的变化趋势

### 场景 4：按地区分组的区域差异分析
- 数据来源：省份/城市级别数据
- 分组变量：地区（东部/中部/西部）或省份
- 分析变量：人均GDP、投资水平、消费水平
- 目的：分析区域经济差异

## 理论背景

### 分组描述统计的作用
分组描述统计是探索性数据分析的重要手段，通过比较不同组别的统计特征，可以：
1. 发现组间系统性差异
2. 为后续分组回归或交互项设置提供依据
3. 识别潜在的异质性效应

### 组间差异检验方法
- **两组比较**：独立样本 t 检验（参数）、Wilcoxon 秩和检验（非参数）
- **多组比较**：单因素方差分析（ANOVA）、Kruskal-Wallis 检验（非参数）
- **注意事项**：方差齐性假设、样本量要求

### 统计显著性与经济显著性
- 统计显著（p < 0.05）不等于经济显著
- 关注组间均值差异的**绝对大小**和**相对比例**
- 大样本下微小差异也可能统计显著

## 输入与占位符说明

### 占位符列表

| 占位符 | 含义 | 类型 | 必填 | 合法取值示例 |
|--------|------|------|------|-------------|
| `__GROUP_VAR__` | 分组变量 | 单变量名 | ✓ 是 | `industry` / `year` / `ownership` |
| `__NUMERIC_VARS__` | 待分析的数值变量 | 多变量名（空格分隔） | ✓ 是 | `roa roe leverage size` |

### 渲染规则

```python
# Python 渲染示例
config = {
    "group_var": "industry",
    "numeric_vars": ["roa", "roe", "leverage", "size"]
}

placeholders = {
    "__GROUP_VAR__": config["group_var"],                    # "industry"
    "__NUMERIC_VARS__": " ".join(config["numeric_vars"])     # "roa roe leverage size"
}
```

## 数据要求与前置条件

### 数据文件
- **首选**：`data.dta`（Stata 格式）
- **备选**：`data.csv`（自动转换为 data.dta）
- **编码**：UTF-8（推荐）

### 变量要求
| 变量 | 要求 | 不满足时的后果 |
|------|------|---------------|
| `__GROUP_VAR__` | 必须存在，可为数值或字符串 | 脚本报错退出 |
| `__GROUP_VAR__` | 建议 2-50 个组别 | 组数 >50 输出警告，<2 报错 |
| `__NUMERIC_VARS__` | 必须存在，应为数值型 | 缺失变量被跳过 |

### 样本量要求
- 每组建议 ≥ 30 个观测
- 样本量过小的组会输出警告
- 总样本量建议 ≥ 100

## Stata 执行流程

```
┌─────────────────────────────────────────────────────────────┐
│ SECTION 0: 环境初始化与数据导入                             │
├─────────────────────────────────────────────────────────────┤
│ SECTION 1: 变量存在性检查                                   │
│   - 检查分组变量和数值变量                                  │
├─────────────────────────────────────────────────────────────┤
│ SECTION 2: 分组变量概况                                     │
│   - 频数分布                                                │
│   - 组数和各组样本量检查                                    │
├─────────────────────────────────────────────────────────────┤
│ SECTION 3: 分组描述统计                                     │
│   - tabstat 分组统计                                        │
│   - 扩展分位数统计                                          │
├─────────────────────────────────────────────────────────────┤
│ SECTION 4: 组间差异初步检验                                 │
│   - 各变量 ANOVA / t检验                                    │
├─────────────────────────────────────────────────────────────┤
│ SECTION 5: 分组箱线图                                       │
│   - 导出 fig_T02_group_boxplot.png                         │
├─────────────────────────────────────────────────────────────┤
│ SECTION 6: 导出结果文件                                     │
│   - table_T02_group_means.csv                              │
│   - table_T02_group_stats.csv                              │
├─────────────────────────────────────────────────────────────┤
│ SECTION 7: 组间差异汇总                                     │
│   - ANOVA F检验结果汇总表                                  │
├─────────────────────────────────────────────────────────────┤
│ SECTION 8: 任务完成摘要                                     │
└─────────────────────────────────────────────────────────────┘
```

## 输出文件清单与 Schema

### 0. result.log

任务执行日志，包含所有控制台输出、警告信息和分组检验结果。

### 1. table_T02_group_means.csv

分组均值表，每行一个组别。

| 列名 | 类型 | 说明 |
|------|------|------|
| `__GROUP_VAR__` | string/int | 组别值 |
| `n` | integer | 该组样本量 |
| `var1` | float | 第一个变量的组内均值 |
| `var2` | float | 第二个变量的组内均值 |
| ... | ... | ... |

### 2. table_T02_group_stats.csv

详细分组统计表，每行一个组别。

| 列名 | 类型 | 说明 |
|------|------|------|
| `__GROUP_VAR__` | string/int | 组别值 |
| `n` | integer | 该组样本量 |
| `mean_var1` | float | 变量1组内均值 |
| `sd_var1` | float | 变量1组内标准差 |
| `median_var1` | float | 变量1组内中位数 |
| ... | ... | ... |

### 3. fig_T02_group_boxplot.png

分组箱线图，显示第一个分析变量在各组的分布。

- **X轴**：分组变量的各个类别
- **Y轴**：第一个分析变量的值
- **箱体**：25%-75% 分位数区间
- **中线**：中位数
- **须**：1.5倍四分位距内的最值
- **点**：异常值

## 上层 JSON 配置示例

### 示例 1：按行业分组的财务指标

```json
{
  "task_id": "T02_desc_by_group",
  "description": "不同行业上市公司财务指标比较",
  "group_var": "industry",
  "numeric_vars": ["roa", "roe", "leverage", "size", "growth"]
}
```

**场景说明**：比较制造业、服务业、科技业等不同行业上市公司的盈利能力、资本结构等财务特征。

### 示例 2：按产权性质分组

```json
{
  "task_id": "T02_desc_by_group",
  "description": "国有企业与民营企业特征比较",
  "group_var": "soe",
  "numeric_vars": ["roa", "executive_pay", "board_size", "top1_share"]
}
```

**场景说明**：比较国有企业（soe=1）和民营企业（soe=0）在盈利能力、高管薪酬、治理结构等方面的差异。

## 报告写作骨架

### 论文"分组描述统计"章节结构

```markdown
## X.X 分组描述统计

### X.X.1 样本分布

表 X 报告了按[分组变量]分组的样本分布情况。其中，[组别1]占比最高，为 XX%；
[组别2]占比 XX%...

### X.X.2 分组特征比较

表 X 报告了各组的描述性统计结果。可以观察到：
- 在 [变量1] 上，[组别A] 的均值（XX）显著高于/低于 [组别B]（XX），
  差异在 1%/5%/10% 水平上统计显著（F=XX，p=XX）。
- 在 [变量2] 上，各组差异不显著（F=XX，p=XX > 0.1）。

### X.X.3 分布可视化

图 X 以箱线图形式展示了 [变量] 在各组的分布情况。可以直观看出，
[组别A] 的分布更为集中/分散，中位数更高/更低...
```

### 分组描述统计表格式（论文表X）

```
表 X 按行业分组的描述性统计
─────────────────────────────────────────────────────────────────────────────
                    制造业          服务业          科技业          差异检验
变量            Mean    SD      Mean    SD      Mean    SD       F      p
─────────────────────────────────────────────────────────────────────────────
ROA            0.045   0.067   0.052   0.071   0.068   0.089   12.34  0.000***
ROE            0.089   0.156   0.095   0.162   0.112   0.201    8.56  0.000***
Leverage       0.456   0.198   0.412   0.189   0.378   0.175   15.67  0.000***
...
─────────────────────────────────────────────────────────────────────────────
N              5,234            3,456            2,890
─────────────────────────────────────────────────────────────────────────────
注：*** p<0.01, ** p<0.05, * p<0.1。差异检验采用单因素方差分析（ANOVA）。
```

## 常见坑与建议

### 1. 分组变量组数过多
- **问题**：如使用股票代码作为分组变量，组数可能达数千
- **建议**：使用行业、地区等聚合级别的分组变量

### 2. 某些组样本量过小
- **问题**：个别组样本量 < 10，统计量不稳定
- **建议**：关注日志警告，考虑合并小组或排除

### 3. 分组变量含缺失值
- **问题**：缺失值形成单独一组
- **建议**：检查 tabulate 输出中的"missing"组，决定是否排除

### 4. 字符型分组变量编码问题
- **问题**：字符型变量可能有前导/尾部空格
- **建议**：先用 `trim()` 清理或 `encode` 转为数值

### 5. 忽略方差齐性假设
- **问题**：ANOVA 假设各组方差相等
- **建议**：若组间方差差异大，考虑 Welch's ANOVA 或非参数检验

### 6. 过度解读统计显著性
- **问题**：大样本下微小差异也显著
- **建议**：同时关注均值差异的绝对值和标准化效应量

### 7. 组间样本量严重不均衡
- **问题**：某组占 90%，其他组各占 1-2%
- **建议**：考虑重新定义分组或使用加权方法

### 8. 时间分组的特殊性
- **问题**：按年份分组时，相邻年份观测不独立
- **建议**：注意解释时考虑时间相关性

## 与其他任务的关系

| 相关任务 | 关系说明 |
|----------|----------|
| T01_desc_overview | 本任务是 T01 的分组版本 |
| T13_ttest_two_sample | 两组比较时可用 t 检验深入分析 |
| T15_anova_oneway | 多组比较时可用 ANOVA 深入分析 |
| T21_ols_with_interaction | 发现组间差异后可在回归中加入交互项 |

## 技术说明

- **Stata 版本**：18.0+
- **外部依赖**：无，仅使用 Stata 官方命令
- **关键命令**：`tabstat`, `tabulate`, `oneway`, `ttest`, `collapse`, `graph box`
