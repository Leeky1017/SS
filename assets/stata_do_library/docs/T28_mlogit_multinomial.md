# T28_mlogit_multinomial — 多项Logit模型（Multinomial Logistic Regression）

## 任务元信息

| 属性 | 值 |
|------|-----|
| **Task ID** | T28_mlogit_multinomial |
| **任务名称** | 多项Logit模型 |
| **任务族** | E - 有限因变量模型 |
| **难度级别** | intermediate |
| **数据结构** | cross_section / panel |
| **金融场景适用** | ✓ 是 |

## 任务摘要

估计无序多分类因变量的Multinomial Logit模型，输出系数、相对风险比（RRR）和各类别边际效应。**适用于融资方式选择、支付方式选择等无自然顺序的多分类因变量**。

## 适用场景

### 场景 1：融资方式选择
- **因变量**：融资方式（股权=1, 债务=2, 内部=3）
- **自变量**：公司特征、财务状况
- **应用**：资本结构决策研究

### 场景 2：并购支付方式
- **因变量**：支付方式（现金=1, 股票=2, 混合=3）
- **自变量**：收购方/目标方特征
- **应用**：并购支付决策

### 场景 3：审计师选择
- **因变量**：审计师类型（四大=1, 非四大大所=2, 小所=3）
- **自变量**：公司特征、治理变量
- **应用**：审计师选择决定因素

### 场景 4：股利政策
- **因变量**：股利类型（不分配=0, 现金股利=1, 股票股利=2, 混合=3）
- **自变量**：财务特征、所有权结构
- **应用**：股利政策研究

## 理论背景

### 多项Logit模型

**概率模型**：
$$P(Y_i = j | X_i) = \frac{e^{X_i'\beta_j}}{\sum_{k=1}^{J} e^{X_i'\beta_k}}$$

**相对于基准类别的对数几率**：
$$\ln\frac{P(Y=j)}{P(Y=base)} = X'\beta_j$$

### 相对风险比（RRR）

$$RRR_j = e^{\beta_j}$$

| RRR值 | 解释 |
|-------|------|
| RRR > 1 | 更倾向于选择类别j（相对于基准） |
| RRR < 1 | 更倾向于选择基准类别 |
| RRR = 2 | 选择类别j的相对几率翻倍 |

### IIA假设

**Independence of Irrelevant Alternatives**：
- 任意两个选项之间的相对几率不受第三个选项影响
- 经典例子：红公交 vs 蓝公交

如果违反IIA，考虑使用：
- 嵌套Logit（nested logit）
- 混合Logit（mixed logit）

## 数据文件要求

### 数据文件
- **首选**：`data.dta`（Stata 格式）
- **备选**：`data.csv`（自动转换为 data.dta）
- **编码**：UTF-8（推荐）

### 变量要求
- 因变量为无序多分类整数（如1,2,3）
- 自变量必须为数值型
- 建议类别数不超过 5-6 个

## 输入与占位符说明

### 占位符列表

| 占位符 | 含义 | 类型 | 必填 | 合法取值示例 |
|--------|------|------|------|-------------|
| `__DEPVAR__` | 因变量（无序多分类） | 单变量名 | ✓ 是 | `financing` |
| `__INDEPVARS__` | 自变量列表 | 空格分隔变量 | ✓ 是 | `size lev roa` |
| `__BASE_CATEGORY__` | 基准类别 | 数值 | ✓ 是 | `1` |

### 渲染规则

```python
config = {
    "dep_var": "financing",
    "indep_vars": ["size", "lev", "roa", "growth"],
    "base_category": 1
}

placeholders = {
    "__DEPVAR__": config["dep_var"],
    "__INDEPVARS__": " ".join(config["indep_vars"]),
    "__BASE_CATEGORY__": str(config["base_category"])
}
```

## 输出文件清单与 Schema

### 0. result.log

任务执行日志，包含多项Logit回归、相对风险比（RRR）、边际效应、预测概率、拟合优度和结果摘要。

### 1. table_T28_mlogit_gof.csv

拟合优度指标表。

| 列名 | 类型 | 说明 |
|------|------|------|
| `n` | int | 样本量 |
| `n_categories` | int | 类别数 |
| `base_category` | int | 基准类别 |
| `ll` | float | 对数似然 |
| `pseudo_r2` | float | Pseudo R² |

## 上层 JSON 配置示例

```json
{
  "task_id": "T28_mlogit_multinomial",
  "description": "融资方式选择的多项Logit分析",
  "dep_var": "financing_type",
  "indep_vars": ["size", "lev", "roa", "growth", "tangibility"],
  "base_category": 1
}
```

## 报告写作骨架

```markdown
## X.X 多项Logit回归分析

由于因变量[Y]为无序多分类变量（类别1=X, 类别2=Y, 类别3=Z），
本文采用多项Logit模型，以类别[base]为基准类别：

$$ \ln\frac{P(Y=j)}{P(Y=base)} = X'\beta_j $$

表X报告了多项Logit回归结果，Panel A为相对于基准类别的系数估计，
Panel B为相对风险比（RRR）。

对于类别[j]（相对于基准类别），[核心变量]的RRR为[RRR]，
在[1%/5%/10%]水平下显著，表明该变量每增加1单位，
选择类别[j]相对于基准类别的几率[增加/减少] [(RRR-1)*100 / (1-RRR)*100]%。

### 表X 多项Logit回归结果
─────────────────────────────────────────────────────────────
                   类别2 vs 基准        类别3 vs 基准
                   RRR                  RRR
─────────────────────────────────────────────────────────────
Size            1.42***              0.85**
               [1.21,1.67]          [0.75,0.96]
─────────────────────────────────────────────────────────────
N               10,000
Pseudo R²        0.08
─────────────────────────────────────────────────────────────
注：方括号内为95%置信区间；***、**、*分别表示在1%、5%、10%水平下显著。
```

## 常见坑与建议

### 1. 基准类别选择不当
- **问题**：选择了样本量很小的类别作为基准
- **建议**：选择样本量最大或理论上最合理的类别

### 2. 忽略IIA假设
- **问题**：选项之间可能存在相似性
- **建议**：检验IIA或使用替代模型

### 3. 类别太多
- **问题**：类别数过多导致估计不稳定
- **建议**：合并相似类别，一般不超过5-6类

### 4. 解读为绝对概率
- **问题**：把RRR解读为绝对概率变化
- **建议**：RRR是相对于基准的几率变化

## 与其他任务的关系

| 相关任务 | 关系说明 |
|----------|----------|
| T25_logit_binary | 二元因变量用logit |
| T27_ologit_ordered | 有序因变量用ologit |

## 技术说明

- **Stata 版本**：18.0+
- **外部依赖**：无，仅使用 Stata 官方命令
- **关键命令**：`mlogit`, `margins`
- **退出码**：错误时统一返回 200
- **IIA检验**：通过分别排除某类别后重新估计，对比系数变化近似检验
