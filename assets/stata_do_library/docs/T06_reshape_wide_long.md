# T06_reshape_wide_long — 数据表形态转换（宽表/长表）

## 任务元信息

| 属性 | 值 |
|------|-----|
| **Task ID** | T06_reshape_wide_long |
| **任务名称** | 数据表形态转换（宽表/长表） |
| **任务族** | A - 数据管理与预处理 |
| **难度级别** | intermediate |
| **数据结构** | panel / repeated_measures |
| **金融场景适用** | ✓ 是 |

## 任务摘要

在宽表（wide format）和长表（long format）之间进行数据格式转换。宽表每个ID一行，时间变量作为列后缀；长表每个ID-时间组合一行，时间作为独立变量。面板数据分析通常需要长表格式。

## 适用场景

### 场景 1：数据库导出数据转换为面板格式
- **原始格式**：数据库导出的宽表（如 roa2018, roa2019, roa2020）
- **目标格式**：面板长表（id, year, roa）
- **转换方向**：wide → long
- **目的**：用于面板回归分析

### 场景 2：时间序列截面数据整理
- **原始格式**：多个股票的日收益率时间序列（长表）
- **目标格式**：每日一行，各股票收益率为列（宽表）
- **转换方向**：long → wide
- **目的**：用于投资组合分析或 Fama-MacBeth 回归

### 场景 3：问卷重复测量数据
- **原始格式**：多时点测量的宽表（score_t1, score_t2, score_t3）
- **目标格式**：长表（id, time, score）
- **转换方向**：wide → long
- **目的**：用于纵向数据分析或增长曲线模型

### 场景 4：汇总报表制作
- **原始格式**：详细的面板长表数据
- **目标格式**：各指标按年份展开的宽表
- **转换方向**：long → wide
- **目的**：制作可读性更好的汇总表格

## 理论背景

### 宽表 vs 长表

| 特征 | 宽表 (Wide) | 长表 (Long) |
|------|-------------|-------------|
| 每个ID | 仅一行 | 多行（每时期一行） |
| 时间变量 | 作为变量名后缀 | 作为独立变量 |
| 变量数 | 多（含时间后缀） | 少 |
| 样本量 | 少 | 多 |
| 适用分析 | 截面分析 | 面板分析、纵向分析 |

### 面板数据分析的数据格式要求
- **xtset 命令**：需要长表格式
- **面板回归（xtreg）**：需要长表格式
- **固定效应/随机效应**：需要长表格式
- **DID分析**：需要长表格式

### 转换原理
```
宽表:
id    roa2018   roa2019   roa2020
A     0.05      0.06      0.04

↓ reshape long roa, i(id) j(year)

长表:
id    year    roa
A     2018    0.05
A     2019    0.06
A     2020    0.04
```

## 输入与占位符说明

### 占位符列表

| 占位符 | 含义 | 类型 | 必填 | 合法取值示例 |
|--------|------|------|------|-------------|
| `__RESHAPE_DIRECTION__` | 转换方向 | 字符串 | ✓ 是 | `long` / `wide` |
| `__STUB_VARS__` | 转换变量（前缀） | 多变量名（空格分隔） | ✓ 是 | `roa roe` |
| `__ID_VAR__` | ID变量 | 多变量名（空格分隔） | ✓ 是 | `stkcd` / `stkcd province` |
| `__TIME_VAR__` | 时间变量名 | 单变量名 | ✓ 是 | `year` / `quarter` |

### 渲染规则

```python
# Python 渲染示例 - Wide to Long
config = {
    "reshape_direction": "long",
    "stub_vars": ["roa", "roe", "leverage"],
    "id_var": "stkcd",
    "time_var": "year"
}

placeholders = {
    "__RESHAPE_DIRECTION__": config["reshape_direction"],  # "long"
    "__STUB_VARS__": " ".join(config["stub_vars"]),        # "roa roe leverage"
    "__ID_VAR__": config["id_var"],                        # "stkcd"
    "__TIME_VAR__": config["time_var"]                     # "year"
}
```

## 数据要求与前置条件

### 数据文件
- **首选**：`data.dta`（Stata 格式）
- **备选**：`data.csv`（自动转换为 data.dta）

### Wide → Long 转换要求
| 要求 | 说明 | 不满足时的后果 |
|------|------|---------------|
| 变量名格式 | 必须是 `stub` + `数字后缀` | reshape 失败 |
| ID 唯一 | 每个ID只能有一行 | reshape 失败 |
| 后缀一致 | 所有 stub 变量后缀应相同 | 部分变量无法转换 |

### Long → Wide 转换要求
| 要求 | 说明 | 不满足时的后果 |
|------|------|---------------|
| ID+时间唯一 | 每个ID-时间组合只能有一行 | reshape 失败 |
| 时间变量 | 应为数值或有意义的字符 | 生成的变量名不规范 |

## Stata 执行流程

```
┌─────────────────────────────────────────────────────────────┐
│ SECTION 0: 环境初始化与数据导入                             │
├─────────────────────────────────────────────────────────────┤
│ SECTION 1: 原始数据结构分析                                 │
│   - 判断当前是宽表还是长表                                  │
│   - 检查ID变量                                              │
├─────────────────────────────────────────────────────────────┤
│ SECTION 2: 转换参数显示                                     │
│   - 验证转换方向与当前格式的一致性                          │
├─────────────────────────────────────────────────────────────┤
│ SECTION 3: 执行 reshape 转换                                │
│   - reshape __DIRECTION__ __STUBS__, i(__ID__) j(__TIME__) │
├─────────────────────────────────────────────────────────────┤
│ SECTION 4: 转换结果诊断                                     │
│   - 转换前后对比                                            │
│   - 数据预览                                                │
├─────────────────────────────────────────────────────────────┤
│ SECTION 5: 转换后数据验证                                   │
│   - ID/ID+时间 唯一性检查                                   │
│   - 时间变量分布                                            │
├─────────────────────────────────────────────────────────────┤
│ SECTION 6: 数据质量检查                                     │
│   - 描述统计                                                │
│   - 缺失值检查                                              │
├─────────────────────────────────────────────────────────────┤
│ SECTION 7: 导出结果文件                                     │
│   - table_T06_reshape_report.csv                           │
│   - reshaped_data.csv / .dta                               │
├─────────────────────────────────────────────────────────────┤
│ SECTION 8: 任务完成摘要                                     │
└─────────────────────────────────────────────────────────────┘
```

## 输出文件清单与 Schema

### 0. result.log

任务执行日志，记录转换过程、警告信息和诊断结果。

### 1. table_T06_reshape_report.csv

转换诊断报告。

| 列名 | 类型 | 说明 |
|------|------|------|
| `item` | string | 指标名称 |
| `value` | string | 指标值 |

**包含指标**：转换方向、转换前后样本量、转换前后变量数、唯一ID数

### 2. reshaped_data.csv / reshaped_data.dta

转换后的数据集。

**Wide → Long 后的结构**：
- `__ID_VAR__`：ID变量
- `__TIME_VAR__`：时间变量（新生成）
- `stub1, stub2, ...`：原 stub 变量（去掉后缀）

**Long → Wide 后的结构**：
- `__ID_VAR__`：ID变量
- `stub1_t1, stub1_t2, ...`：按时间展开的变量

## 上层 JSON 配置示例

### 示例 1：财务数据宽表转长表

```json
{
  "task_id": "T06_reshape_wide_long",
  "description": "将多年财务指标转换为面板格式",
  "reshape_direction": "long",
  "stub_vars": ["roa", "roe", "leverage", "size"],
  "id_var": "stkcd",
  "time_var": "year"
}
```

**场景说明**：原数据有 roa2018, roa2019, roa2020 等变量，转换为 stkcd, year, roa 的长表格式。

### 示例 2：面板数据转为截面宽表

```json
{
  "task_id": "T06_reshape_wide_long",
  "description": "将面板数据转换为各年份列的宽表",
  "reshape_direction": "wide",
  "stub_vars": ["roa"],
  "id_var": "stkcd",
  "time_var": "year"
}
```

**场景说明**：将长表面板数据转换为宽表，方便制作描述性统计表格。

## 报告写作骨架

### 论文"数据处理"章节结构

```markdown
## X.X 数据处理

### X.X.1 数据格式转换

从 [数据库] 下载的原始数据为宽表格式，各年度财务指标作为独立列
（如 ROA2018、ROA2019 等）。为进行面板数据分析，我们将数据转换为
长表格式，转换后每个公司-年度观测为一行，年份作为独立变量。

转换过程：
- 转换前：[N1] 条观测，[K1] 个变量
- 转换后：[N2] 条观测，[K2] 个变量
- 保持 [n_ids] 家公司不变
```

## 常见坑与建议

### 1. 变量名后缀不规范
- **问题**：变量名如 `roa_2018` 而非 `roa2018`
- **建议**：先用 `rename` 调整变量名格式

### 2. ID 变量不唯一（wide→long）
- **问题**：宽表中每个ID有多行
- **建议**：检查是否已经是长表，或先去重

### 3. ID+时间不唯一（long→wide）
- **问题**：同一公司同一年有多条记录
- **建议**：先去重或聚合（如取均值）

### 4. 时间后缀提取问题
- **问题**：时间后缀被错误提取（如 `roa18` 提取为 18 而非 2018）
- **建议**：确保变量名中的数字是完整的时间标识

### 5. 字符串时间后缀
- **问题**：后缀是字符串（如 `roa_q1, roa_q2`）
- **建议**：使用 `j(quarter) string` 选项

### 6. 缺失值产生
- **问题**：转换后某些 ID-时间组合出现缺失
- **建议**：正常现象（不平衡面板），检查是否符合预期

### 7. 复合ID问题
- **问题**：ID 由多个变量组成（如 firm_id + province）
- **建议**：在 `i()` 中指定所有ID变量

### 8. 转换方向错误
- **问题**：本已是长表却执行 reshape long
- **建议**：关注日志中的格式检测提示

## 与其他任务的关系

| 相关任务 | 关系说明 |
|----------|----------|
| T30_panel_setup | 转换为长表后用 xtset 声明面板 |
| T01_desc_overview | 转换前后检查数据结构 |
| T04_merge_datasets | 通常先合并再转换格式 |
| T31-T35 面板分析 | 面板回归需要长表格式 |

## 技术说明

- **Stata 版本**：18.0+
- **外部依赖**：无，仅使用 Stata 官方命令
- **关键命令**：`reshape long`, `reshape wide`, `duplicates`, `bysort`
- **注意**：统计唯一值数量采用官方命令 `bysort var: gen tag = _n==1` + `count if tag` 替代社区命令 `distinct`
