# T08_freq_categorical — 分类变量频数分布表

## 任务元信息

| 属性 | 值 |
|------|-----|
| **Task ID** | T08_freq_categorical |
| **任务名称** | 分类变量频数分布表 |
| **任务族** | B - 描述性统计 |
| **难度级别** | basic |
| **数据结构** | cross_section / panel / time_series（均适用） |
| **金融场景适用** | ✓ 是 |

## 任务摘要

输出分类变量的频数分布、百分比和累积百分比，支持交叉表分析和卡方检验，生成条形图可视化分布。用于描述样本的分类特征（如行业分布、地区分布、产权性质等）。

## 适用场景

### 场景 1：样本行业分布
- **变量**：行业代码（industry）
- **目的**：展示样本的行业构成，判断行业集中度
- **输出**：各行业样本量及占比

### 场景 2：产权性质分布
- **变量**：产权性质（ownership）
- **目的**：说明国有企业和民营企业的样本比例
- **输出**：国企/民企/外企等的样本分布

### 场景 3：年度样本分布
- **变量**：年份（year）
- **目的**：检查各年份的样本覆盖情况
- **输出**：确保时间分布均匀，无缺失年份

### 场景 4：分类变量交叉分析
- **变量**：产权性质 × 行业
- **目的**：分析不同产权企业的行业分布差异
- **输出**：交叉表和独立性卡方检验

## 理论背景

### 频数分析的作用
1. **样本代表性**：检验样本是否能代表总体
2. **分布均衡性**：识别是否存在样本偏差
3. **变量编码**：确认分类变量的取值范围
4. **数据质量**：发现异常编码或缺失值问题

### 常用统计量

| 统计量 | 说明 |
|--------|------|
| 频数 (n) | 各类别的观测数 |
| 百分比 (%) | 各类别占总样本的比例 |
| 累积百分比 | 从第一类别开始的累积比例 |
| 众数 | 频数最高的类别 |
| 类别数 | 不同取值的数量 |

### 交叉表与独立性检验
- **交叉表**：展示两个分类变量的联合分布
- **卡方检验**：检验两个分类变量是否独立
  - H0：两变量独立
  - H1：两变量相关
- **期望频数规则**：每个单元格期望频数应 ≥ 5

## 输入与占位符说明

### 占位符列表

| 占位符 | 含义 | 类型 | 必填 | 合法取值示例 |
|--------|------|------|------|-------------|
| `__CATEGORICAL_VARS__` | 分类变量列表 | 多变量名（空格分隔） | ✓ 是 | `industry ownership region` |

### 渲染规则

```python
# Python 渲染示例
config = {
    "categorical_vars": ["industry", "ownership", "region", "year"]
}

placeholders = {
    "__CATEGORICAL_VARS__": " ".join(config["categorical_vars"])
}
```

## 数据要求与前置条件

### 数据文件
- **首选**：`data.dta`（Stata 格式）
- **备选**：`data.csv`（自动转换为 data.dta）
- **编码**：UTF-8（推荐）

### 变量要求
| 要求 | 说明 | 不满足时的后果 |
|------|------|---------------|
| 变量存在 | 指定变量必须在数据中 | 该变量被跳过 |
| 有限类别 | 类别数应有限（建议 < 50） | 输出过长，图表跳过 |
| 编码规范 | 建议有值标签 | 输出可读性差 |

## Stata 执行流程

```
┌─────────────────────────────────────────────────────────────┐
│ SECTION 0: 环境初始化与数据导入                             │
├─────────────────────────────────────────────────────────────┤
│ SECTION 1: 变量存在性检查                                   │
├─────────────────────────────────────────────────────────────┤
│ SECTION 2: 各变量频数分布                                   │
│   - tabulate 输出                                          │
├─────────────────────────────────────────────────────────────┤
│ SECTION 3: 分类变量汇总统计                                 │
│   - 类别数、缺失数、众数                                    │
├─────────────────────────────────────────────────────────────┤
│ SECTION 4: 交叉表分析                                       │
│   - 两变量交叉表                                            │
│   - 卡方独立性检验                                          │
├─────────────────────────────────────────────────────────────┤
│ SECTION 5: 生成分布条形图                                   │
│   - fig_T08_bar_[var].png                                  │
├─────────────────────────────────────────────────────────────┤
│ SECTION 6: 导出结果文件                                     │
│   - table_T08_freq_summary.csv                             │
│   - table_T08_freq_detail.csv                              │
├─────────────────────────────────────────────────────────────┤
│ SECTION 7: 任务完成摘要                                     │
└─────────────────────────────────────────────────────────────┘
```

## 输出文件清单与 Schema

### 0. result.log

任务执行日志，包含频数分布输出、交叉表和卡方检验结果。

### 1. table_T08_freq_summary.csv

分类变量汇总统计表。

| 列名 | 类型 | 说明 |
|------|------|------|
| `variable` | string | 变量名 |
| `n_categories` | integer | 类别数 |
| `n_missing` | integer | 缺失观测数 |
| `pct_missing` | float | 缺失比例 |
| `mode_freq` | integer | 众数频数 |
| `mode_pct` | float | 众数占比 |

### 2. table_T08_freq_detail.csv

详细频数表（所有变量）。

| 列名 | 类型 | 说明 |
|------|------|------|
| `variable` | string | 变量名 |
| `category` | string | 类别值 |
| `frequency` | integer | 频数 |
| `percent` | float | 百分比 |
| `cum_percent` | float | 累积百分比 |

### 3. fig_T08_bar_[var].png

各分类变量的条形分布图（PNG格式，类别数≤20时生成）。

## 上层 JSON 配置示例

### 示例 1：样本分布描述

```json
{
  "task_id": "T08_freq_categorical",
  "description": "描述样本的行业、产权和地区分布",
  "categorical_vars": ["industry", "ownership", "province"]
}
```

**场景说明**：生成样本构成的描述性统计，用于论文"样本选择"部分。

### 示例 2：年度分布检查

```json
{
  "task_id": "T08_freq_categorical",
  "description": "检查各年份样本分布",
  "categorical_vars": ["year"]
}
```

**场景说明**：确认面板数据各年份的覆盖情况。

## 报告写作骨架

### 论文"样本分布"章节结构

```markdown
## X.X 样本分布

表X报告了样本的分类特征分布。从行业分布来看，制造业企业占比最高（[XX]%），
其次是批发零售业（[XX]%）和信息技术业（[XX]%），样本行业分布与A股整体结构基本一致。

从产权性质来看，国有企业占样本的[XX]%，民营企业占[XX]%，
这一比例与[引用]的研究样本相近。

从地区分布来看，东部地区企业占比[XX]%，中部地区[XX]%，西部地区[XX]%，
反映了我国上市公司的地域分布特征。

### 表X 样本分布
────────────────────────────────────
类别                   N        %
────────────────────────────────────
Panel A: 行业分布
  制造业              8,000    40.0
  批发零售            3,000    15.0
  信息技术            2,500    12.5
  ...
────────────────────────────────────
Panel B: 产权性质
  国有企业            6,000    30.0
  民营企业           12,000    60.0
  外资企业            2,000    10.0
────────────────────────────────────
```

## 常见坑与建议

### 1. 类别过多
- **问题**：行业有100+个类别，输出太长
- **建议**：先按大类归并，或只分析主要类别

### 2. 缺失值处理
- **问题**：大量样本的分类变量缺失
- **建议**：报告缺失情况，考虑是否需要排除

### 3. 编码不规范
- **问题**：同一类别有多种编码（如 1 和 01）
- **建议**：数据清洗阶段统一编码

### 4. 分布极度不均
- **问题**：某类别占90%以上
- **建议**：考虑是否需要分组分析或倾向得分匹配

### 5. 交叉表期望频数太小
- **问题**：卡方检验结果不可靠
- **建议**：合并低频类别或使用Fisher精确检验

### 6. 值标签缺失
- **问题**：输出只有编码数字，可读性差
- **建议**：为分类变量添加值标签

## 与其他任务的关系

| 相关任务 | 关系说明 |
|----------|----------|
| T07_summary_numeric | 数值变量用描述统计，分类变量用频数表 |
| T02_desc_by_group | 需要按分类变量分组分析时使用 |
| T12_chi_square_test | 进一步的独立性检验 |
| T17-T24 回归分析 | 分类变量需转为虚拟变量后入回归 |

## 技术说明

- **Stata 版本**：18.0+
- **外部依赖**：无，仅使用 Stata 官方命令
- **关键命令**：`tabulate`, `contract`, `graph bar`, `levelsof`
