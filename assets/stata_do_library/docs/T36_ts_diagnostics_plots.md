# T36_ts_diagnostics_plots — 时间序列诊断图（Time Series Diagnostics）

## 任务元信息

| 属性 | 值 |
|------|-----|
| **Task ID** | T36_ts_diagnostics_plots |
| **任务名称** | 时间序列诊断图 |
| **任务族** | G - 时间序列分析 |
| **难度级别** | basic |
| **数据结构** | time_series |
| **金融场景适用** | ✓ 是 |

## 任务摘要

生成时序图、自相关图（ACF）、偏自相关图（PACF），用于时间序列模式识别和ARIMA阶数选择。**时间序列建模的第一步**。

## 适用场景

### 场景 1：ARIMA阶数选择
- **目的**：确定p、d、q阶数
- **方法**：观察ACF/PACF截尾特征
- **应用**：预测模型构建

### 场景 2：平稳性初判
- **目的**：初步判断是否平稳
- **方法**：观察时序图趋势和ACF衰减
- **应用**：单位根检验前的视觉判断

### 场景 3：季节性识别
- **目的**：识别季节性模式
- **方法**：观察ACF周期性峰值
- **应用**：季节性ARIMA建模

## 理论背景

### 自相关函数（ACF）

$$\rho_k = Corr(Y_t, Y_{t-k}) = \frac{Cov(Y_t, Y_{t-k})}{Var(Y_t)}$$

衡量序列与其k期滞后的相关性。

### 偏自相关函数（PACF）

$$\phi_{kk} = Corr(Y_t - \hat{Y}_t, Y_{t-k} - \hat{Y}_{t-k})$$

衡量控制中间滞后后，序列与其k期滞后的相关性。

### ARIMA阶数识别

| 模式 | ACF特征 | PACF特征 |
|------|---------|----------|
| **AR(p)** | 拖尾（指数/振荡衰减） | p阶后截尾 |
| **MA(q)** | q阶后截尾 | 拖尾（指数/振荡衰减） |
| **ARMA(p,q)** | 拖尾 | 拖尾 |
| **非平稳** | 缓慢线性衰减 | 首阶极高 |

### 截尾与拖尾

- **截尾**：在某阶后迅速降为0（在置信带内）
- **拖尾**：缓慢衰减但不截断

## 数据文件要求

### 数据文件
- **首选**：`data.dta`（Stata 格式）
- **备选**：`data.csv`（自动转换为 data.dta）
- **编码**：UTF-8（推荐）

### 变量要求
- 时间变量必须为数值型（年份/季度/月份等）
- 序列变量为数值型
- 时间序列结构：按时间顺序排列

## 输入与占位符说明

### 占位符列表

| 占位符 | 含义 | 类型 | 必填 | 合法取值示例 |
|--------|------|------|------|-------------|
| `__TIME_VAR__` | 时间变量 | 单变量名 | ✓ 是 | `date` |
| `__SERIES_VAR__` | 序列变量 | 单变量名 | ✓ 是 | `gdp` |

## 输出文件清单与 Schema

### 0. result.log

任务执行日志，包含序列统计量、ACF/PACF分析、ARIMA阶数识别指导和结果摘要。

### 1. fig_T36_ts_line.png

时序折线图（PNG格式）。

### 2. fig_T36_acf_pacf.png

ACF与PACF组合诊断图（PNG格式）。

## 上层 JSON 配置示例

```json
{
  "task_id": "T36_ts_diagnostics_plots",
  "description": "GDP时间序列诊断",
  "time_var": "quarter",
  "series_var": "gdp_growth"
}
```

## 报告写作骨架

```markdown
## X.X 时间序列特征分析

### X.X.1 序列平稳性初步判断

图X.1展示了[变量名]的时序图。从图中可以看出，序列[存在/不存在]
明显的[趋势/季节性/结构断点]，初步判断为[平稳/非平稳]序列。

### 图X.1 时序图
[插入 fig_T36_ts_line.png]

### X.X.2 ACF与PACF分析

图X.2展示了序列的自相关函数（ACF）和偏自相关函数（PACF）。
ACF呈现[拖尾/q阶截尾]特征，PACF呈现[p阶截尾/拖尾]特征，
初步判断适合采用[AR(p)/MA(q)/ARMA(p,q)]模型。

### 图X.2 ACF与PACF诊断图
[插入 fig_T36_acf_pacf.png]

注：虚线为95%置信区间，超出虚线表示该滞后阶数显著。
```

## 常见坑与建议

### 1. 忽略平稳性
- **问题**：对非平稳序列直接识别阶数
- **建议**：先用T37单位根检验

### 2. 过度拟合
- **问题**：选择过高的p、q
- **建议**：遵循简约原则

### 3. 季节性混淆
- **问题**：把季节性当作非平稳
- **建议**：使用季节差分或SARIMA

## 与其他任务的关系

| 相关任务 | 关系说明 |
|----------|----------|
| T37_ts_unit_root_adf | 单位根检验确认平稳性 |
| T38_ts_arima_estimation | ARIMA模型估计 |
| T39_ts_forecast_horizon | 时间序列预测 |

## 技术说明

- **Stata 版本**：18.0+
- **外部依赖**：无，仅使用 Stata 官方命令
- **关键命令**：`tsset`, `tsline`, `ac`, `pac`, `corrgram`
- **退出码**：错误时统一返回 200
