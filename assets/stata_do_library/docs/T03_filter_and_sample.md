# T03_filter_and_sample — 数据筛选与抽样

## 任务元信息

| 属性 | 值 |
|------|-----|
| **Task ID** | T03_filter_and_sample |
| **任务名称** | 数据筛选与抽样 |
| **任务族** | A - 数据管理与预处理 |
| **难度级别** | basic |
| **数据结构** | cross_section / panel / time_series（均适用） |
| **金融场景适用** | ✓ 是 |

## 任务摘要

根据指定条件筛选样本（如剔除金融业、ST股票、缺失值、异常值等），可选进行关键变量缺失值剔除和随机抽样，输出筛选后的清洁数据集。记录分步筛选过程，方便论文中报告样本选择流程。

## 适用场景

### 场景 1：上市公司样本筛选
- **常见筛选条件**：
  - 剔除金融业（行业代码 J）
  - 剔除 ST/*ST 股票
  - 剔除上市不满一年的公司
  - 剔除资产为负或净资产为负的异常样本
- **目的**：构建干净的实证研究样本

### 场景 2：面板数据平衡化
- **常见筛选条件**：
  - 保留连续观测的公司
  - 要求至少有 N 年数据
  - 剔除新上市或退市公司
- **目的**：构建平衡面板或准平衡面板

### 场景 3：时间窗口筛选
- **常见筛选条件**：
  - 事件研究的时间窗口（如 [-5, +5]）
  - 政策实施前后的特定年份
  - 金融危机等特殊时期的剔除
- **目的**：聚焦特定时间段进行分析

### 场景 4：Winsorize 前的极端值剔除
- **常见筛选条件**：
  - 剔除 ROA > 1 或 ROA < -1 的异常值
  - 剔除负债率 > 1 的样本
  - 剔除市值为 0 的样本
- **目的**：排除数据错误或极端异常

## 理论背景

### 样本筛选的重要性
实证研究的样本筛选直接影响研究结论的可靠性和可比性。规范的样本筛选应：
1. **有理论依据**：每个筛选条件都有学术或实践原因
2. **透明可复制**：清晰记录每步筛选剔除的样本量
3. **符合惯例**：遵循领域内的通行做法

### 金融研究常见筛选惯例
| 筛选类型 | 常见条件 | 理由 |
|----------|----------|------|
| 行业筛选 | 剔除金融业 | 财务结构与一般企业差异大 |
| 状态筛选 | 剔除 ST 股票 | 财务异常，不具代表性 |
| 数据质量 | 剔除关键变量缺失 | 保证分析完整性 |
| 极端值 | 剔除或 Winsorize | 减少异常值影响 |

### 随机抽样的作用
- **大数据集降维**：提高计算效率
- **预分析测试**：先用小样本调试代码
- **Bootstrap 等方法**：需要重复抽样

## 输入与占位符说明

### 占位符列表

| 占位符 | 含义 | 类型 | 必填 | 合法取值示例 |
|--------|------|------|------|-------------|
| `__FILTER_CONDITION__` | 筛选条件（Stata语法） | Stata条件表达式 | ✓ 是 | `year >= 2010 & industry != "J"` |
| `__KEY_VARS__` | 关键变量（剔除缺失） | 多变量名（空格分隔） | 否 | `roa roe size` |
| `__SAMPLE_FRACTION__` | 抽样参数 | 数值 | 否 | `0.1`（10%）或 `1000`（1000条） |
| `__RANDOM_SEED__` | 随机种子 | 正整数 | 否 | `12345` |
| `__ID_VAR__` | 个体标识变量 | 单变量名 | 否 | `stkcd` |
| `__TIME_VAR__` | 时间标识变量 | 单变量名 | 否 | `year` |

### 渲染规则

```python
# Python 渲染示例
config = {
    "filter_condition": "year >= 2010 & year <= 2020 & industry != \"J\"",
    "key_vars": ["roa", "roe", "size"],
    "sample_fraction": 0,  # 0 表示不抽样
    "random_seed": 12345,
    "id_var": "stkcd",
    "time_var": "year"
}

placeholders = {
    "__FILTER_CONDITION__": config["filter_condition"],
    "__KEY_VARS__": " ".join(config.get("key_vars", [])),
    "__SAMPLE_FRACTION__": str(config.get("sample_fraction", 0)),
    "__RANDOM_SEED__": str(config.get("random_seed", 12345)),
    "__ID_VAR__": config.get("id_var", ""),
    "__TIME_VAR__": config.get("time_var", "")
}
```

## 数据要求与前置条件

### 数据文件
- **首选**：`data.dta`（Stata 格式）
- **备选**：`data.csv`（自动转换为 data.dta）
- **编码**：UTF-8（推荐）

### 筛选条件要求
| 要求 | 说明 | 不满足时的后果 |
|------|------|---------------|
| 语法正确 | 必须是有效的 Stata 条件表达式 | 脚本报错退出 |
| 变量存在 | 条件中的变量必须在数据中 | 脚本报错退出 |
| 结果非空 | 筛选后样本量 > 0 | 脚本报错退出 |

### 条件表达式语法
```stata
* 比较运算符
==    等于
!=    不等于
>     大于
<     小于
>=    大于等于
<=    小于等于

* 逻辑运算符
&     与
|     或
!     非

* 常用函数
missing(var)     判断缺失
!missing(var)    判断非缺失
inlist(var, 1, 2, 3)  变量值在列表中
inrange(var, a, b)    变量值在区间内
```

## Stata 执行流程

```
┌─────────────────────────────────────────────────────────────┐
│ SECTION 0: 环境初始化与数据导入                             │
├─────────────────────────────────────────────────────────────┤
│ SECTION 1: 原始数据概况                                     │
│   - 记录原始样本量                                          │
│   - 面板维度统计                                            │
├─────────────────────────────────────────────────────────────┤
│ SECTION 2: 筛选条件预检查                                   │
│   - 验证条件语法有效性                                      │
│   - 预览筛选结果                                            │
│   - 剔除比例警告                                            │
├─────────────────────────────────────────────────────────────┤
│ SECTION 3: 分步筛选记录                                     │
│   - 初始化筛选日志矩阵                                      │
├─────────────────────────────────────────────────────────────┤
│ SECTION 4: 应用主筛选条件                                   │
│   - keep if __FILTER_CONDITION__                           │
│   - 记录剔除数量                                            │
├─────────────────────────────────────────────────────────────┤
│ SECTION 5: 关键变量缺失值处理                               │
│   - 检查 __KEY_VARS__ 缺失情况                             │
│   - 剔除缺失观测                                            │
├─────────────────────────────────────────────────────────────┤
│ SECTION 6: 随机抽样（可选）                                 │
│   - 按比例或数量抽样                                        │
├─────────────────────────────────────────────────────────────┤
│ SECTION 7: 筛选后数据概况                                   │
│   - 最终样本量                                              │
│   - 保留比例                                                │
├─────────────────────────────────────────────────────────────┤
│ SECTION 8: 导出结果文件                                     │
│   - table_T03_filter_summary.csv                           │
│   - filtered_data.csv / .dta                               │
├─────────────────────────────────────────────────────────────┤
│ SECTION 9: 任务完成摘要                                     │
└─────────────────────────────────────────────────────────────┘
```

## 输出文件清单与 Schema

### 0. result.log

任务执行日志，记录分步筛选过程、警告信息和最终统计。

### 1. table_T03_filter_summary.csv

筛选过程汇总表，记录每步筛选的样本变化。

| 列名 | 类型 | 说明 |
|------|------|------|
| `step` | integer | 步骤编号（0=原始） |
| `description` | string | 筛选步骤描述 |
| `n_dropped` | integer | 本步剔除数量 |
| `n_remaining` | integer | 剩余样本量 |

### 2. filtered_data.csv

筛选后的数据集（CSV格式），保留所有原始变量。

### 3. filtered_data.dta

筛选后的数据集（Stata格式），保留所有原始变量和标签。

## 上层 JSON 配置示例

### 示例 1：标准上市公司样本筛选

```json
{
  "task_id": "T03_filter_and_sample",
  "description": "A股非金融上市公司2010-2020年样本",
  "filter_condition": "year >= 2010 & year <= 2020 & industry != \"J\" & st == 0",
  "key_vars": ["roa", "roe", "size", "leverage"],
  "sample_fraction": 0,
  "random_seed": 12345,
  "id_var": "stkcd",
  "time_var": "year"
}
```

**场景说明**：筛选2010-2020年间、非金融业、非ST的上市公司样本，剔除ROA、ROE、Size、Leverage任一缺失的观测。

### 示例 2：事件研究窗口筛选

```json
{
  "task_id": "T03_filter_and_sample",
  "description": "政策事件窗口[-3,+3]年样本",
  "filter_condition": "event_time >= -3 & event_time <= 3",
  "key_vars": ["ret", "car"],
  "sample_fraction": 0
}
```

**场景说明**：筛选事件前后3年的观测，用于事件研究。

### 示例 3：随机抽样测试

```json
{
  "task_id": "T03_filter_and_sample",
  "description": "10%随机样本用于代码测试",
  "filter_condition": "1==1",
  "sample_fraction": 0.1,
  "random_seed": 42
}
```

**场景说明**：不做实质筛选，仅抽取10%样本用于代码调试。

## 报告写作骨架

### 论文"样本选择"章节结构

```markdown
## X.X 样本选择

### X.X.1 数据来源

本文数据来源于[数据库名称]，初始样本包括[时间范围]的全部[样本类型]数据，
共计 [N_original] 个观测值。

### X.X.2 样本筛选

按照以下标准对初始样本进行筛选：
1. 剔除金融业样本（行业代码为 J），剔除 [n1] 个观测；
2. 剔除 ST/*ST 样本，剔除 [n2] 个观测；
3. 剔除[关键变量]缺失的样本，剔除 [n3] 个观测；
4. [其他筛选条件]，剔除 [n4] 个观测。

经过上述筛选，最终得到 [N_final] 个公司-年度观测值，涉及 [n_firms] 家上市公司。
样本选择过程详见表 X。

### 表 X 样本选择过程
─────────────────────────────────────────────────────
筛选步骤                              剔除数量    剩余样本
─────────────────────────────────────────────────────
初始样本                                  -       50,000
(1) 剔除金融业                         5,000      45,000
(2) 剔除 ST 股票                       2,000      43,000
(3) 剔除关键变量缺失                   3,000      40,000
─────────────────────────────────────────────────────
最终样本                                  -       40,000
─────────────────────────────────────────────────────
```

## 常见坑与建议

### 1. 条件表达式语法错误
- **问题**：使用 `=` 而非 `==`，或使用 Python/SQL 语法
- **建议**：熟悉 Stata 条件语法，等于用 `==`，与用 `&`

### 2. 字符串比较问题
- **问题**：字符串需要引号，且区分大小写
- **建议**：`industry == "J"` 而非 `industry == J`

### 3. 缺失值处理
- **问题**：`var > 0` 会自动排除缺失值
- **建议**：明确处理缺失值，如 `var > 0 & !missing(var)`

### 4. 筛选顺序影响
- **问题**：不同筛选顺序可能导致不同的中间结果报告
- **建议**：按逻辑顺序筛选，先粗后细

### 5. 过度筛选
- **问题**：筛选条件过严导致样本量过小
- **建议**：关注日志中的警告，平衡样本质量和数量

### 6. 随机抽样不可复制
- **问题**：未设置随机种子导致每次结果不同
- **建议**：始终设置 `random_seed` 参数

### 7. 筛选条件与研究假设矛盾
- **问题**：如研究亏损公司却筛选掉 ROA < 0
- **建议**：筛选条件应与研究问题一致

### 8. 未记录筛选过程
- **问题**：无法向审稿人说明样本选择依据
- **建议**：使用本任务的筛选汇总表，完整记录每步

### 9. 数值精度问题
- **问题**：浮点数比较可能不精确
- **建议**：避免 `var == 0.1`，改用 `abs(var - 0.1) < 0.001`

### 10. 面板数据的特殊考虑
- **问题**：筛选可能破坏面板平衡性
- **建议**：筛选后检查面板结构（使用 T01 或 T30）

## 与其他任务的关系

| 相关任务 | 关系说明 |
|----------|----------|
| T01_desc_overview | 筛选前后都可用 T01 检查数据质量 |
| T04_merge_datasets | 合并数据后常需筛选 |
| T30_panel_setup | 筛选后检查面板结构 |
| T17-T24 回归任务 | 筛选后的数据用于回归分析 |

## 技术说明

- **Stata 版本**：18.0+
- **外部依赖**：无，仅使用 Stata 官方命令
- **关键命令**：`keep if`, `drop if`, `sample`, `count`, `bysort`
- **注意**：统计唯一值数量采用官方命令 `bysort var: gen tag = _n==1` + `count if tag` 替代社区命令 `distinct`
