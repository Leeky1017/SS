# T19_ols_robust_se — 稳健标准误OLS（Heteroscedasticity-Robust SE）

## 任务元信息

| 属性 | 值 |
|------|-----|
| **Task ID** | T19_ols_robust_se |
| **任务名称** | 稳健标准误OLS |
| **任务族** | D - 线性回归 |
| **难度级别** | intermediate |
| **数据结构** | cross_section |
| **金融场景适用** | ✓ 是 |

## 任务摘要

使用异方差稳健标准误（Huber-White）进行OLS回归，获得更可靠的统计推断。包含异方差检验（BP、White）、OLS与稳健SE对比、残差诊断。**金融/会计截面回归的标准做法**。

## 适用场景

### 场景 1：公司层面截面回归
- **数据特点**：不同规模公司的方差可能不同
- **应用**：绩效、资本结构等研究的基准回归

### 场景 2：异方差明确存在
- **数据特点**：BP/White检验显著
- **应用**：修正标准误以获得有效推断

### 场景 3：稳健性检验
- **数据特点**：比较OLS与稳健SE的差异
- **应用**：检验结果对异方差的敏感性

### 场景 4：审稿人要求
- **情境**：审稿人要求使用稳健标准误
- **应用**：金融期刊的标准要求

## 理论背景

### 异方差问题

**同方差假设**：$Var(\varepsilon_i|X_i) = \sigma^2$（常数）

**异方差**：$Var(\varepsilon_i|X_i) = \sigma_i^2$（因观测而异）

异方差的后果：
- OLS系数**仍然无偏**
- 但标准误**不再有效**，导致t检验和置信区间无效

### Huber-White稳健标准误

**稳健协方差矩阵**（三明治估计量）：
$$\hat{V}_{robust} = (X'X)^{-1} \left( \sum_{i=1}^{n} \hat{e}_i^2 x_i x_i' \right) (X'X)^{-1}$$

### HC估计量类型

| 类型 | 公式调整 | 特点 |
|------|----------|------|
| **HC0** | $\hat{e}_i^2$ | 基础版本 |
| **HC1** | $\frac{n}{n-k}\hat{e}_i^2$ | Stata默认，自由度调整 |
| **HC2** | $\frac{\hat{e}_i^2}{1-h_{ii}}$ | 杠杆值调整 |
| **HC3** | $\frac{\hat{e}_i^2}{(1-h_{ii})^2}$ | 小样本更保守 |

其中 $h_{ii}$ 是帽子矩阵对角元素（杠杆值）。

## 数据文件要求

### 数据文件
- **首选**：`data.dta`（Stata 格式）
- **备选**：`data.csv`（自动转换为 data.dta）
- **编码**：UTF-8（推荐）

### 变量要求
- 因变量和自变量必须为数值型
- 不允许完全缺失

## 输入与占位符说明

### 占位符列表

| 占位符 | 含义 | 类型 | 必填 | 合法取值示例 |
|--------|------|------|------|-------------|
| `__DEP_VAR__` | 因变量 | 单变量名 | ✓ 是 | `roa` |
| `__INDEP_VARS__` | 自变量列表 | 空格分隔变量 | ✓ 是 | `size lev growth` |

### 渲染规则

```python
# Python 渲染示例
config = {
    "dep_var": "roa",
    "indep_vars": ["size", "lev", "growth", "soe"]
}

placeholders = {
    "__DEP_VAR__": config["dep_var"],
    "__INDEP_VARS__": " ".join(config["indep_vars"])
}
```

## Stata 执行流程

```
┌─────────────────────────────────────────────────────────────┐
│ SECTION 0: 环境初始化与数据导入                             │
├─────────────────────────────────────────────────────────────┤
│ SECTION 1: 变量检查                                         │
├─────────────────────────────────────────────────────────────┤
│ SECTION 2: 异方差检验                                       │
│   - Breusch-Pagan 检验                                     │
│   - White 检验                                              │
├─────────────────────────────────────────────────────────────┤
│ SECTION 3: 普通 OLS 回归（对比基准）                        │
├─────────────────────────────────────────────────────────────┤
│ SECTION 4: 稳健标准误 OLS（HC1）                            │
├─────────────────────────────────────────────────────────────┤
│ SECTION 5: 标准误对比（OLS vs Robust）                      │
├─────────────────────────────────────────────────────────────┤
│ SECTION 6: 回归诊断                                         │
├─────────────────────────────────────────────────────────────┤
│ SECTION 7: 可视化                                           │
├─────────────────────────────────────────────────────────────┤
│ SECTION 8: 导出结果文件                                     │
└─────────────────────────────────────────────────────────────┘
```

## 输出文件清单与 Schema

### 0. result.log

任务执行日志，包含异方差检验、OLS与稳健SE对比、回归结果和警告信息。

### 1. table_T19_reg_robust.csv

稳健回归系数表。

| 列名 | 类型 | 说明 |
|------|------|------|
| `variable` | string | 变量名 |
| `coef` | float | 回归系数 |
| `robust_se` | float | 稳健标准误 |
| `t` | float | t统计量 |
| `p` | float | p值 |
| `sig` | string | 显著性标记 |

### 2. table_T19_se_comparison.csv

标准误对比表。

| 列名 | 类型 | 说明 |
|------|------|------|
| `variable` | string | 变量名 |
| `se_ols` | float | OLS标准误 |
| `se_robust` | float | 稳健标准误 |
| `ratio` | float | 比率（robust/ols） |
| `direction` | string | 变化方向 |

### 3. fig_T19_residuals.png

残差诊断图（检查异方差模式）。

## 上层 JSON 配置示例

### 示例 1：公司绩效模型（稳健SE）

```json
{
  "task_id": "T19_ols_robust_se",
  "description": "使用稳健标准误检验公司特征对ROA的影响",
  "dep_var": "roa",
  "indep_vars": ["size", "lev", "growth", "soe", "age"]
}
```

**场景说明**：截面数据回归，使用稳健SE修正潜在异方差。

### 示例 2：审计收费模型

```json
{
  "task_id": "T19_ols_robust_se",
  "description": "审计收费决定因素（稳健标准误）",
  "dep_var": "lnfee",
  "indep_vars": ["lnasset", "invrec", "loss", "big4"]
}
```

## 报告写作骨架

### 论文"稳健性检验"或正文回归

```markdown
## X.X 基准回归分析

表X报告了OLS回归结果，括号内为稳健标准误（Huber-White）。

[核心变量]的系数为[β]（t=[t]），在[1%/5%/10%]水平下显著[为正/为负]。
该结果表明，[控制其他因素后]，[自变量]每增加1单位/1%，
[因变量]平均变化[β]单位/[β×100]%。

Breusch-Pagan检验（χ²=[bp_chi2]，p=[bp_p]）和White检验
（χ²=[white_chi2]，p=[white_p]）表明存在异方差，
因此本文报告稳健标准误以确保统计推断的有效性。

### 表X 回归结果
─────────────────────────────────────────────────────────────
                   (1) OLS        (2) Robust SE
─────────────────────────────────────────────────────────────
X               0.035***        0.035***
               (0.008)         (0.010)
Size            0.012***        0.012***
               (0.002)         (0.003)
Lev            -0.045***       -0.045***
               (0.010)         (0.012)
Constant        0.125***        0.125***
               (0.015)         (0.018)
─────────────────────────────────────────────────────────────
N               10,000          10,000
R²              0.085           0.085
─────────────────────────────────────────────────────────────
注：列（1）为OLS标准误，列（2）为稳健标准误；
***、**、*分别表示在1%、5%、10%水平下显著。
```

## 常见坑与建议

### 1. 只报告稳健SE不报告异方差检验
- **问题**：读者不知道为何使用稳健SE
- **建议**：报告BP/White检验结果

### 2. 混淆系数与标准误
- **问题**：以为稳健SE会改变系数
- **建议**：系数不变，只有SE变化

### 3. 小样本使用HC1
- **问题**：HC1在小样本下可能低估SE
- **建议**：小样本（n<50）考虑使用HC3

### 4. 面板数据使用个体稳健SE
- **问题**：面板数据存在组内相关
- **建议**：使用聚类标准误（T20）

### 5. SE比率解读错误
- **问题**：比率>1不一定是坏事
- **建议**：比率>1表示更保守，统计推断更可靠

## HC估计量选择指南

| 情况 | 推荐 | Stata选项 |
|------|------|-----------|
| 大样本（n>500） | HC1 | `vce(robust)` |
| 中等样本（50-500） | HC2 | `vce(hc2)` |
| 小样本（n<50） | HC3 | `vce(hc3)` |
| 不确定 | HC1 | `vce(robust)` |

## 与其他任务的关系

| 相关任务 | 关系说明 |
|----------|----------|
| T18_ols_multiple | 无稳健SE的基准回归 |
| T20_ols_cluster_se | 面板数据的聚类标准误 |
| T17_ols_simple | 简单回归也可加稳健SE |

## 技术说明

- **Stata 版本**：18.0+
- **外部依赖**：无，仅使用 Stata 官方命令
- **关键命令**：`regress, vce(robust)`, `estat hettest`, `estat imtest`
- **退出码**：错误时统一返回 200
