# T14_ttest_paired — 配对样本t检验

## 任务元信息

| 属性 | 值 |
|------|-----|
| **Task ID** | T14_ttest_paired |
| **任务名称** | 配对样本t检验 |
| **任务族** | C - 假设检验 |
| **难度级别** | basic |
| **数据结构** | cross_section（宽格式配对数据） |
| **金融场景适用** | ✓ 是 |

## 任务摘要

检验配对样本（同一个体前后测量、匹配样本对）的均值是否存在显著差异。包含差异的正态性检验、置信区间、效应量（Cohen's d）计算和可视化。适用于政策前后、年度对比、匹配样本等配对设计场景。

## 适用场景

### 场景 1：政策前后效应
- **前测**：政策实施前的指标（roa_before）
- **后测**：政策实施后的指标（roa_after）
- **应用**：评估政策对同一批企业的影响

### 场景 2：年度变化分析
- **前测**：上一年度指标（invest_t0）
- **后测**：当年指标（invest_t1）
- **应用**：检验企业指标的年度变化是否显著

### 场景 3：倾向得分匹配后比较
- **变量1**：匹配样本中处理组指标
- **变量2**：匹配样本中对照组指标
- **应用**：PSM匹配后的配对比较

### 场景 4：事件前后股价变化
- **前测**：事件前股价/收益
- **后测**：事件后股价/收益
- **应用**：事件研究中的前后比较

## 理论背景

### 配对t检验原理

配对t检验本质上是对配对差异进行单样本t检验：

$$t = \frac{\bar{D}}{S_D / \sqrt{n}}$$

其中：
- $\bar{D}$：配对差异的均值
- $S_D$：配对差异的标准差
- $n$：配对数

**自由度**：df = n - 1

### 配对 vs 独立样本t检验

| 特征 | 配对t检验 | 独立样本t检验 |
|------|-----------|---------------|
| 数据结构 | 同一个体两次测量 | 两组不同个体 |
| 配对要求 | 必须一一配对 | 无需配对 |
| 检验对象 | 差异的均值 | 两组均值的差异 |
| 自由度 | n - 1 | n₁ + n₂ - 2 |
| 效力 | 通常更高（控制个体差异） | 较低 |

### 效应量（Cohen's d for paired）

$$d = \frac{\bar{D}}{S_D}$$

| |d| 范围 | 效应大小 |
|----------|----------|
| < 0.2 | 小效应 |
| 0.2-0.5 | 小到中效应 |
| 0.5-0.8 | 中效应 |
| ≥ 0.8 | 大效应 |

### 前提假设
1. **配对性**：数据必须是真正的配对（同一个体/匹配对）
2. **正态性**：配对差异近似正态分布（大样本时可放宽）
3. **独立性**：不同配对之间相互独立

## 输入与占位符说明

### 占位符列表

| 占位符 | 含义 | 类型 | 必填 | 合法取值示例 |
|--------|------|------|------|-------------|
| `__VAR_BEFORE__` | 前测/基线变量 | 单变量名 | ✓ 是 | `roa_before` |
| `__VAR_AFTER__` | 后测/干预后变量 | 单变量名 | ✓ 是 | `roa_after` |

### 数据文件
- **首选**：`data.dta`（Stata 格式）
- **备选**：`data.csv`（自动转换为 data.dta）

### 数据格式要求

数据必须为**宽格式**：
```
id    var_before    var_after
1     10.5          12.3
2     8.2           9.1
3     15.0          14.8
```

### 渲染规则

```python
# Python 渲染示例
config = {
    "var_before": "roa_before",
    "var_after": "roa_after"
}

placeholders = {
    "__VAR_BEFORE__": config["var_before"],
    "__VAR_AFTER__": config["var_after"]
}
```

## Stata 执行流程

```
┌─────────────────────────────────────────────────────────────┐
│ SECTION 0: 环境初始化与数据导入                             │
├─────────────────────────────────────────────────────────────┤
│ SECTION 1: 变量检查                                         │
├─────────────────────────────────────────────────────────────┤
│ SECTION 2: 配对数据描述统计                                 │
├─────────────────────────────────────────────────────────────┤
│ SECTION 3: 配对差异分析                                     │
│   - 差异描述统计                                            │
│   - 正态性检验                                              │
├─────────────────────────────────────────────────────────────┤
│ SECTION 4: 配对 t 检验                                      │
├─────────────────────────────────────────────────────────────┤
│ SECTION 5: 差异的置信区间                                   │
├─────────────────────────────────────────────────────────────┤
│ SECTION 6: 效应量（Cohen's d）                              │
├─────────────────────────────────────────────────────────────┤
│ SECTION 7: 检验结论汇总                                     │
├─────────────────────────────────────────────────────────────┤
│ SECTION 8: 可视化                                           │
├─────────────────────────────────────────────────────────────┤
│ SECTION 9: 导出结果文件                                     │
└─────────────────────────────────────────────────────────────┘
```

## 输出文件清单与 Schema

### 0. result.log

任务执行日志，包含配对描述统计、差异正态性检验、t检验结果和效应量输出。

### 1. table_T14_paired_ttest.csv

配对t检验结果汇总表。

| 列名 | 类型 | 说明 |
|------|------|------|
| `test_type` | string | 检验类型（paired_ttest） |
| `var_before` | string | 前测变量名 |
| `var_after` | string | 后测变量名 |
| `n_pairs` | integer | 配对数 |
| `mean_before` | float | 前测均值 |
| `mean_after` | float | 后测均值 |
| `mean_diff` | float | 平均差异（后测-前测） |
| `sd_diff` | float | 差异标准差 |
| `t_stat` | float | t统计量 |
| `df` | float | 自由度 |
| `p_value` | float | 双侧p值 |
| `ci_lower` | float | 95%置信区间下限 |
| `ci_upper` | float | 95%置信区间上限 |
| `cohens_d` | float | Cohen's d效应量 |
| `significance` | string | 显著性标记 |

### 2. 图表文件

| 文件 | 说明 |
|------|------|
| `fig_T14_boxplot.png` | 前后对比箱线图 |
| `fig_T14_diff_histogram.png` | 配对差异分布直方图 |

## 上层 JSON 配置示例

### 示例 1：政策前后ROA比较

```json
{
  "task_id": "T14_ttest_paired",
  "description": "检验政策实施前后ROA的变化",
  "var_before": "roa_before",
  "var_after": "roa_after"
}
```

**场景说明**：评估同一批企业在政策实施前后的ROA是否发生显著变化。

### 示例 2：年度指标变化

```json
{
  "task_id": "T14_ttest_paired",
  "description": "检验投资水平的年度变化",
  "var_before": "invest_2019",
  "var_after": "invest_2020"
}
```

**场景说明**：检验企业投资水平从2019年到2020年是否有显著变化。

## 报告写作骨架

### 论文"配对比较"章节结构

```markdown
## X.X 配对样本检验

为检验[事件/政策]前后[变量]的变化，本文采用配对样本t检验。
检验结果如表X所示。

[前测时点][变量]均值为[mean_before]（SD=[sd_before]），
[后测时点][变量]均值为[mean_after]（SD=[sd_after]），
平均变化为[diff]。

配对差异的Shapiro-Wilk正态性检验p=[sw_p]，差异分布[满足/不满足]正态假设。
配对t检验结果显示，t统计量为[t]（df=[df]），p值为[p]，
在[1%/5%/10%]水平下[显著/不显著]。Cohen's d效应量为[d]，属于[小/中/大]效应。

上述结果表明，[变量]在[事件/政策]前后[存在/不存在]显著变化，
平均[增加/减少]了[|diff|]，[支持/不支持]研究假设H[X]。

### 表X 配对样本t检验结果
──────────────────────────────────────────────────────────
         前测Mean(SD)    后测Mean(SD)    Diff      t      p
──────────────────────────────────────────────────────────
ROA      0.045(0.080)   0.052(0.085)   0.007    3.56  <0.001***
──────────────────────────────────────────────────────────
注：Diff=后测-前测；***、**、*分别表示在1%、5%、10%水平下显著。
```

## 常见坑与建议

### 1. 数据不是真正的配对
- **问题**：把两组独立样本当作配对
- **建议**：确认每行是同一个体/匹配对

### 2. 缺失值导致配对不完整
- **问题**：前测或后测有缺失
- **建议**：只保留完整配对，或检查缺失机制

### 3. 差异分布严重偏离正态
- **问题**：t检验假设被违反
- **建议**：使用Wilcoxon符号秩检验

### 4. 忽略变化方向
- **问题**：只关注是否显著，忽略增减方向
- **建议**：明确报告平均差异的符号和含义

### 5. 长格式数据
- **问题**：数据是长格式而非宽格式
- **建议**：先reshape为宽格式

## 非参数替代方法

### Wilcoxon符号秩检验
```stata
signrank var_after = var_before
```

### 符号检验（仅考虑正负）
```stata
signtest var_after = var_before
```

## 与其他任务的关系

| 相关任务 | 关系说明 |
|----------|----------|
| T12_ttest_one_sample | 配对t检验等价于对差异做单样本t检验 |
| T13_ttest_two_sample | 独立样本用两样本t检验 |
| T06_reshape | 长宽格式转换 |
| T30_did | DID分析是更复杂的前后比较 |

## 技术说明

- **Stata 版本**：18.0+
- **外部依赖**：无，仅使用 Stata 官方命令
- **关键命令**：`ttest`, `ci means`, `swilk`, `histogram`, `graph box`
