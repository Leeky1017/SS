export type PublicErrorCode = 'E1001' | 'E1002' | 'E1003' | 'E1004' | 'E1005' | 'E1006' | 'E1007' | 'E1008' | 'E1009' | 'E1010' | 'E1011' | 'E1012' | 'E2001' | 'E2002' | 'E2003' | 'E3001' | 'E3002' | 'E3003' | 'E3004' | 'E3005' | 'E4001' | 'E4002' | 'E4003' | 'E4004' | 'E5001' | 'E5002'

export type ErrorKind = 'http' | 'network' | 'parse' | 'unauthorized' | 'forbidden'

const PUBLIC_MESSAGES: Record<PublicErrorCode, string> = {
  E1001: '必填项未完成，请补充后继续',
  E1002: '验证信息无效，请重新验证后继续',
  E1003: '验证码无效，请检查后重试',
  E1004: '验证码已失效，请重新获取',
  E1005: '验证码暂不可用，请稍后重试',
  E1006: '选择项无效，请重新选择后继续',
  E1007: '文件过大，请更换文件后重试',
  E1008: '文件格式不支持，请更换文件后重试',
  E1009: '文件为空，请检查后重试',
  E1010: '上传未完成，请重新上传后继续',
  E1011: '文件校验失败，请重新上传后重试',
  E1012: '上传数量或次数超出限制，请稍后再试',
  E2001: '数据格式解析失败，请检查文件格式',
  E2002: '数据异常，请重新上传或稍后重试',
  E2003: '数据读取失败，请稍后重试',
  E3001: '分析预览生成失败，请稍后重试',
  E3002: '分析准备未完成，请稍后重试',
  E3003: '分析配置有误，请检查后重试',
  E3004: '分析执行失败，请稍后重试',
  E3005: '结果文件生成失败，请稍后重试',
  E4001: '分析服务暂时不可用，请稍后重试',
  E4002: '系统服务暂时不可用，请稍后重试',
  E4003: '系统配置异常，请联系支持',
  E4004: '系统异常，请稍后重试',
  E5001: '连接超时或网络不稳定，请检查网络后重试',
  E5002: '操作超时，请稍后重试',
}

const INTERNAL_TO_PUBLIC: Record<string, PublicErrorCode> = {
  ADMIN_BEARER_TOKEN_INVALID: 'E1002',
  ADMIN_BEARER_TOKEN_MISSING: 'E1002',
  ADMIN_CREDENTIALS_INVALID: 'E1002',
  ADMIN_NOT_CONFIGURED: 'E4004',
  ADMIN_STORE_IO_ERROR: 'E4002',
  ADMIN_TOKEN_INVALID: 'E1002',
  ADMIN_TOKEN_NOT_FOUND: 'E1002',
  API_TIMEOUT: 'E5001',
  ARTIFACT_NOT_FOUND: 'E2003',
  ARTIFACT_PATH_UNSAFE: 'E1006',
  AUTH_BEARER_TOKEN_INVALID: 'E1002',
  AUTH_BEARER_TOKEN_MISSING: 'E1002',
  AUTH_TOKEN_FORBIDDEN: 'E1002',
  AUTH_TOKEN_INVALID: 'E1002',
  BUNDLE_CORRUPTED: 'E2002',
  BUNDLE_FILES_LIMIT_EXCEEDED: 'E1012',
  BUNDLE_NOT_FOUND: 'E1010',
  CHECKSUM_MISMATCH: 'E1011',
  CLIENT_NETWORK_ERROR: 'E5001',
  CLIENT_PARSE_ERROR: 'E2001',
  CLIENT_RENDER_ERROR: 'E4004',
  CLIENT_TIMEOUT: 'E5002',
  COMPOSITION_PIPELINE_ERROR_WRITE_FAILED: 'E3005',
  CONTRACT_COLUMN_NOT_FOUND: 'E1006',
  DOFILE_INPUTS_MANIFEST_INVALID: 'E3003',
  DOFILE_PLAN_INVALID: 'E3003',
  DOFILE_TEMPLATE_UNSUPPORTED: 'E3003',
  DO_TEMPLATE_ARTIFACTS_WRITE_FAILED: 'E3003',
  DO_TEMPLATE_CONTRACT_INVALID: 'E3003',
  DO_TEMPLATE_INDEX_CORRUPTED: 'E2002',
  DO_TEMPLATE_INDEX_NOT_FOUND: 'E3003',
  DO_TEMPLATE_META_INVALID: 'E3003',
  DO_TEMPLATE_META_NOT_FOUND: 'E3003',
  DO_TEMPLATE_NOT_FOUND: 'E3003',
  DO_TEMPLATE_OUTPUT_ARCHIVE_FAILED: 'E3003',
  DO_TEMPLATE_PARAM_INVALID: 'E3003',
  DO_TEMPLATE_PARAM_MISSING: 'E3003',
  DO_TEMPLATE_SELECTION_INVALID_FAMILY_ID: 'E3002',
  DO_TEMPLATE_SELECTION_INVALID_TEMPLATE_ID: 'E3002',
  DO_TEMPLATE_SELECTION_NOT_WIRED: 'E3002',
  DO_TEMPLATE_SELECTION_NO_CANDIDATES: 'E3002',
  DO_TEMPLATE_SELECTION_PARSE_FAILED: 'E3002',
  DO_TEMPLATE_SOURCE_NOT_FOUND: 'E3003',
  DRAFT_CONFIRM_BLOCKED: 'E1001',
  DRAFT_PREVIEW_FAILED: 'E3001',
  FILE_NOT_FOUND: 'E1010',
  INPUTS_MANIFEST_INVALID: 'E3002',
  INPUTS_MANIFEST_MISSING: 'E3002',
  INPUTS_MANIFEST_READ_FAILED: 'E2003',
  INPUTS_MANIFEST_UNSAFE: 'E3002',
  INPUT_DATASET_KEY_CONFLICT: 'E1006',
  INPUT_EMPTY_FILE: 'E1009',
  INPUT_EXCEL_SHEET_NOT_FOUND: 'E1006',
  INPUT_EXCEL_SHEET_SELECTION_UNSUPPORTED: 'E1006',
  INPUT_FILENAME_COUNT_MISMATCH: 'E1006',
  INPUT_FILENAME_UNSAFE: 'E1006',
  INPUT_MAIN_DATA_SOURCE_NOT_FOUND: 'E1006',
  INPUT_PARSE_FAILED: 'E2001',
  INPUT_PATH_UNSAFE: 'E1006',
  INPUT_PRIMARY_DATASET_MISSING: 'E1006',
  INPUT_PRIMARY_DATASET_MULTIPLE: 'E1006',
  INPUT_ROLE_COUNT_MISMATCH: 'E1006',
  INPUT_ROLE_INVALID: 'E1006',
  INPUT_STORAGE_FAILED: 'E4002',
  INPUT_UNSUPPORTED_FORMAT: 'E1008',
  INPUT_VALIDATION_FAILED: 'E1006',
  JOB_ALREADY_EXISTS: 'E4004',
  JOB_DATA_CORRUPTED: 'E2002',
  JOB_ID_UNSAFE: 'E1006',
  JOB_ILLEGAL_TRANSITION: 'E4004',
  JOB_NOT_FOUND: 'E1002',
  JOB_STORE_BACKEND_UNSUPPORTED: 'E4003',
  JOB_STORE_IO_ERROR: 'E4002',
  JOB_VERSION_CONFLICT: 'E4004',
  JSON_PARSE_ERROR: 'E2001',
  LLM_ARTIFACTS_WRITE_FAILED: 'E4002',
  LLM_CALL_FAILED: 'E4001',
  LLM_CONFIG_INVALID: 'E4003',
  MISSING_REQUIRED_FIELD: 'E1001',
  OBJECT_STORE_CONFIG_INVALID: 'E4003',
  OBJECT_STORE_OPERATION_FAILED: 'E4002',
  OUTPUT_FORMATS_INVALID: 'E3005',
  OUTPUT_FORMATTER_FAILED: 'E3005',
  PLAN_ALREADY_FROZEN_CONFLICT: 'E3002',
  PLAN_ARTIFACTS_WRITE_FAILED: 'E3002',
  PLAN_COMPOSITION_INVALID: 'E3002',
  PLAN_FREEZE_MISSING_REQUIRED: 'E1001',
  PLAN_FREEZE_NOT_ALLOWED: 'E3002',
  PLAN_GEN_CALL_CONTEXT_INVALID: 'E3001',
  PLAN_GEN_EMPTY_STEPS: 'E3001',
  PLAN_GEN_JSON_INVALID: 'E3001',
  PLAN_GEN_MAX_STEPS_EXCEEDED: 'E3001',
  PLAN_GEN_SCHEMA_INVALID: 'E3001',
  PLAN_GEN_STEP_ID_INVALID: 'E3001',
  PLAN_GEN_STEP_ID_UNSAFE: 'E3001',
  PLAN_GEN_STEP_TYPE_INVALID: 'E3001',
  PLAN_GEN_TEMPLATE_ID_INVALID: 'E3001',
  PLAN_GEN_TEMPLATE_ID_UNSUPPORTED: 'E3001',
  PLAN_GEN_UNSUPPORTED_STEP_TYPE: 'E3001',
  PLAN_MISSING: 'E3002',
  PLAN_TEMPLATE_META_INVALID: 'E3002',
  PLAN_TEMPLATE_META_NOT_FOUND: 'E3002',
  QUEUE_DATA_CORRUPTED: 'E2002',
  QUEUE_IO_ERROR: 'E4002',
  RESOURCE_OOM: 'E4002',
  SERVICE_SHUTTING_DOWN: 'E4002',
  SMOKE_SUITE_FIXTURE_COPY_FAILED: 'E4004',
  SMOKE_SUITE_FIXTURE_NOT_FOUND: 'E4004',
  SMOKE_SUITE_MANIFEST_INVALID: 'E4004',
  SMOKE_SUITE_MANIFEST_INVALID_JSON: 'E4004',
  SMOKE_SUITE_MANIFEST_NOT_FOUND: 'E4004',
  SMOKE_SUITE_MANIFEST_READ_FAILED: 'E4004',
  STATA_ARTIFACTS_WRITE_FAILED: 'E3004',
  STATA_CMD_INVALID: 'E4003',
  STATA_CMD_NOT_CONFIGURED: 'E4003',
  STATA_CMD_NOT_FOUND: 'E4003',
  STATA_DEPENDENCY_MISSING: 'E4003',
  STATA_DEPENDENCY_PREFLIGHT_FAILED: 'E4003',
  STATA_DEPENDENCY_PREFLIGHT_READ_FAILED: 'E4003',
  STATA_DEPENDENCY_PREFLIGHT_SUBPROCESS_FAILED: 'E4003',
  STATA_DEPENDENCY_PREFLIGHT_TIMEOUT: 'E5002',
  STATA_DEPENDENCY_PREFLIGHT_WRITE_FAILED: 'E4003',
  STATA_DOFILE_UNSAFE: 'E3004',
  STATA_DOFILE_WRITE_FAILED: 'E3004',
  STATA_INPUTS_COPY_FAILED: 'E3004',
  STATA_INPUTS_UNSAFE: 'E3004',
  STATA_NONZERO_EXIT: 'E3004',
  STATA_WORKSPACE_INVALID: 'E3004',
  TASK_CODE_DATA_CORRUPTED: 'E4002',
  TASK_CODE_EXPIRED: 'E1004',
  TASK_CODE_INVALID: 'E1003',
  TASK_CODE_NOT_FOUND: 'E1003',
  TASK_CODE_REDEEM_CONFLICT: 'E1005',
  TASK_CODE_REVOKED: 'E1004',
  TASK_CODE_STORE_IO_ERROR: 'E4002',
  TENANT_ID_UNSAFE: 'E1006',
  UPLOAD_FILE_SIZE_LIMIT_EXCEEDED: 'E1007',
  UPLOAD_INCOMPLETE: 'E1010',
  UPLOAD_MULTIPART_LIMIT_EXCEEDED: 'E1012',
  UPLOAD_PARTS_INVALID: 'E1011',
  UPLOAD_SESSIONS_LIMIT_EXCEEDED: 'E1012',
  UPLOAD_SESSION_CORRUPTED: 'E2002',
  UPLOAD_SESSION_EXPIRED: 'E1010',
  UPLOAD_SESSION_NOT_FOUND: 'E1010',
  WORKER_ARTIFACTS_WRITE_FAILED: 'E3005',
  WSL_INTEROP_UNAVAILABLE: 'E4003',
}

export function toPublicErrorCode(args: {
  internalCode: string | null
  kind: ErrorKind
  status: number | null
}): PublicErrorCode {
  const { internalCode, kind, status } = args
  if (internalCode !== null && internalCode.trim() !== '') {
    const mapped = INTERNAL_TO_PUBLIC[internalCode]
    if (mapped !== undefined) return mapped
  }
  if (kind === 'network') return 'E5001'
  if (kind === 'parse') return 'E2001'
  if (kind === 'unauthorized' || kind === 'forbidden') return 'E1002'
  if (status === 400) return 'E1006'
  return 'E4004'
}

export function toUserErrorMessage(args: {
  internalCode: string | null
  kind: ErrorKind
  status: number | null
}): string {
  const publicCode = toPublicErrorCode(args)
  const message = PUBLIC_MESSAGES[publicCode]
  return `错误代号 ${publicCode}：${message}`
}

export function formatUserErrorMessage(publicCode: PublicErrorCode, description: string): string {
  const trimmed = description.trim()
  const message = trimmed !== '' ? trimmed : PUBLIC_MESSAGES[publicCode]
  return `错误代号 ${publicCode}：${message}`
}
